<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>区域半径协议ZRP - Cyo&#39;s Website</title><meta name="Description" content="Cyo&#39;s website"><meta property="og:title" content="区域半径协议ZRP" />
<meta property="og:description" content="ZRP(区域半径协议)详解 1.默认配置参数Constants.h #ifndef _constants_h_ #define _constants_h_ // General OR Common Constants //DEBUG 参数 #define DEBUG 0 // 1 = Enabled; 0 = Disabled //Router_PORT #define ROUTER_PORT 0xff #define TRUE 1 #define FALSE 0 #define LINKUP 1 #define LINKDOWN 0" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://example.org/%E5%8C%BA%E5%9F%9F%E5%8D%8A%E5%BE%84%E5%8D%8F%E8%AE%AEzrp/" /><meta property="og:image" content="http://example.org/logo.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-12-02T18:15:10+09:00" />
<meta property="article:modified_time" content="2022-12-02T18:15:10+09:00" /><meta property="og:site_name" content="Cyo&#39;s website" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="http://example.org/logo.png"/>

<meta name="twitter:title" content="区域半径协议ZRP"/>
<meta name="twitter:description" content="ZRP(区域半径协议)详解 1.默认配置参数Constants.h #ifndef _constants_h_ #define _constants_h_ // General OR Common Constants //DEBUG 参数 #define DEBUG 0 // 1 = Enabled; 0 = Disabled //Router_PORT #define ROUTER_PORT 0xff #define TRUE 1 #define FALSE 0 #define LINKUP 1 #define LINKDOWN 0"/>
<meta name="twitter:site" content="@https://twitter.com/ZXLKG"/>
<meta name="application-name" content="Cyo&#39;s website">
<meta name="apple-mobile-web-app-title" content="Cyo&#39;s website"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="http://example.org/%E5%8C%BA%E5%9F%9F%E5%8D%8A%E5%BE%84%E5%8D%8F%E8%AE%AEzrp/" /><link rel="prev" href="http://example.org/%E5%B7%AE%E5%88%86%E6%95%B0%E7%BB%84/" /><link rel="next" href="http://example.org/gcc/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "区域半径协议ZRP",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http:\/\/example.org\/%E5%8C%BA%E5%9F%9F%E5%8D%8A%E5%BE%84%E5%8D%8F%E8%AE%AEzrp\/"
        },"genre": "posts","keywords": "ZRP","wordcount":  24294 ,
        "url": "http:\/\/example.org\/%E5%8C%BA%E5%9F%9F%E5%8D%8A%E5%BE%84%E5%8D%8F%E8%AE%AEzrp\/","datePublished": "2022-12-02T18:15:10+09:00","dateModified": "2022-12-02T18:15:10+09:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "Cyo"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('dark' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'dark' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Cyo&#39;s Website"><img
        class="lazyload logo"
        src="/svg/loading.min.svg"
        data-src="/headeravatar.jpeg"
        data-srcset="/headeravatar.jpeg, /headeravatar.jpeg 1.5x, /headeravatar.jpeg 2x"
        data-sizes="auto"
        alt="/headeravatar.jpeg"
        title="/headeravatar.jpeg" /><span id="id-1" class="typeit"></span></a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 文章 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/categories/"> 分类 </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="请输入想要查找的标题" id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Cyo&#39;s Website"><img
        class="lazyload logo"
        src="/svg/loading.min.svg"
        data-src="/headeravatar.jpeg"
        data-srcset="/headeravatar.jpeg, /headeravatar.jpeg 1.5x, /headeravatar.jpeg 2x"
        data-sizes="auto"
        alt="/headeravatar.jpeg"
        title="/headeravatar.jpeg" /><span id="id-2" class="typeit"></span></a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="请输入想要查找的标题" id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        Cancel
                    </a>
                </div><a class="menu-item" href="/posts/" title="">文章</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/categories/" title="">分类</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><div class="search-dropdown desktop">
        <div id="search-dropdown-desktop"></div>
    </div>
    <div class="search-dropdown mobile">
        <div id="search-dropdown-mobile"></div>
    </div><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">区域半径协议ZRP</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="https://github.com/zxlkgf" title="Author" target="_blank" rel="noopener noreffer author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>Cyo</a></span>&nbsp;<span class="post-category">included in <a href="/categories/%E5%8C%BA%E5%9F%9F%E5%8D%8A%E5%BE%84%E5%8D%8F%E8%AE%AE/"><i class="far fa-folder fa-fw" aria-hidden="true"></i>区域半径协议</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2022-12-02">2022-12-02</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;24294 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;49 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="true">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#1默认配置参数constantsh">1.默认配置参数Constants.h</a></li>
    <li><a href="#2ndp邻居发现协议">2.NDP(邻居发现协议)</a>
      <ul>
        <li><a href="#21-ndpagent的类">2.1 NDPAgent的类</a></li>
        <li><a href="#211-ndpagent类内成员neighborlist类邻居节点表类">2.1.1 NDPAgent类内成员NeighborList类(邻居节点表类)</a></li>
        <li><a href="#212-ndpagent类内成员ndpbeacontransmittimer类">2.1.2 NDPAgent类内成员NDPBeaconTransmitTimer类</a></li>
        <li><a href="#213-ndpagent类内成员ndpacktimer类">2.1.3 NDPAgent类内成员NDPAckTimer类</a></li>
        <li><a href="#214-ndpagnet类内方法startup">2.1.4 NDPAgnet类内方法startUp()</a></li>
        <li><a href="#215-ndpagnet类内方法recv_ndp_beaconpacket-p">2.1.5 NDPAgnet类内方法recv_NDP_BEACON(Packet* p)</a></li>
        <li><a href="#216-ndpagnet类内方法recv_ndp_beacon_ackpacket-p">2.1.6 NDPAgnet类内方法recv_NDP_BEACON_ACK(Packet* p)</a></li>
      </ul>
    </li>
    <li><a href="#3-iarp主动协议">3. IARP(主动协议)</a>
      <ul>
        <li><a href="#31-iarpagent">3.1 IARPAgent</a></li>
      </ul>
    </li>
    <li><a href="#4ierp-被动协议">4.IERP (被动协议)</a>
      <ul>
        <li><a href="#41-ierpagent类">4.1 IERPAgent类</a></li>
      </ul>
    </li>
    <li><a href="#5zrpzone-routing-protocol">5.ZRP(ZONE ROUTING PROTOCOL)</a>
      <ul>
        <li><a href="#51-zrp的包头类">5.1 ZRP的包头类</a></li>
        <li><a href="#52-zrp的packetutil类">5.2 ZRP的PacketUtil类</a></li>
        <li><a href="#53-zrp的sendbuffer类">5.3 ZRP的sendBuffer类</a></li>
        <li><a href="#54-zrpagent类">5.4 ZRPAgent类</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h1 id="zrp区域半径协议详解">ZRP(区域半径协议)详解</h1>
<hr>
<h2 id="1默认配置参数constantsh">1.默认配置参数Constants.h</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cp">#ifndef _constants_h_
</span></span></span><span class="line"><span class="cl"><span class="cp">#define _constants_h_
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// General OR Common Constants
</span></span></span><span class="line"><span class="cl"><span class="c1">//DEBUG 参数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define DEBUG                0    </span><span class="c1">// 1 = Enabled; 0 = Disabled
</span></span></span><span class="line"><span class="cl"><span class="c1">//Router_PORT
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define ROUTER_PORT          0xff
</span></span></span><span class="line"><span class="cl"><span class="cp">#define TRUE                 1
</span></span></span><span class="line"><span class="cl"><span class="cp">#define FALSE                 0
</span></span></span><span class="line"><span class="cl"><span class="cp">#define LINKUP                 1
</span></span></span><span class="line"><span class="cl"><span class="cp">#define LINKDOWN             0
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DEFAULT_STARTUP_JITTER         1    </span><span class="c1">// 1sec
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define DEFAULT_EXPIRATION_CHECK_PERIOD 1   </span><span class="c1">// 1sec... 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define MAX_SEQUENCE_ID         1000000 </span><span class="c1">// For Packet Utils
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define MIN_PACKET_DROP_TIME        3    </span><span class="c1">// 3 sec For 1-hop communication    [Not Used]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define MAX_PACKET_DROP_TIME        10    </span><span class="c1">// 10 sec For multi-hop communication    [Not Used]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define IERP_TTL            50    </span><span class="c1">// Maximum-length for IERP route
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// NDP related Constants
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define DEFAULT_BEACON_PERIOD         3     </span><span class="c1">// 3 sec
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define DEFAULT_BEACON_PERIOD_JITTER    1     </span><span class="c1">// 1 sec
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define DEFAULT_NEIGHBOR_ACK_TIMEOUT      2     </span><span class="c1">// 2 sec  [Within this much time ACK should come to me]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define DEFAULT_MAX_ACK_TIMEOUT        2    </span><span class="c1">// How many ACK Timeout is needed to declare a Neighbor DOWN
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// IARP related Constants
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define DEFAULT_MIN_IARP_UPDATE_PERIOD     3     </span><span class="c1">// 3 sec  [T_lsu]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define DEFAULT_MAX_IARP_UPDATE_PERIOD     10     </span><span class="c1">// 10 sec [T_lsu]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define DEFAULT_LINK_LIFETIME         10    </span><span class="c1">// 10sec    
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define DEFAULT_UPDATE_LIFETIME     30    </span><span class="c1">// 30sec  [For Control Flooding]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// IERP related Constants
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define DEFAULT_BRP_XMIT_POLICY        0    </span><span class="c1">// 1: BRP_MULTICAST, 0: BRP_UNICAST
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define IERP_REPLY_SNOOP        1    </span><span class="c1">// 1: Enabled, 0: Disabled
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define IERP_ERROR_SNOOP        1    </span><span class="c1">// 1: Enabled, 0: Disabled
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define IERP_XMIT_JITTER        1    </span><span class="c1">// 1sec [Uniformly distributed]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define DEFAULT_QUERY_LIFETIME         30     </span><span class="c1">// 30sec  [For Control Flooding]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define DEFAULT_QUERY_RETRY_TIME    5    </span><span class="c1">// 5sec
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define DEFAULT_ROUTE_LIFETIME         120    </span><span class="c1">// 120sec  [IERP Route Reliability]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define DEFAULT_MAX_IERP_REPLY        3    </span><span class="c1">// Destination can send maximum 5 replies...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// ZRP related Constants
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define ZRP_DEFAULT_HDR_LEN        10    </span><span class="c1">// 10 bytes [refer to hdr_zrp struct]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define DEFAULT_ZONE_RADIUS         2
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DEFAULT_SEND_BUFFER_SIZE    100    </span><span class="c1">// 100 Packets
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define DEFAULT_PACKET_LIFETIME        20    </span><span class="c1">// 10 sec
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define    DEFAULT_INTERPKT_JITTER        1    </span><span class="c1">// 1sec [Uniformly distributed]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// Type-Defintions &amp; Enumeration...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">typedef</span> <span class="kt">double</span> <span class="n">Time</span><span class="p">;</span>   
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="kt">int32_t</span> <span class="n">Query_ID</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Types of ZRP packets...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">enum</span> <span class="nc">ZRPTYPE</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">NDP_BEACON</span><span class="p">,</span> <span class="n">NDP_BEACON_ACK</span><span class="p">,</span> <span class="n">IARP_UPDATE</span><span class="p">,</span> <span class="n">IARP_DATA</span><span class="p">,</span> <span class="n">IERP_REPLY</span><span class="p">,</span> <span class="n">IERP_REQUEST</span><span class="p">,</span> <span class="n">IERP_ROUTE_ERROR</span><span class="p">,</span> <span class="n">IERP_DATA</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// BRP Xmit Policy...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">enum</span> <span class="nc">BRP_XMIT_POLICY</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">BRP_UNICAST</span><span class="p">,</span> <span class="n">BRP_MULTICAST</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span></code></pre></div><hr>
<h2 id="2ndp邻居发现协议">2.NDP(邻居发现协议)</h2>
<hr>
<h3 id="21-ndpagent的类">2.1 NDPAgent的类</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* [SUB-SECTION-2.4]------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="cm"> * NDP AGENT:- NEIGHBOR DISCOVERY AGENT
</span></span></span><span class="line"><span class="cl"><span class="cm"> * NDP AGENT:- 邻居发现代理类
</span></span></span><span class="line"><span class="cl"><span class="cm"> * -----------------------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*!    \class NDPAgent
</span></span></span><span class="line"><span class="cl"><span class="cm">    \brief This class implements the Neighbor Discovery Protocol (NDP).
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">NDPAgent</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Data...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ZRPAgent</span> <span class="o">*</span><span class="n">agent_</span><span class="p">;</span>        <span class="c1">// 指向ZRPAgent的指针
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">NeighborList</span> <span class="n">neighborLst_</span><span class="p">;</span>    <span class="c1">// 存储邻居信息的邻居链表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">NDPBeaconTransmitTimer</span> <span class="n">BeaconTransmitTimer_</span><span class="p">;</span>    <span class="c1">// 发送邻居探索包的类
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">NDPAckTimer</span> <span class="n">AckTimer_</span><span class="p">;</span>                <span class="c1">// 发送包等待邻居接受并返回ACK的类，如果邻居超过时间没有返回ACK则处理邻居
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">startup_jitter_</span><span class="p">;</span>        <span class="c1">// 启动的时间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 构造方法...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="cm">/*!    \fn NDPAgent(ZRPAgent *)
</span></span></span><span class="line"><span class="cl"><span class="cm">        This constructor is called by the constructor of ZRP. It initializes 
</span></span></span><span class="line"><span class="cl"><span class="cm">        different compenents in NDP.
</span></span></span><span class="line"><span class="cl"><span class="cm">        这个构造方法在ZRP的构造方法中被调用。
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">NDPAgent</span><span class="p">(</span><span class="n">ZRPAgent</span> <span class="o">*</span><span class="n">agent</span><span class="p">)</span> <span class="o">:</span> <span class="n">agent_</span><span class="p">(</span><span class="n">agent</span><span class="p">),</span> <span class="n">BeaconTransmitTimer_</span><span class="p">(</span><span class="n">agent</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="n">AckTimer_</span><span class="p">(</span><span class="n">agent</span><span class="p">),</span> <span class="n">startup_jitter_</span><span class="p">(</span><span class="n">DEFAULT_STARTUP_JITTER</span><span class="p">)</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Methods...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="cm">/*!    \fn void startUp()
</span></span></span><span class="line"><span class="cl"><span class="cm">        This is called by ZRPAgent::startUp() method. It does following tasks: \n
</span></span></span><span class="line"><span class="cl"><span class="cm">        - Starts the Beacon-Transmit-Timer. \n
</span></span></span><span class="line"><span class="cl"><span class="cm">        - Clears the Neighbor-List.
</span></span></span><span class="line"><span class="cl"><span class="cm">        这个方法在ZRPAgent类的StartUp方法中被调用
</span></span></span><span class="line"><span class="cl"><span class="cm">        并执行开启Beacon-Transmit-Timer
</span></span></span><span class="line"><span class="cl"><span class="cm">        以及清空邻居节点链路表
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">startUp</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/*!    \fn void recv_NDP_BEACON(Packet* p)
</span></span></span><span class="line"><span class="cl"><span class="cm">        This function is called whenever ZRP receives an NDP_BEACON packet. On receving 
</span></span></span><span class="line"><span class="cl"><span class="cm">        &#39;NDP_BEACON&#39;, node sends &#39;NDP_BEACON_ACK&#39; to the sender. But it does not add this 
</span></span></span><span class="line"><span class="cl"><span class="cm">        neighbor, because node stores only symmetric links.
</span></span></span><span class="line"><span class="cl"><span class="cm">        每当当前节点的ZRP代理人接收到NDP_BEACON packet，就会想发送这个NDP_BEACON packet的节点
</span></span></span><span class="line"><span class="cl"><span class="cm">        发送NDP_ACK packet
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">recv_NDP_BEACON</span><span class="p">(</span><span class="n">Packet</span><span class="o">*</span> <span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/*!    \fn void recv_NDP_BEACON_ACK(Packet* p)
</span></span></span><span class="line"><span class="cl"><span class="cm">        This function is called whenever ZRP receives an NDP_BEACON_ACK packet. \n
</span></span></span><span class="line"><span class="cl"><span class="cm">        - If it&#39;s a new neighbor, node adds the neighbor to its &#39;NEIGHBOR_TABLE&#39; and 
</span></span></span><span class="line"><span class="cl"><span class="cm">        notifies IARP to rebuild the &#39;INNER_ROUTING_TABLE&#39; and &#39;PERIPHERAL_NODE_TABLE&#39;. \n
</span></span></span><span class="line"><span class="cl"><span class="cm">        - If it&#39;s an existing neighbor, it updates &#39;LAST_ACK_TIME&#39; for that neighbor.
</span></span></span><span class="line"><span class="cl"><span class="cm">        每当当前节点的ZRP代理类接收到NDP_BEACON_ACK packet的时候，就会判断当前发送这个包的节点
</span></span></span><span class="line"><span class="cl"><span class="cm">        是不是新邻居节点，如果是新邻居节点，就将它加入到NEIGHBOR_TABLE邻居表中，并通知IARPAgent
</span></span></span><span class="line"><span class="cl"><span class="cm">        代理人去重构它的INNER_ROUTING_TABLE和PERIPHERAL_NODE_TABLE。
</span></span></span><span class="line"><span class="cl"><span class="cm">        如果是已经存在的邻居节点，则更新他的LAST_ACK_TIME
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">recv_NDP_BEACON_ACK</span><span class="p">(</span><span class="n">Packet</span><span class="o">*</span> <span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/*!    \fn void print_tables()
</span></span></span><span class="line"><span class="cl"><span class="cm">        This function prints the Neighbor-List. It also prints which Neighbors are UP 
</span></span></span><span class="line"><span class="cl"><span class="cm">        and which are DOWN.
</span></span></span><span class="line"><span class="cl"><span class="cm">        这个方法打印邻居节点的链表，并且哪个邻居节点处于linked-up，哪个节点处于linked-down
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">print_tables</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><hr>
<h3 id="211-ndpagent类内成员neighborlist类邻居节点表类">2.1.1 NDPAgent类内成员NeighborList类(邻居节点表类)</h3>
<p>该表维护一个NeighborList(邻居节点表)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/*!    \class NeighborList
</span></span></span><span class="line"><span class="cl"><span class="cm">    \brief This class is the linked-list of Neighbor class.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">NeighborList</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">Neighbor</span> <span class="o">*</span><span class="n">head_</span><span class="p">;</span>    <span class="c1">// 指向链表头部的指针
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">numNeighbors_</span><span class="p">;</span>    <span class="c1">// 链表内成员数量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 构造方法...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">NeighborList</span><span class="p">()</span> <span class="o">:</span> <span class="n">head_</span><span class="p">(</span><span class="nb">NULL</span><span class="p">),</span> <span class="n">numNeighbors_</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 方法...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 将邻居节点加入
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">void</span> <span class="nf">addNeighbor</span><span class="p">(</span><span class="n">nsaddr_t</span> <span class="n">addr</span><span class="p">,</span> <span class="n">Time</span> <span class="n">lastack</span><span class="p">,</span> <span class="kt">int</span> <span class="n">linkStatus</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 查找
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="nf">findNeighbor</span><span class="p">(</span><span class="n">nsaddr_t</span> <span class="n">addr</span><span class="p">,</span> <span class="n">Neighbor</span> <span class="o">**</span><span class="n">handle</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 判空
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="nf">isEmpty</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 移除
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">void</span> <span class="nf">removeNeighbor</span><span class="p">(</span><span class="n">Neighbor</span> <span class="o">*</span><span class="n">prev</span><span class="p">,</span> <span class="n">Neighbor</span> <span class="o">*</span><span class="n">toBeDeleted</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 移除所有链路状况为down的邻居节点
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">void</span> <span class="nf">purgeDownNeighbors</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 清空链表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">void</span> <span class="nf">freeList</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 打印链表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">void</span> <span class="nf">printNeighbors</span><span class="p">();</span>    
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><hr>
<h4 id="2111-neighborlist类内的成员类neighbor类">2.1.1.1 NeighborList类内的成员类Neighbor类</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">* 该类存储邻居节点的详细信息
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Neighbor</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">public</span><span class="o">:</span>        
</span></span><span class="line"><span class="cl">    <span class="n">nsaddr_t</span> <span class="n">addr_</span><span class="p">;</span>        <span class="c1">// 32 位的地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">Time</span> <span class="n">lastack_</span><span class="p">;</span>        <span class="c1">// 上一次接收到ACK的时间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">linkStatus_</span><span class="p">;</span>    <span class="c1">// 链路状况
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">AckTOCount_</span><span class="p">;</span>    <span class="c1">// 超时的次数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Neighbor</span> <span class="o">*</span><span class="n">next_</span><span class="p">;</span>    <span class="c1">// next指针
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 构造方法...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Neighbor</span><span class="p">()</span> <span class="o">:</span> <span class="n">addr_</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">lastack_</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">linkStatus_</span><span class="p">(</span><span class="n">LINKDOWN</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="n">next_</span><span class="p">(</span><span class="nb">NULL</span><span class="p">)</span> <span class="p">{}</span>    <span class="c1">// Initialize with Invalid Entries
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Neighbor</span><span class="p">(</span><span class="n">nsaddr_t</span> <span class="n">addr</span><span class="p">,</span> <span class="n">Time</span> <span class="n">lastack</span><span class="p">,</span> <span class="kt">int</span> <span class="n">linkStatus</span><span class="p">)</span> <span class="o">:</span> <span class="n">addr_</span><span class="p">(</span><span class="n">addr</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="n">lastack_</span><span class="p">(</span><span class="n">lastack</span><span class="p">),</span> <span class="n">linkStatus_</span><span class="p">(</span><span class="n">linkStatus</span><span class="p">),</span> <span class="n">AckTOCount_</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="n">next_</span><span class="p">(</span><span class="nb">NULL</span><span class="p">)</span> <span class="p">{}</span> 
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><hr>
<h4 id="2112-neighborlist类的addneighbor的实现">2.1.1.2 NeighborList类的addNeighbor()的实现</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* 
</span></span></span><span class="line"><span class="cl"><span class="cm">* 将单个邻居节点加入邻居链表中
</span></span></span><span class="line"><span class="cl"><span class="cm">* nsaddr_t addr:  32 位地址
</span></span></span><span class="line"><span class="cl"><span class="cm">* Time lastack:   接收ACK的时间
</span></span></span><span class="line"><span class="cl"><span class="cm">* int linkStatus: 链路状态
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span>
</span></span><span class="line"><span class="cl"><span class="n">NeighborList</span><span class="o">::</span><span class="n">addNeighbor</span><span class="p">(</span><span class="n">nsaddr_t</span> <span class="n">addr</span><span class="p">,</span> <span class="n">Time</span> <span class="n">lastack</span><span class="p">,</span> <span class="kt">int</span> <span class="n">linkStatus</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//创建新的邻居节点
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Neighbor</span> <span class="o">*</span><span class="n">newNb</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Neighbor</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">lastack</span><span class="p">,</span> <span class="n">linkStatus</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">newNb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>    <span class="c1">// 检查创建情况
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;### Memory Allocation Error in [NeighborList::addNeighbor] ###&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">newNb</span><span class="o">-&gt;</span><span class="n">next_</span> <span class="o">=</span> <span class="n">head_</span><span class="p">;</span>    <span class="c1">// 头插法插入    
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">head_</span> <span class="o">=</span> <span class="n">newNb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">numNeighbors_</span><span class="o">++</span><span class="p">;</span>    <span class="c1">// ++链表内节点数量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><hr>
<h4 id="2113-neighborlist类的findneighbor的实现">2.1.1.3 NeighborList类的findNeighbor()的实现</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* 
</span></span></span><span class="line"><span class="cl"><span class="cm">* 查找邻居链表内的是否存在当前邻居节点
</span></span></span><span class="line"><span class="cl"><span class="cm">* 如果有 返回true 并且将其赋值给handle    
</span></span></span><span class="line"><span class="cl"><span class="cm">* 如果没有 返回false
</span></span></span><span class="line"><span class="cl"><span class="cm">* nsaddr_t addr : 32位地址
</span></span></span><span class="line"><span class="cl"><span class="cm">* Neighbor **handle : handle指针
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span>
</span></span><span class="line"><span class="cl"><span class="n">NeighborList</span><span class="o">::</span><span class="n">findNeighbor</span><span class="p">(</span><span class="n">nsaddr_t</span> <span class="n">addr</span><span class="p">,</span> <span class="n">Neighbor</span> <span class="o">**</span><span class="n">handle</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 定义指向NeighborList的head的临时指针
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Neighbor</span> <span class="o">*</span><span class="n">cur</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 查找的返回值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">foundFlag</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">    <span class="c1">// 小心空链表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// [i&lt;numNeighbors_] condition takes care for EMPTY List case...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">cur</span><span class="o">=</span><span class="n">head_</span><span class="p">;</span><span class="c1">//头节点赋值给临时变量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">foundFlag</span><span class="o">=</span><span class="n">FALSE</span><span class="p">;</span><span class="c1">//先赋值为false
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//遍历循环查找节点
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">numNeighbors_</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">addr</span> <span class="o">==</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">addr_</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">foundFlag</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">cur</span><span class="o">=</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">next_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">foundFlag</span><span class="p">)</span> <span class="p">{</span>        <span class="c1">// 如果邻居节点存在
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">*</span><span class="n">handle</span> <span class="o">=</span> <span class="n">cur</span><span class="p">;</span>    <span class="c1">// 将该邻居节点的地址赋值给handle
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>    <span class="c1">// 返回true        
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>        <span class="c1">// 邻居未找到 返回false
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><hr>
<h4 id="2114-neighborlist类的isempty实现">2.1.1.4 NeighborList类的isEmpty()实现</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* 
</span></span></span><span class="line"><span class="cl"><span class="cm">* 如果为空返回true
</span></span></span><span class="line"><span class="cl"><span class="cm">* 如果为空返回false
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span>
</span></span><span class="line"><span class="cl"><span class="n">NeighborList</span><span class="o">::</span><span class="n">isEmpty</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">numNeighbors_</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr>
<h4 id="2115-neighborlist类的removeneighbor的实现">2.1.1.5 NeighborList类的removeNeighbor()的实现</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* Remove a Neighbor specified by the pointer in argument. 
</span></span></span><span class="line"><span class="cl"><span class="cm">* 移除参数中指定的邻居节点
</span></span></span><span class="line"><span class="cl"><span class="cm">* Neighbor *prev: 被删除节点的前置节点
</span></span></span><span class="line"><span class="cl"><span class="cm">* Neighbor *toBeDeleted: 被删除节点
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> 
</span></span><span class="line"><span class="cl"><span class="n">NeighborList</span><span class="o">::</span><span class="n">removeNeighbor</span><span class="p">(</span><span class="n">Neighbor</span> <span class="o">*</span><span class="n">prev</span><span class="p">,</span> <span class="n">Neighbor</span> <span class="o">*</span><span class="n">toBeDeleted</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// [Case-1]: This is a head that needs to be deleted
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 如果前置节点为空，并且被删除的节点不是头节点，则报错退出
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span><span class="n">prev</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="p">)</span> <span class="p">{</span>    
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">toBeDeleted</span> <span class="o">!=</span> <span class="n">head_</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">printf</span><span class="p">(</span><span class="s">&#34;### Logical Error in [NeighborList::removeNeighbor] ###&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//否则，删除节点就是头节点
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">head_</span> <span class="o">=</span> <span class="n">head_</span><span class="o">-&gt;</span><span class="n">next_</span><span class="p">;</span> <span class="c1">// 让head指针 指向head的next指针
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">delete</span> <span class="n">toBeDeleted</span><span class="p">;</span>  <span class="c1">// 删除节点空间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">numNeighbors_</span><span class="o">--</span><span class="p">;</span>    <span class="c1">//邻居表内成员--
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// [Case-2]: 通常的case
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">prev</span><span class="o">-&gt;</span><span class="n">next_</span> <span class="o">=</span> <span class="n">toBeDeleted</span><span class="o">-&gt;</span><span class="n">next_</span><span class="p">;</span> <span class="c1">// 前节点的next指向删除节点的next
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">delete</span> <span class="n">toBeDeleted</span><span class="p">;</span>    <span class="c1">//删除想要删除的节点
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">numNeighbors_</span><span class="o">--</span><span class="p">;</span>    <span class="c1">//邻居表内成员--
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><hr>
<h4 id="2116-neighborlist类的purgedownneighbors的实现">2.1.1.6 NeighborList类的purgeDownNeighbors()的实现</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* Remove all Neighbors for which the linkStatus_ is DOWN. 
</span></span></span><span class="line"><span class="cl"><span class="cm">* 删除所有链路状态位DOWN的节点
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> 
</span></span><span class="line"><span class="cl"><span class="n">NeighborList</span><span class="o">::</span><span class="n">purgeDownNeighbors</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//如果邻居表为空
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span><span class="n">numNeighbors_</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>        <span class="c1">// Nothing to do
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// [case-1]: Leaving the 1st case(head_ case)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Neighbor</span> <span class="o">*</span><span class="n">prev</span><span class="p">,</span> <span class="o">*</span><span class="n">cur</span><span class="p">,</span> <span class="o">*</span><span class="n">toBeDeleted</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">prev</span> <span class="o">=</span> <span class="n">head_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">cur</span> <span class="o">=</span> <span class="n">head_</span><span class="o">-&gt;</span><span class="n">next_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//循环遍历，只要下一个节点不为空
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span><span class="p">(;</span><span class="n">cur</span><span class="o">!=</span><span class="nb">NULL</span><span class="p">;)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 如果下一个节点的链路状态位LINKDOWN
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">linkStatus_</span> <span class="o">==</span> <span class="n">LINKDOWN</span><span class="p">)</span> <span class="p">{</span>    <span class="c1">// Delete the Neighbor
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">prev</span><span class="o">-&gt;</span><span class="n">next_</span> <span class="o">=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">next_</span><span class="p">;</span><span class="c1">//前置节点的next指向被删除节点的next
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">toBeDeleted</span> <span class="o">=</span> <span class="n">cur</span><span class="p">;</span><span class="c1">//cur赋值给需要删除的节点的指针
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">cur</span> <span class="o">=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">next_</span><span class="p">;</span><span class="c1">//cur指向下一个节点
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">delete</span> <span class="n">toBeDeleted</span><span class="p">;</span><span class="c1">//删除被删除节点的空间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">numNeighbors_</span><span class="o">--</span><span class="p">;</span><span class="c1">//邻居表内成员--
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">prev</span> <span class="o">=</span> <span class="n">cur</span><span class="p">;</span>        <span class="c1">// 前节点等于下一个节点
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">cur</span> <span class="o">=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">next_</span><span class="p">;</span><span class="c1">//下一个节点指向下一个节点的next                
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// [case-2]: head_ case...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 头节点特判
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span><span class="n">head_</span><span class="o">!=</span><span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//如果头节点为LINKDOWN
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span><span class="p">(</span><span class="n">head_</span><span class="o">-&gt;</span><span class="n">linkStatus_</span> <span class="o">==</span> <span class="n">LINKDOWN</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">toBeDeleted</span> <span class="o">=</span> <span class="n">head_</span><span class="p">;</span> <span class="c1">//赋值给需要删除的节点的指针
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">head_</span> <span class="o">=</span> <span class="n">head_</span><span class="o">-&gt;</span><span class="n">next_</span><span class="p">;</span><span class="c1">//头节点指向头节点的next
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">delete</span> <span class="n">toBeDeleted</span><span class="p">;</span><span class="c1">//删除
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">numNeighbors_</span><span class="o">--</span><span class="p">;</span><span class="c1">//邻居表内成员--
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr>
<h4 id="2117-neighborlist类的void-freelist的实现">2.1.1.7 NeighborList类的void freeList()的实现</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/*  
</span></span></span><span class="line"><span class="cl"><span class="cm">* 删除整个表
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> 
</span></span><span class="line"><span class="cl"><span class="n">NeighborList</span><span class="o">::</span><span class="n">freeList</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//表内元素为空
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span><span class="n">numNeighbors_</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//指定临时变量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Neighbor</span> <span class="o">*</span><span class="n">toBeDeleted</span><span class="p">,</span> <span class="o">*</span><span class="n">cur</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// [i&lt;numNeighbors_] condition takes care for EMPTY List case...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">cur</span> <span class="o">=</span> <span class="n">head_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">numNeighbors_</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">toBeDeleted</span> <span class="o">=</span> <span class="n">cur</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">cur</span> <span class="o">=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">next_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">delete</span> <span class="n">toBeDeleted</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">head_</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>        <span class="c1">// Reset the attributes...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">numNeighbors_</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>    <span class="c1">// Reset the attributes...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><hr>
<h4 id="2118--neighborlist类的printneighbors的实现">2.1.1.8  NeighborList类的printNeighbors()的实现</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* Print all Neighbors to the console. 
</span></span></span><span class="line"><span class="cl"><span class="cm">* 控制台打印邻居链表内所有邻居信息
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span>
</span></span><span class="line"><span class="cl"><span class="n">NeighborList</span><span class="o">::</span><span class="n">printNeighbors</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Print current Neighbor-Table
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Neighbors:[&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">numNeighbors_</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;EMPTY]&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>    
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">Neighbor</span> <span class="o">*</span><span class="n">curNb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">curNb</span> <span class="o">=</span> <span class="n">head_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 打印链路状态为up的邻居节点
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;(Up: &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">numNeighbors_</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">curNb</span><span class="o">-&gt;</span><span class="n">linkStatus_</span> <span class="o">==</span> <span class="n">LINKUP</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">printf</span><span class="p">(</span><span class="s">&#34;%d &#34;</span><span class="p">,</span><span class="n">curNb</span><span class="o">-&gt;</span><span class="n">addr_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">curNb</span> <span class="o">=</span> <span class="n">curNb</span><span class="o">-&gt;</span><span class="n">next_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//打印链路状态为DOWN的邻居节点
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;),(Down: &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">curNb</span> <span class="o">=</span> <span class="n">head_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">numNeighbors_</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">curNb</span><span class="o">-&gt;</span><span class="n">linkStatus_</span> <span class="o">==</span> <span class="n">LINKDOWN</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">printf</span><span class="p">(</span><span class="s">&#34;%d &#34;</span><span class="p">,</span><span class="n">curNb</span><span class="o">-&gt;</span><span class="n">addr_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">curNb</span> <span class="o">=</span> <span class="n">curNb</span><span class="o">-&gt;</span><span class="n">next_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;)]&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr>
<h3 id="212-ndpagent类内成员ndpbeacontransmittimer类">2.1.2 NDPAgent类内成员NDPBeaconTransmitTimer类</h3>
<p>该类定时发送邻居节点的探测包</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* [SUB-SECTION-2.2]------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="cm"> * BEACON-TRANSMIT TIMER:- PERIODIC BEACON XMISSION
</span></span></span><span class="line"><span class="cl"><span class="cm"> * -----------------------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*!    \class NDPBeaconTransmitTimer
</span></span></span><span class="line"><span class="cl"><span class="cm">    \brief This class implements a BEACON Transmit Timer, 
</span></span></span><span class="line"><span class="cl"><span class="cm">    \who periodically sends beacons to NEIGHBOR nodes.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">NDPBeaconTransmitTimer</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Handler</span> 
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Data...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ZRPAgent</span> <span class="o">*</span><span class="n">agent_</span><span class="p">;</span>        <span class="c1">// 指向ZRPAgent的指针
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Event</span> <span class="n">intr_</span><span class="p">;</span>        
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">beacon_period_</span><span class="p">;</span>         <span class="c1">// 发包时间间隔
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">beacon_period_jitter_</span><span class="p">;</span>    <span class="c1">// Jitter added to Inter-Beacon-Time
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">neighbor_ack_timeout_</span><span class="p">;</span>     <span class="c1">// Only for Logging为了日志打印
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 构造器...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">NDPBeaconTransmitTimer</span><span class="p">(</span><span class="n">ZRPAgent</span><span class="o">*</span> <span class="n">agent</span><span class="p">)</span> <span class="o">:</span> <span class="n">agent_</span><span class="p">(</span><span class="n">agent</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="n">beacon_period_</span><span class="p">(</span><span class="n">DEFAULT_BEACON_PERIOD</span><span class="p">),</span> 
</span></span><span class="line"><span class="cl">        <span class="n">beacon_period_jitter_</span><span class="p">(</span><span class="n">DEFAULT_BEACON_PERIOD_JITTER</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="n">neighbor_ack_timeout_</span><span class="p">(</span><span class="n">DEFAULT_NEIGHBOR_ACK_TIMEOUT</span><span class="p">)</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">handle</span><span class="p">(</span><span class="n">Event</span><span class="o">*</span><span class="p">);</span>          <span class="c1">// function handling the event
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">void</span> <span class="nf">start</span><span class="p">(</span><span class="kt">double</span> <span class="n">thistime</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><hr>
<h4 id="2121-ndpbeacontransmittimer类的start的实现">2.1.2.1 NDPBeaconTransmitTimer类的start()的实现</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* Starts BeaconTransmitTimer, called by startUp(), delayed by &#39;thistime&#39;. 
</span></span></span><span class="line"><span class="cl"><span class="cm">* 被NDPAgent的startUp方法调用
</span></span></span><span class="line"><span class="cl"><span class="cm">* thistime:为延迟时间
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> 
</span></span><span class="line"><span class="cl"><span class="n">NDPBeaconTransmitTimer</span><span class="o">::</span><span class="n">start</span><span class="p">(</span><span class="kt">double</span> <span class="n">thistime</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//将其提交给ns2的Scheduler去计划启动
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Scheduler</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">schedule</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">intr_</span><span class="p">,</span> <span class="n">thistime</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr>
<h4 id="2121-ndpbeacontransmittimer类的handle的实现">2.1.2.1 NDPBeaconTransmitTimer类的handle()的实现</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* Broadcasts a Beacon. 
</span></span></span><span class="line"><span class="cl"><span class="cm">* 广播邻居查找
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> 
</span></span><span class="line"><span class="cl"><span class="n">NDPBeaconTransmitTimer</span><span class="o">::</span><span class="n">handle</span><span class="p">(</span><span class="n">Event</span><span class="o">*</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// [Task-1]: 创建一个广播信标
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 包的指针
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Packet</span><span class="o">*</span> <span class="n">p</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//调用方法创建一个NDP_BEACON,IP为IP_BROADCAST,TIME TO LIVE = 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">pktUtil_</span><span class="p">).</span><span class="n">pkt_create</span><span class="p">(</span><span class="n">NDP_BEACON</span><span class="p">,</span> <span class="n">IP_BROADCAST</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> <span class="c1">// last arg is TTL=1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//调用pktUtil_的广播方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">pktUtil_</span><span class="p">).</span><span class="n">pkt_broadcast</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mf">0.00</span><span class="p">);</span>             <span class="c1">// broadcast pkt
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="k">if</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// [Log: XMIT_NDP_BEACON]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">Time</span> <span class="n">now</span> <span class="o">=</span> <span class="n">Scheduler</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">clock</span><span class="p">();</span> <span class="c1">// get the time
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">hdr_zrp</span> <span class="o">*</span><span class="n">hdrz</span> <span class="o">=</span> <span class="n">HDR_ZRP</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>           <span class="c1">// access ZRP part of pkt header
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">_%d_ [%6.6f] | XMIT_NDP_BEACON | -S %d -Nb BROADCAST | -SEQ %d | &#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">myaddr_</span><span class="p">,</span> <span class="n">now</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">src_</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">seq_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">print_tables</span><span class="p">();</span> <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span> <span class="c1">// [Log: End]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// [Task-2]: 开启ACKTimer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">ndpAgt_</span><span class="p">).</span><span class="n">AckTimer_</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// [Task-3]: Schedule next scan in BEACON_PERIOD + Jitter sec
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 将其交给Schedule，延迟时间BEACON_PERIOD + Jitter sec之后再次调用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">Scheduler</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">schedule</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">intr_</span><span class="p">,</span> <span class="n">beacon_period_</span> <span class="o">+</span> <span class="n">Random</span><span class="o">::</span><span class="n">uniform</span><span class="p">(</span><span class="n">beacon_period_jitter_</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr>
<h3 id="213-ndpagent类内成员ndpacktimer类">2.1.3 NDPAgent类内成员NDPAckTimer类</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* [SUB-SECTION-2.3]------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="cm"> * ACK-TIMEOUT TIMER:- ACK-TIMEOUT CHECKING
</span></span></span><span class="line"><span class="cl"><span class="cm"> * -----------------------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*!    \class NDPAckTimer
</span></span></span><span class="line"><span class="cl"><span class="cm">    \brief This class implements a Acknoledgement TimeOut Timer, who checks
</span></span></span><span class="line"><span class="cl"><span class="cm">           that ACK is received or not for sent beacon.
</span></span></span><span class="line"><span class="cl"><span class="cm">    \该类为一个超时类，检查有没有接收到ACK
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">NDPAckTimer</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Handler</span> 
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">ZRPAgent</span> <span class="o">*</span><span class="n">agent_</span><span class="p">;</span>        <span class="c1">// 指向ZRP-Agent的指针
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Event</span> <span class="n">intr_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">neighbor_ack_timeout_</span><span class="p">;</span>    <span class="c1">// ACK送信超时时间    
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Constructor...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">NDPAckTimer</span><span class="p">(</span><span class="n">ZRPAgent</span><span class="o">*</span> <span class="n">agent</span><span class="p">)</span> <span class="o">:</span> <span class="n">agent_</span><span class="p">(</span><span class="n">agent</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="n">neighbor_ack_timeout_</span><span class="p">(</span><span class="n">DEFAULT_NEIGHBOR_ACK_TIMEOUT</span><span class="p">)</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="kt">void</span> <span class="nf">handle</span><span class="p">(</span><span class="n">Event</span><span class="o">*</span><span class="p">);</span>          <span class="c1">// function handling the event
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">void</span> <span class="nf">start</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><hr>
<h4 id="2131-ndpacktimer类方法start的实现">2.1.3.1 NDPAckTimer类方法start()的实现</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* [SUB-SECTION-1.3]--------------------------------------------------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="cm"> * ACK-TIMEOUT TIMER:- ACK-TIMEOUT CHECKING
</span></span></span><span class="line"><span class="cl"><span class="cm"> * -------------------------------------------------------------------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* Schedule timeout at neighbor_ack_timeout_, 
</span></span></span><span class="line"><span class="cl"><span class="cm">* just after sending a Beacon. 
</span></span></span><span class="line"><span class="cl"><span class="cm">* 在发送NDP Beacon之后启动
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> 
</span></span><span class="line"><span class="cl"><span class="n">NDPAckTimer</span><span class="o">::</span><span class="n">start</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Scheduler</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">schedule</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">intr_</span><span class="p">,</span> <span class="n">neighbor_ack_timeout_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr>
<h4 id="2132-ndpacktimer类方法handle的实现">2.1.3.2 NDPAckTimer类方法handle()的实现</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* 
</span></span></span><span class="line"><span class="cl"><span class="cm">* Mark LINKDOWN for un-ACKed neighbors. 
</span></span></span><span class="line"><span class="cl"><span class="cm">* If any of them found DOWN then notify IARP to rebuild routing table. 
</span></span></span><span class="line"><span class="cl"><span class="cm">* 为未确认ACK的邻居设置LinkStatus为LinkDOWN
</span></span></span><span class="line"><span class="cl"><span class="cm">* 一旦发现LinkDown的邻居节点，就通知IARP重新创建路径表
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> 
</span></span><span class="line"><span class="cl"><span class="n">NDPAckTimer</span><span class="o">::</span><span class="n">handle</span><span class="p">(</span><span class="n">Event</span><span class="o">*</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// [Task-1]: Check if Neighbor Table is Empty...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//检查邻居链表是否为空
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">((</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">ndpAgt_</span><span class="p">).</span><span class="n">neighborLst_</span><span class="p">.</span><span class="n">isEmpty</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// [Log: NDP_ISOLATED_NODE ]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">Time</span> <span class="n">now</span> <span class="o">=</span> <span class="n">Scheduler</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">clock</span><span class="p">();</span> <span class="c1">// get the time
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">_%d_ [%6.6f] | NDP_ISOLATED_NODE | No NDP_BEACON_ACK Detected | &#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">myaddr_</span><span class="p">,</span> <span class="n">now</span><span class="p">);</span> <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">print_tables</span><span class="p">();</span> <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span> <span class="c1">// [Log: End]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span><span class="p">;</span><span class="c1">//什么都不做
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// [Task-2]: Drop timed-out neighbors &amp; inform IARP about it...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 删除超时的邻居节点，并且通知IARP
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Time</span> <span class="n">now</span> <span class="o">=</span> <span class="n">Scheduler</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">clock</span><span class="p">();</span> <span class="c1">// 获取时间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Neighbor</span> <span class="o">*</span><span class="n">prev</span><span class="p">,</span> <span class="o">*</span><span class="n">curNb</span><span class="p">;</span> <span class="c1">//定义存储邻居节点的前置指针和临时指针
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">prev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>    <span class="c1">// 必须置为 NULL
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//指向当前ZRPAgent的NDPAgent下的邻居表的头节点
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">curNb</span> <span class="o">=</span> <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">ndpAgt_</span><span class="p">).</span><span class="n">neighborLst_</span><span class="p">.</span><span class="n">head_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//循环检查链表内邻居节点的ACK时间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span><span class="p">(;</span> <span class="n">curNb</span><span class="o">!=</span><span class="nb">NULL</span><span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// [SubTask-2.1]: Check for Ack Timeout of Neighbor
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 如果当前时间-邻居节点的最近一次时间超过Ack超时时间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span><span class="p">((</span><span class="n">now</span> <span class="o">-</span> <span class="n">curNb</span><span class="o">-&gt;</span><span class="n">lastack_</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">neighbor_ack_timeout_</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 检查当前节点的超时次数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// [SubTask-2.2]: Check for How many TimeOuts have occured with this Neighbor
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//超时次数先++
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">curNb</span><span class="o">-&gt;</span><span class="n">AckTOCount_</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//检查是否超多最大超时次数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span><span class="p">(</span><span class="n">curNb</span><span class="o">-&gt;</span><span class="n">AckTOCount_</span> <span class="o">&gt;=</span> <span class="n">DEFAULT_MAX_ACK_TIMEOUT</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 将该节点的LinKStates设置为DOWN，并且通知IARP
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// [SubTask-2.3]: Detected a DOWN Neighbor - Notify IARP &amp; Take appropriate actions     
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">//将IARP内部的updateSendFlag_设置为true,为下次更新做准备
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">iarpAgt_</span><span class="p">).</span><span class="n">updateSendFlag_</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span> <span class="c1">// Set the Update at Next Timer-Event 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">//定义LinkState的临时handleToFoundLS
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">LinkState</span> <span class="o">*</span><span class="n">handleToFoundLS</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//定义查找flag
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="kt">int</span> <span class="n">foundFlag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//从当前ZRPAgent的IARPAgent的LinKState链表内查询
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">foundFlag</span> <span class="o">=</span> <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">iarpAgt_</span><span class="p">).</span><span class="n">lsLst_</span><span class="p">.</span><span class="n">findLink</span><span class="p">(</span><span class="n">curNb</span><span class="o">-&gt;</span><span class="n">addr_</span><span class="p">,</span> <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">myaddr_</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">handleToFoundLS</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//如果查到了
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">if</span><span class="p">(</span> <span class="n">foundFlag</span> <span class="o">==</span> <span class="n">TRUE</span> <span class="p">)</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl">                    <span class="n">handleToFoundLS</span><span class="o">-&gt;</span><span class="n">isup_</span> <span class="o">=</span> <span class="n">LINKDOWN</span><span class="p">;</span>      <span class="c1">// 将link-stauts设置为DOWN 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">iarpAgt_</span><span class="p">).</span><span class="n">buildRoutingTable</span><span class="p">();</span>      <span class="c1">// 重构 Routing Table
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// [SubTask-2.4]: Set the Link-Status of Neighbor to LINKDOWN...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//          [DOWN Neighbors are deleted after sending IARP_UPDATE - I didn&#39;t forget that :) ]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">//将该当邻居节点的linkStatus设置为DOWN
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">curNb</span><span class="o">-&gt;</span><span class="n">linkStatus_</span> <span class="o">=</span> <span class="n">LINKDOWN</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// [Log: NDP_BEACON_ACK_TIMEOUT]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">Time</span> <span class="n">now</span> <span class="o">=</span> <span class="n">Scheduler</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">clock</span><span class="p">();</span> <span class="c1">// get the time
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">_%d_ [%6.6f] | NDP_BEACON_ACK_TIMEOUT | -S %d -Nb %d | -TimeOut %d | &#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">myaddr_</span><span class="p">,</span> <span class="n">now</span><span class="p">,</span> <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">myaddr_</span><span class="p">,</span> <span class="n">curNb</span><span class="o">-&gt;</span><span class="n">addr_</span><span class="p">,</span> <span class="n">neighbor_ack_timeout_</span><span class="p">);</span>    
</span></span><span class="line"><span class="cl">                    <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">print_tables</span><span class="p">();</span> <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span> <span class="c1">// [Log: End]        
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//继续遍历
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">prev</span> <span class="o">=</span> <span class="n">curNb</span><span class="p">;</span>        <span class="c1">// Advance the Pointers    
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">curNb</span><span class="o">=</span><span class="n">curNb</span><span class="o">-&gt;</span><span class="n">next_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr>
<h3 id="214-ndpagnet类内方法startup">2.1.4 NDPAgnet类内方法startUp()</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* [SUB-SECTION-1.4]--------------------------------------------------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="cm"> * NDP AGENT:- NEIGHBOR DISCOVERY AGENT
</span></span></span><span class="line"><span class="cl"><span class="cm"> * -------------------------------------------------------------------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*开启邻居节点信标探测，清空链表 */</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*!    \fn void startUp()
</span></span></span><span class="line"><span class="cl"><span class="cm">        This is called by ZRPAgent::startUp() method. It does following tasks: \n
</span></span></span><span class="line"><span class="cl"><span class="cm">        - Starts the Beacon-Transmit-Timer. \n
</span></span></span><span class="line"><span class="cl"><span class="cm">        - Clears the Neighbor-List.
</span></span></span><span class="line"><span class="cl"><span class="cm">        这个方法在ZRPAgent类的StartUp方法中被调用
</span></span></span><span class="line"><span class="cl"><span class="cm">        并执行开启Beacon-Transmit-Timer
</span></span></span><span class="line"><span class="cl"><span class="cm">        以及清空邻居节点链路表
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span>
</span></span><span class="line"><span class="cl"><span class="n">NDPAgent</span><span class="o">::</span><span class="n">startUp</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// [Task-1]: Start the Timers... [We donot need to start ACK timer- It is started by BTTimer]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 开启BeaconTransitTimer 我们不需要开启ACKtimer 他在BeaconTransmitTimer_之后被启动
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">double</span> <span class="n">startUpJitter</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">startUpJitter</span> <span class="o">=</span>  <span class="n">Random</span><span class="o">::</span><span class="n">uniform</span><span class="p">(</span><span class="n">startup_jitter_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">BeaconTransmitTimer_</span><span class="p">.</span><span class="n">start</span><span class="p">(</span><span class="n">startUpJitter</span><span class="p">);</span>    
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// [Task-2]: Clear the NeighborList...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 清空邻居链表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">neighborLst_</span><span class="p">.</span><span class="n">isEmpty</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">neighborLst_</span><span class="p">.</span><span class="n">freeList</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr>
<h3 id="215-ndpagnet类内方法recv_ndp_beaconpacket-p">2.1.5 NDPAgnet类内方法recv_NDP_BEACON(Packet* p)</h3>
<p>在ZRPAgent::recv()方法中被使用</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* 接收到NDP_BEACON的时候，返回NDP_BEACON_ACK*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span>
</span></span><span class="line"><span class="cl"><span class="n">NDPAgent</span><span class="o">::</span><span class="n">recv_NDP_BEACON</span><span class="p">(</span><span class="n">Packet</span><span class="o">*</span> <span class="n">p</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// [Assumption]:We are looking only for symmetric links. 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// [Assumption]:我们只寻找对称链接 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// On receving NDP_BEACON, I donot consider the sender as a Neighbor.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 当接收到NDP_BEACON的时候，我们不讨论他是否是邻居
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="k">if</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// [Log: RECV_NDP_BEACON]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">Time</span> <span class="n">now</span> <span class="o">=</span> <span class="n">Scheduler</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">clock</span><span class="p">();</span> <span class="c1">// get the time
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">hdr_zrp</span> <span class="o">*</span><span class="n">hdrz</span> <span class="o">=</span> <span class="n">HDR_ZRP</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>         <span class="c1">// access ZRP part of pkt header
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">_%d_ [%6.6f] | RECV_NDP_BEACON | -S %d -Nb %d | -SEQ %d | &#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">myaddr_</span><span class="p">,</span> <span class="n">now</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">src_</span><span class="p">,</span> <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">myaddr_</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">seq_</span><span class="p">);</span>    
</span></span><span class="line"><span class="cl">                    <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">print_tables</span><span class="p">();</span> <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span> <span class="c1">// [Log: End]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// [Task-1]: Create an ACK packet and Send it...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//  创建ACK包并且发送
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Packet</span> <span class="o">*</span><span class="n">pnew</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span><span class="c1">//创建新的包的临时变量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">hdr_zrp</span> <span class="o">*</span><span class="n">hdrz</span> <span class="o">=</span> <span class="n">HDR_ZRP</span><span class="p">(</span><span class="n">p</span><span class="p">);</span><span class="c1">//从接收到的包里分离出zrp的包头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//创建包，类型NDP_BEACON_ACK，目标为发送节点，TIME TO LIVE = 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">pnew</span> <span class="o">=</span> <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">pktUtil_</span><span class="p">).</span><span class="n">pkt_create</span><span class="p">(</span><span class="n">NDP_BEACON_ACK</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">src_</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Unicast the packet (单播包)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">pktUtil_</span><span class="p">).</span><span class="n">pkt_send</span><span class="p">(</span><span class="n">pnew</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">src_</span><span class="p">,</span> <span class="mf">0.00</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// [Log: XMIT_NDP_BEACON_ACK]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">Time</span> <span class="n">now</span> <span class="o">=</span> <span class="n">Scheduler</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">clock</span><span class="p">();</span> <span class="c1">// get the time
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">hdr_zrp</span> <span class="o">*</span><span class="n">hdrznew</span> <span class="o">=</span> <span class="n">HDR_ZRP</span><span class="p">(</span><span class="n">pnew</span><span class="p">);</span>     <span class="c1">// access ZRP part of pkt header
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">_%d_ [%6.6f] | XMIT_NDP_BEACON_ACK | -S %d -Nb %d | -SEQ %d | &#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">myaddr_</span><span class="p">,</span> <span class="n">now</span><span class="p">,</span> <span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">dest_</span><span class="p">,</span> <span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">src_</span><span class="p">,</span> <span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">seq_</span><span class="p">);</span>    
</span></span><span class="line"><span class="cl">                    <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">print_tables</span><span class="p">();</span> <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span> <span class="c1">// [Log: End]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// [Task-2]: Drop the NDP_BEACON just Received...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//丢弃掉已经接收到的NDP_BEACON
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">pktUtil_</span><span class="p">).</span><span class="n">pkt_drop</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr>
<h3 id="216-ndpagnet类内方法recv_ndp_beacon_ackpacket-p">2.1.6 NDPAgnet类内方法recv_NDP_BEACON_ACK(Packet* p)</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* On receiving ACK, Update the Neighbor-table and IARP-(topology &amp; routing)-table if required. */</span>
</span></span><span class="line"><span class="cl"><span class="c1">//收到 ACK 后，如果需要，更新邻居表和 IARP（拓扑和路由）表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> 
</span></span><span class="line"><span class="cl"><span class="n">NDPAgent</span><span class="o">::</span><span class="n">recv_NDP_BEACON_ACK</span><span class="p">(</span><span class="n">Packet</span><span class="o">*</span> <span class="n">p</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// [Task-1]: Check if Neighbor exists - If not, add it &amp; Notify IARP...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Time</span> <span class="n">now</span> <span class="o">=</span> <span class="n">Scheduler</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">clock</span><span class="p">();</span>     <span class="c1">// 获取当前时间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">hdr_zrp</span> <span class="o">*</span><span class="n">hdrz</span> <span class="o">=</span> <span class="n">HDR_ZRP</span><span class="p">(</span><span class="n">p</span><span class="p">);</span><span class="c1">// 获取ZRP的包头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Neighbor</span> <span class="o">*</span><span class="n">handleToFoundNb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span><span class="c1">//定义查找邻居节点的指针
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//在邻居节点内部查找该邻居是否存在
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">foundNeighbor</span> <span class="o">=</span> <span class="n">neighborLst_</span><span class="p">.</span><span class="n">findNeighbor</span><span class="p">(</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">src_</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">handleToFoundNb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//如果该邻居存在
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span><span class="n">foundNeighbor</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// [Log: RECV_NDP_BEACON_ACK]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">Time</span> <span class="n">now</span> <span class="o">=</span> <span class="n">Scheduler</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">clock</span><span class="p">();</span> <span class="c1">// get the time
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">_%d_ [%6.6f] | RECV_NDP_BEACON_ACK | -S %d -Nb %d | -SEQ %d | &#34;</span>
</span></span><span class="line"><span class="cl">                    <span class="s">&#34;Existing Neighbor Detected | &#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">myaddr_</span><span class="p">,</span> <span class="n">now</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">dest_</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">src_</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">seq_</span><span class="p">);</span>    
</span></span><span class="line"><span class="cl">                    <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">print_tables</span><span class="p">();</span> <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span> <span class="c1">// [Log: End]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//将其最后一次ack设置为当前时间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">handleToFoundNb</span><span class="o">-&gt;</span><span class="n">lastack_</span> <span class="o">=</span> <span class="n">now</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//将其linkStatus_状态设置为UP    
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">handleToFoundNb</span><span class="o">-&gt;</span><span class="n">linkStatus_</span> <span class="o">=</span> <span class="n">LINKUP</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//将其ACK未确认次数归零
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">handleToFoundNb</span><span class="o">-&gt;</span><span class="n">AckTOCount_</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// 如果为查找到，意味着发现新邻居    
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="k">if</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// [Log: RECV_NDP_BEACON_ACK]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">Time</span> <span class="n">now</span> <span class="o">=</span> <span class="n">Scheduler</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">clock</span><span class="p">();</span> <span class="c1">// get the time
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">_%d_ [%6.6f] | RECV_NDP_BEACON_ACK | -S %d -Nb %d | -SEQ %d | &#34;</span>
</span></span><span class="line"><span class="cl">                    <span class="s">&#34;New Neighbor Detected | &#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">myaddr_</span><span class="p">,</span> <span class="n">now</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">dest_</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">src_</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">seq_</span><span class="p">);</span>    
</span></span><span class="line"><span class="cl">                    <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">print_tables</span><span class="p">();</span> <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span> <span class="c1">// [Log: End]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//在邻居表中添加新邻居信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">neighborLst_</span><span class="p">.</span><span class="n">addNeighbor</span><span class="p">(</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">src_</span><span class="p">,</span> <span class="n">now</span><span class="p">,</span> <span class="n">LINKUP</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Notify IARP to send the next Update [Change of Neighbor-Table Detected]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//通知IARP 在下次更新的时候更新路径表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>         <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">iarpAgt_</span><span class="p">).</span><span class="n">updateSendFlag_</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span> <span class="c1">// Set the Update at Next Timer-Event    
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// [Task-2]: Update IARP...    
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 更新IARP
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 定义LinkState的临时存储指针
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">LinkState</span> <span class="o">*</span><span class="n">handleToFoundLS</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//查询Link状态
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">LSFoundFlag</span> <span class="o">=</span> <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">iarpAgt_</span><span class="p">).</span><span class="n">lsLst_</span><span class="p">.</span><span class="n">findLink</span><span class="p">(</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">src_</span><span class="p">,</span> <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">myaddr_</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">handleToFoundLS</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span> <span class="n">LSFoundFlag</span> <span class="o">==</span> <span class="n">FALSE</span> <span class="p">)</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl">        <span class="c1">//如没查询到，则加入该链路信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">iarpAgt_</span><span class="p">).</span><span class="n">lsLst_</span><span class="p">.</span><span class="n">addLink</span><span class="p">(</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">src_</span><span class="p">,</span> <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">myaddr_</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">seq_</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                            <span class="n">LINKUP</span><span class="p">,</span> <span class="n">now</span><span class="o">+</span><span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">iarpAgt_</span><span class="p">).</span><span class="n">linkLifeTime_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">iarpAgt_</span><span class="p">).</span><span class="n">buildRoutingTable</span><span class="p">();</span>      <span class="c1">// 重构 Routing Table
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//从 Send_Buffer 中查找有无需要发送的数据包
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">route_SendBuffer_pkt</span><span class="p">();</span>    
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>    <span class="c1">// 如果链路查找到了，更新其内属性
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">handleToFoundLS</span><span class="o">-&gt;</span><span class="n">isup_</span> <span class="o">=</span> <span class="n">LINKUP</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">handleToFoundLS</span><span class="o">-&gt;</span><span class="n">expiry_</span> <span class="o">=</span> <span class="n">now</span><span class="o">+</span><span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">iarpAgt_</span><span class="p">).</span><span class="n">linkLifeTime_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// [Task-3]: 丢弃该包
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">pktUtil_</span><span class="p">).</span><span class="n">pkt_drop</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr>
<h2 id="3-iarp主动协议">3. IARP(主动协议)</h2>
<hr>
<h3 id="31-iarpagent">3.1 IARPAgent</h3>
<p>ZRP协议内部维护区域半径的主动协议</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* [SUB-SECTION-3.7]------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="cm"> * IARP AGENT:- INTRA-ZONE ROUTING AGENT
</span></span></span><span class="line"><span class="cl"><span class="cm"> * -----------------------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*!    \class IARPAgent
</span></span></span><span class="line"><span class="cl"><span class="cm">    \brief This class implements the IntrAzone Routing Protocol (IARP).
</span></span></span><span class="line"><span class="cl"><span class="cm">    \该类包含了IARP协议
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">IARPAgent</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Data...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ZRPAgent</span> <span class="o">*</span><span class="n">agent_</span><span class="p">;</span>    <span class="c1">// 指向ZRPAgent的指针
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">updateSendFlag_</span><span class="p">;</span><span class="c1">// 初期化为TRUE [定期更新被发送
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// 如果它为True,每次更新都被发送
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// 如果它为False
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 表...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">LinkStateList</span> <span class="n">lsLst_</span><span class="p">;</span>    <span class="c1">// 拓扑表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">PeripheralNodeList</span> <span class="n">pnLst_</span><span class="p">;</span>    <span class="c1">//外围节点表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">InnerRouteList</span> <span class="n">irLst_</span><span class="p">;</span>    <span class="c1">//主动路径表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">IARPUpdateDetectedList</span> <span class="n">upLst_</span><span class="p">;</span>    <span class="c1">// 检测到更新缓存
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">linkLifeTime_</span><span class="p">;</span>    <span class="c1">// DEFAULT_LINK_LIFETIME 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">updateLifeTime_</span><span class="p">;</span><span class="c1">// DEFAULT_UPDATE_LIFETIME
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Timers...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">IARPPeriodicUpdateTimer</span> <span class="n">PeriodicUpdateTimer_</span><span class="p">;</span><span class="c1">//定期更新计时器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">IARPExpirationTimer</span> <span class="n">ExpirationTimer_</span><span class="p">;</span> <span class="c1">//定期判断超时器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">startup_jitter_</span><span class="p">;</span>    <span class="c1">// For starting the Timers
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 构造器...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="cm">/*!    \fn IARPAgent(ZRPAgent *)
</span></span></span><span class="line"><span class="cl"><span class="cm">        该构造函数由ZRP的构造函数调用。它初始化IARP 中的不同组件。
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">IARPAgent</span><span class="p">(</span><span class="n">ZRPAgent</span> <span class="o">*</span><span class="n">agent</span><span class="p">)</span> <span class="o">:</span> <span class="n">agent_</span><span class="p">(</span><span class="n">agent</span><span class="p">),</span> <span class="n">updateSendFlag_</span><span class="p">(</span><span class="n">TRUE</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="n">linkLifeTime_</span><span class="p">(</span><span class="n">DEFAULT_LINK_LIFETIME</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="n">updateLifeTime_</span><span class="p">(</span><span class="n">DEFAULT_UPDATE_LIFETIME</span><span class="p">),</span> 
</span></span><span class="line"><span class="cl">        <span class="n">PeriodicUpdateTimer_</span><span class="p">(</span><span class="n">agent</span><span class="p">),</span> <span class="n">ExpirationTimer_</span><span class="p">(</span><span class="n">agent</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="n">startup_jitter_</span><span class="p">(</span><span class="n">DEFAULT_STARTUP_JITTER</span><span class="p">)</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 方法...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="cm">/*!    \fn void startUp()    
</span></span></span><span class="line"><span class="cl"><span class="cm">        这是由 ZRPAgent::startUp() 方法调用的。它执行以下任务: \n
</span></span></span><span class="line"><span class="cl"><span class="cm">        - 启动 Periodic-Update-Timer 和 Expiration-Timer。
</span></span></span><span class="line"><span class="cl"><span class="cm">        - 清除 LinkState-List、PeripheralNode-List、Inner-Route-List &amp;
</span></span></span><span class="line"><span class="cl"><span class="cm">          Detected-Update-List.
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">startUp</span><span class="p">();</span> <span class="c1">// 启动Timers &amp;清空Lists(Tables)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="cm">/*!    \fn void buildRoutingTable()
</span></span></span><span class="line"><span class="cl"><span class="cm">        该函数基于创建Link-State-List(链路状况表)来创建
</span></span></span><span class="line"><span class="cl"><span class="cm">        Inner-Route-List(内部路由路径表) &amp; Peripheral-Node-List(外围节点表)
</span></span></span><span class="line"><span class="cl"><span class="cm">        执行以下步骤。
</span></span></span><span class="line"><span class="cl"><span class="cm">        -# 清空已存在的 Inner-Route-List &amp; Peirpheral-Node-List.
</span></span></span><span class="line"><span class="cl"><span class="cm">        -# 清除 expired(过期) links &amp; DOWN links.
</span></span></span><span class="line"><span class="cl"><span class="cm">        -# 从现有链路状态列表生成 BFS 树.
</span></span></span><span class="line"><span class="cl"><span class="cm">        -# 基于该 BFS 树生成内部路由列表。插入所有叶子外围节点列表中的节点。
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">buildRoutingTable</span><span class="p">();</span><span class="c1">// 创建基于Topology-Table 的 Routing-Table
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="cm">/*!    \fn void addRouteInPacket(nsaddr_t dest, Packet *p)
</span></span></span><span class="line"><span class="cl"><span class="cm">        This function adds the Inner-route for node &#39;dest&#39; in packet &#39;p&#39; if available.
</span></span></span><span class="line"><span class="cl"><span class="cm">        该方法判断数据包P是否可用，如果可用，则将其添加到inner-route
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">addRouteInPacket</span><span class="p">(</span><span class="n">nsaddr_t</span> <span class="n">dest</span><span class="p">,</span> <span class="n">Packet</span> <span class="o">*</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/*!    \fn void recv_IARP_UPDATE(Packet* p)
</span></span></span><span class="line"><span class="cl"><span class="cm">        只要 ZRP 收到 IARP_UPDATE 数据包，就会调用此函数。
</span></span></span><span class="line"><span class="cl"><span class="cm">        执行以下任务-
</span></span></span><span class="line"><span class="cl"><span class="cm">        - 如果是一个新的iarp_update那么,
</span></span></span><span class="line"><span class="cl"><span class="cm">            - 节点更新它自己的 &#39;LINK_STATE_TABLE&#39;,
</span></span></span><span class="line"><span class="cl"><span class="cm">            - 如果 &#39;LINK_STATE_TABLE&#39; 被改变，那么, 就重构以下两个 
</span></span></span><span class="line"><span class="cl"><span class="cm">              &#39;INNER_ROUTING_TABLE&#39; and &#39;PERIPHERAL_NODE_TABLE&#39;,
</span></span></span><span class="line"><span class="cl"><span class="cm">            - 将此更新缓存在“UPDATE_DETECT_TABLE”中以控制泛洪，
</span></span></span><span class="line"><span class="cl"><span class="cm">            - 如果 TTL 不等于 0，则重新广播它.
</span></span></span><span class="line"><span class="cl"><span class="cm">        - 如果它是一个已经收到的 iarp_update 那么，
</span></span></span><span class="line"><span class="cl"><span class="cm">        - 节点丢弃此更新
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">recv_IARP_UPDATE</span><span class="p">(</span><span class="n">Packet</span><span class="o">*</span> <span class="n">p</span><span class="p">);</span> <span class="c1">// 接收IARP更新信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="cm">/*!    \fn void recv_IARP_DATA(Packet* p)
</span></span></span><span class="line"><span class="cl"><span class="cm">        只要 ZRP 收到 IARP_DATA 数据包，就会调用此函数。
</span></span></span><span class="line"><span class="cl"><span class="cm">        执行以下任务 -    
</span></span></span><span class="line"><span class="cl"><span class="cm">        - 如果该包的目标节点与当前节点相匹配，想消息发送到上一层
</span></span></span><span class="line"><span class="cl"><span class="cm">        - 否则
</span></span></span><span class="line"><span class="cl"><span class="cm">        - 转发该包
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">recv_IARP_DATA</span><span class="p">(</span><span class="n">Packet</span><span class="o">*</span> <span class="n">p</span><span class="p">);</span>    <span class="c1">// Receiving IARP DATA(Local Traffic)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="cm">/*!    \fn void print_tables()
</span></span></span><span class="line"><span class="cl"><span class="cm">        该方法打印Peripheral-Node-List &amp; Inner-Route-List.
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">print_tables</span><span class="p">();</span>        <span class="c1">// Print all Tables
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span></code></pre></div><hr>
<h4 id="311-iarpagent类内成员linkstatelist类">3.1.1 IARPAgent类内成员LinkStateList类</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">//该类维护一个拓扑链表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">class</span> <span class="nc">LinkStateList</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Data...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">LinkState</span> <span class="o">*</span><span class="n">head_</span><span class="p">;</span> <span class="c1">//表头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">numLinks_</span><span class="p">;</span>     <span class="c1">//内部成员数量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 构造方法...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">LinkStateList</span><span class="p">()</span> <span class="o">:</span> <span class="n">head_</span><span class="p">(</span><span class="nb">NULL</span><span class="p">),</span> <span class="n">numLinks_</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 方法...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">void</span> <span class="nf">addLink</span><span class="p">(</span><span class="n">nsaddr_t</span> <span class="n">src</span><span class="p">,</span> <span class="n">nsaddr_t</span> <span class="n">dest</span><span class="p">,</span> <span class="kt">int</span> <span class="n">seq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">isup</span><span class="p">,</span> <span class="n">Time</span> <span class="n">expiry</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="nf">findLink</span><span class="p">(</span><span class="n">nsaddr_t</span> <span class="n">src</span><span class="p">,</span> <span class="n">nsaddr_t</span> <span class="n">dest</span><span class="p">,</span> <span class="n">LinkState</span> <span class="o">**</span><span class="n">handle</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="nf">isEmpty</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">removeLink</span><span class="p">(</span><span class="n">LinkState</span> <span class="o">*</span><span class="n">prev</span><span class="p">,</span> <span class="n">LinkState</span> <span class="o">*</span><span class="n">toBeDeleted</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="nf">purgeLinks</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">printLinks</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">freeList</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="c1">//该类维护单个拓扑信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">class</span> <span class="nc">LinkState</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Data...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">nsaddr_t</span> <span class="n">src_</span><span class="p">;</span>      <span class="c1">// 32 bits的源节点
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">nsaddr_t</span> <span class="n">dest_</span><span class="p">;</span>      <span class="c1">// 32 bits的目标节点
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="kt">int</span> <span class="n">seq_</span><span class="p">;</span>          <span class="c1">// sequence number
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="kt">int</span> <span class="n">isup_</span><span class="p">;</span>        <span class="c1">// Link State LINKUP[1]/LINKDOWN[0]（状态）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">Time</span> <span class="n">expiry_</span><span class="p">;</span>        <span class="c1">// Link Expiry Time    (更新时间)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">LinkState</span> <span class="o">*</span><span class="n">next_</span><span class="p">;</span>    <span class="c1">// Pointer to Next Element （下一个指针）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 构造方法...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">LinkState</span><span class="p">()</span> <span class="o">:</span> <span class="n">src_</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">dest_</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">seq_</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="n">isup_</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">expiry_</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">),</span> <span class="n">next_</span><span class="p">(</span><span class="nb">NULL</span><span class="p">)</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">    <span class="n">LinkState</span><span class="p">(</span><span class="n">nsaddr_t</span> <span class="n">src</span><span class="p">,</span> <span class="n">nsaddr_t</span> <span class="n">dest</span><span class="p">,</span> <span class="kt">int</span> <span class="n">seq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">isup</span><span class="p">,</span> <span class="n">Time</span> <span class="n">expiry</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">src_</span> <span class="o">=</span> <span class="n">src</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="n">dest_</span> <span class="o">=</span> <span class="n">dest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="n">seq_</span> <span class="o">=</span> <span class="n">seq</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="n">isup_</span> <span class="o">=</span> <span class="n">isup</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="n">expiry_</span> <span class="o">=</span> <span class="n">expiry</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">next_</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><hr>
<h4 id="312-iarpagent类内成员peripheralnodelist类">3.1.2 IARPAgent类内成员PeripheralNodeList类</h4>
<p> PeripheralNodeList类及其内部的PeripheralNode类</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">//维护单个边界节点的类
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">class</span> <span class="nc">PeripheralNode</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Data...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">nsaddr_t</span> <span class="n">addr_</span><span class="p">;</span>        <span class="c1">// 节点的地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">coveredFlag_</span><span class="p">;</span>    <span class="c1">// Only For IERP
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">PeripheralNode</span> <span class="o">*</span><span class="n">next_</span><span class="p">;</span>    <span class="c1">// 指向下一个元素的指针
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 构造方法...    
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">PeripheralNode</span><span class="p">()</span> <span class="o">:</span> <span class="n">addr_</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">coveredFlag_</span><span class="p">(</span><span class="n">FALSE</span><span class="p">),</span> <span class="n">next_</span><span class="p">(</span><span class="nb">NULL</span><span class="p">)</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">    <span class="n">PeripheralNode</span><span class="p">(</span><span class="n">nsaddr_t</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">coveredFlag</span><span class="p">)</span> <span class="o">:</span> <span class="n">addr_</span><span class="p">(</span><span class="n">addr</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="n">coveredFlag_</span><span class="p">(</span><span class="n">coveredFlag</span><span class="p">),</span> <span class="n">next_</span><span class="p">(</span><span class="nb">NULL</span><span class="p">)</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="c1">//维护边界节点信息的链表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">class</span> <span class="nc">PeripheralNodeList</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Data...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">PeripheralNode</span> <span class="o">*</span><span class="n">head_</span><span class="p">;</span><span class="c1">//头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">numPerNodes_</span><span class="p">;</span>    <span class="c1">//内部元素数量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 构造器...    
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">PeripheralNodeList</span><span class="p">()</span> <span class="o">:</span> <span class="n">head_</span><span class="p">(</span><span class="nb">NULL</span><span class="p">),</span> <span class="n">numPerNodes_</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 方法...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">void</span> <span class="nf">addPerNode</span><span class="p">(</span><span class="n">nsaddr_t</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">coveredFlag</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="nf">findPerNode</span><span class="p">(</span><span class="n">nsaddr_t</span> <span class="n">addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">copyList</span><span class="p">(</span><span class="n">PeripheralNodeList</span> <span class="o">*</span><span class="n">newList</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">freeList</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><hr>
<h4 id="313-iarpagent类内成员innerroutelist类">3.1.3 IARPAgent类内成员InnerRouteList 类</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">//区域内单个路径表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">class</span> <span class="nc">InnerRoute</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Data...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">nsaddr_t</span> <span class="n">addr_</span><span class="p">;</span>        <span class="c1">// Destination Address
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">nsaddr_t</span> <span class="n">nextHop_</span><span class="p">;</span>    <span class="c1">// 接近destination的下一跳地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">numHops_</span><span class="p">;</span>        <span class="c1">// # of hops to the Destination 到目的地已经过了多少跳
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">InnerRoute</span> <span class="o">*</span><span class="n">next_</span><span class="p">;</span>    <span class="c1">// Next entry in the Routelist 路径表指向下一个元素
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">InnerRoute</span> <span class="o">*</span><span class="n">predecessor_</span><span class="p">;</span> <span class="c1">//构建 bordercast tree 边界广播
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 构造器...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">InnerRoute</span><span class="p">()</span> <span class="o">:</span> <span class="n">addr_</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">nextHop_</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">numHops_</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">next_</span><span class="p">(</span><span class="nb">NULL</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="n">predecessor_</span><span class="p">(</span><span class="nb">NULL</span><span class="p">)</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">    <span class="n">InnerRoute</span><span class="p">(</span><span class="n">nsaddr_t</span> <span class="n">addr</span><span class="p">,</span> <span class="n">nsaddr_t</span> <span class="n">nextHop</span><span class="p">,</span> <span class="n">InnerRoute</span> <span class="o">*</span><span class="n">predecessor</span><span class="p">,</span> <span class="kt">int</span> <span class="n">numHops</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">addr_</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">nextHop_</span> <span class="o">=</span> <span class="n">nextHop</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">predecessor_</span> <span class="o">=</span> <span class="n">predecessor</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">numHops_</span> <span class="o">=</span> <span class="n">numHops</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">next_</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="c1">//区域内维护路径表的链表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">class</span> <span class="nc">InnerRouteList</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">private</span><span class="o">:</span>    
</span></span><span class="line"><span class="cl">    <span class="n">InnerRoute</span> <span class="o">*</span><span class="n">tail_</span><span class="p">;</span>    <span class="c1">// Used in addRoute()... 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">public</span><span class="o">:</span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// Data...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">InnerRoute</span> <span class="o">*</span><span class="n">head_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">numRoutes_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 构造器...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">InnerRouteList</span><span class="p">()</span> <span class="o">:</span> <span class="n">tail_</span><span class="p">(</span><span class="nb">NULL</span><span class="p">),</span> <span class="n">head_</span><span class="p">(</span><span class="nb">NULL</span><span class="p">),</span> <span class="n">numRoutes_</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 方法...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">void</span> <span class="nf">addRoute</span><span class="p">(</span><span class="n">nsaddr_t</span> <span class="n">addr</span><span class="p">,</span> <span class="n">nsaddr_t</span> <span class="n">nextHop</span><span class="p">,</span> <span class="n">InnerRoute</span> <span class="o">*</span><span class="n">predecessor</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">numHops</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="nf">findRoute</span><span class="p">(</span><span class="n">nsaddr_t</span> <span class="n">addr</span><span class="p">,</span> <span class="n">InnerRoute</span> <span class="o">**</span><span class="n">handle</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">freeList</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><hr>
<h5 id="3131-innerroutelist类的addroute方法的实现">3.1.3.1 InnerRouteList类的addRoute方法的实现</h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* 1. 创造一个Route并将其加入到链表尾部 */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> 
</span></span><span class="line"><span class="cl"><span class="n">InnerRouteList</span><span class="o">::</span><span class="n">addRoute</span><span class="p">(</span><span class="n">nsaddr_t</span> <span class="n">addr</span><span class="p">,</span> <span class="n">nsaddr_t</span> <span class="n">nextHop</span><span class="p">,</span> <span class="n">InnerRoute</span> <span class="o">*</span><span class="n">predecessor</span><span class="p">,</span> <span class="kt">int</span> <span class="n">numHops</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">InnerRoute</span> <span class="o">*</span><span class="n">newRoute</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InnerRoute</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">nextHop</span><span class="p">,</span> <span class="n">predecessor</span><span class="p">,</span> <span class="n">numHops</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">newRoute</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>    <span class="c1">// Check for Allocation Error
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;### Memory Allocation Error in [InnerRouteList::addRoute] ###&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//如果为空链表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span><span class="n">head_</span><span class="o">==</span><span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">tail_</span><span class="o">==</span><span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span><span class="c1">// Empty list
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">head_</span> <span class="o">=</span> <span class="n">newRoute</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">tail_</span> <span class="o">=</span> <span class="n">newRoute</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>            <span class="c1">// Normal Case
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">tail_</span><span class="o">-&gt;</span><span class="n">next_</span> <span class="o">=</span> <span class="n">newRoute</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">tail_</span> <span class="o">=</span> <span class="n">newRoute</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">numRoutes_</span><span class="o">++</span><span class="p">;</span>            <span class="c1">// Increment # of routes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><hr>
<h4 id="314-iarpagent类内成员iarpupdatedetectedlist类">3.1.4 IARPAgent类内成员IARPUpdateDetectedList类</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">//维护单个IARP更新信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">class</span> <span class="nc">IARPUpdate</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Data...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">nsaddr_t</span> <span class="n">updateSrc_</span><span class="p">;</span>    <span class="c1">// Address of the sender（发送方的地址）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">seq_</span><span class="p">;</span>            <span class="c1">// Sequence Number
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Time</span> <span class="n">expiry_</span><span class="p">;</span>        <span class="c1">// Expiry Time       （超时时间）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">IARPUpdate</span> <span class="o">*</span><span class="n">next_</span><span class="p">;</span>    <span class="c1">// Pointer to the Next Element
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 构造器...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">IARPUpdate</span><span class="p">()</span> <span class="o">:</span>     <span class="n">updateSrc_</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">seq_</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">expiry_</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">next_</span><span class="p">(</span><span class="nb">NULL</span><span class="p">)</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">    <span class="n">IARPUpdate</span><span class="p">(</span><span class="n">nsaddr_t</span> <span class="n">updateSrc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">seq</span><span class="p">,</span> <span class="n">Time</span> <span class="n">expiry</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">updateSrc_</span> <span class="o">=</span> <span class="n">updateSrc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">seq_</span> <span class="o">=</span> <span class="n">seq</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">expiry_</span> <span class="o">=</span> <span class="n">expiry</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">next_</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="c1">//维护更新的链表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">class</span> <span class="nc">IARPUpdateDetectedList</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Data...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">IARPUpdate</span> <span class="o">*</span><span class="n">head_</span><span class="p">;</span>    <span class="c1">//链表头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">numUpdates_</span><span class="p">;</span>    <span class="c1">//链表内元素数量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 构造器...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">IARPUpdateDetectedList</span><span class="p">()</span> <span class="o">:</span> <span class="n">head_</span><span class="p">(</span><span class="nb">NULL</span><span class="p">),</span> <span class="n">numUpdates_</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 方法...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">void</span> <span class="nf">addUpdate</span><span class="p">(</span><span class="n">nsaddr_t</span> <span class="n">updateSrc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">seq</span><span class="p">,</span> <span class="n">Time</span> <span class="n">expiry</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="nf">findUpdate</span><span class="p">(</span><span class="n">nsaddr_t</span> <span class="n">updateSrc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">seq</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">purgeExpiredUpdates</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">freeList</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><hr>
<h5 id="3141-iarpupdatedetectedlist类内方法purgeexpiredupdates">3.1.4.1 IARPUpdateDetectedList类内方法purgeExpiredUpdates()</h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* 3. Remove all Updates for which the lifetime is expired. */</span>
</span></span><span class="line"><span class="cl"><span class="c1">//移除掉所有超时的更新信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span>
</span></span><span class="line"><span class="cl"><span class="n">IARPUpdateDetectedList</span><span class="o">::</span><span class="n">purgeExpiredUpdates</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//如果链表为空
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span><span class="n">numUpdates_</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>        <span class="c1">// Nothing to do
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// [case-1]: Leaving the 1st case(head_ case)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//从head-&gt;next开始判断
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">IARPUpdate</span> <span class="o">*</span><span class="n">prev</span><span class="p">,</span> <span class="o">*</span><span class="n">cur</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">prev</span> <span class="o">=</span> <span class="n">head_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">cur</span> <span class="o">=</span> <span class="n">head_</span><span class="o">-&gt;</span><span class="n">next_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">Time</span> <span class="n">now</span> <span class="o">=</span> <span class="n">Scheduler</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">clock</span><span class="p">();</span>     <span class="c1">//获取当前时间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">cur</span><span class="o">!=</span><span class="nb">NULL</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//如果超时
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">expiry_</span><span class="o">&lt;</span><span class="n">now</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// Delete the Update
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">prev</span><span class="o">-&gt;</span><span class="n">next_</span> <span class="o">=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">next_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">IARPUpdate</span> <span class="o">*</span><span class="n">toBeDeleted</span> <span class="o">=</span> <span class="n">cur</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">cur</span> <span class="o">=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">next_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">delete</span> <span class="n">toBeDeleted</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">numUpdates_</span><span class="o">--</span><span class="p">;</span>        <span class="c1">// Decrement Number of Links
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">prev</span> <span class="o">=</span> <span class="n">cur</span><span class="p">;</span>        <span class="c1">// Advance the Pointers
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">cur</span> <span class="o">=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">next_</span><span class="p">;</span>                
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// [case-2]: head_ case...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//再单独判断head
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span><span class="n">head_</span><span class="o">!=</span><span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">head_</span><span class="o">-&gt;</span><span class="n">expiry_</span><span class="o">&lt;</span><span class="n">now</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">IARPUpdate</span> <span class="o">*</span><span class="n">toBeDeleted</span> <span class="o">=</span> <span class="n">head_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">head_</span> <span class="o">=</span> <span class="n">head_</span><span class="o">-&gt;</span><span class="n">next_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">delete</span> <span class="n">toBeDeleted</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">numUpdates_</span><span class="o">--</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>    
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr>
<h4 id="315-iarpagent类内成员iarpperiodicupdatetimer类">3.1.5 IARPAgent类内成员IARPPeriodicUpdateTimer类</h4>
<p>该类规划IARP 更新频度</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* [SUB-SECTION-3.5]------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="cm"> * PERIODIC-UPDATE TIMER:- PERIODIC UPDATE XMISSION
</span></span></span><span class="line"><span class="cl"><span class="cm"> * -----------------------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">IARPPeriodicUpdateTimer</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Handler</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Data...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ZRPAgent</span> <span class="o">*</span><span class="n">agent_</span><span class="p">;</span>        <span class="c1">// 指向ZRP-Agent
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Event</span> <span class="n">intr_</span><span class="p">;</span>    
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">min_iarp_update_period_</span><span class="p">;</span>    <span class="c1">// Min-Update Interval 最小更新时间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">max_iarp_update_period_</span><span class="p">;</span>    <span class="c1">// Max-Update Interval 最大更新时间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Time</span> <span class="n">lastUpdateSent_</span><span class="p">;</span>        <span class="c1">// Last-Update Sent Time 上一次更新时间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Constructor...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">IARPPeriodicUpdateTimer</span><span class="p">(</span><span class="n">ZRPAgent</span><span class="o">*</span> <span class="n">agent</span><span class="p">)</span> <span class="o">:</span> <span class="n">agent_</span><span class="p">(</span><span class="n">agent</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="n">min_iarp_update_period_</span><span class="p">(</span><span class="n">DEFAULT_MIN_IARP_UPDATE_PERIOD</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="n">max_iarp_update_period_</span><span class="p">(</span><span class="n">DEFAULT_MAX_IARP_UPDATE_PERIOD</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="n">lastUpdateSent_</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Methods...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="kt">void</span> <span class="nf">handle</span><span class="p">(</span><span class="n">Event</span><span class="o">*</span><span class="p">);</span>          <span class="c1">// function handling the event
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="kt">void</span> <span class="nf">start</span><span class="p">(</span><span class="kt">double</span> <span class="n">thistime</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><hr>
<h5 id="3151-iarpperiodicupdatetimer类内方法start">3.1.5.1 IARPPeriodicUpdateTimer类内方法start()</h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* 
</span></span></span><span class="line"><span class="cl"><span class="cm">* 开启timer
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> 
</span></span><span class="line"><span class="cl"><span class="n">IARPPeriodicUpdateTimer</span><span class="o">::</span><span class="n">start</span><span class="p">(</span><span class="kt">double</span> <span class="n">thistime</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Scheduler</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">schedule</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">intr_</span><span class="p">,</span> <span class="n">thistime</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr>
<h5 id="3152--iarpperiodicupdatetimer类内方法handle">3.1.5.2  IARPPeriodicUpdateTimer类内方法handle()</h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* 2. Each time it sends IARP update IF NECESSARY(based on flag value). */</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 判断是否需要发送IARP update
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> 
</span></span><span class="line"><span class="cl"><span class="n">IARPPeriodicUpdateTimer</span><span class="o">::</span><span class="n">handle</span><span class="p">(</span><span class="n">Event</span><span class="o">*</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// [Check]: 如果当前半径为1 则取消发送 并规划下一次发送
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">radius_</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Schedule next update in min_iarp_update_period sec
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Scheduler</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">schedule</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">intr_</span><span class="p">,</span> <span class="n">min_iarp_update_period_</span><span class="p">);</span>    <span class="c1">// Unnecessary but for adaptive-case
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// [Task-1]: 检查更新是否是必要的
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// [Condition: (邻居表没有变化) AND (max_update_time is not elapsed)]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Time</span> <span class="n">now</span> <span class="o">=</span> <span class="n">Scheduler</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">clock</span><span class="p">();</span>     <span class="c1">// get the time
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">((</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">iarpAgt_</span><span class="p">).</span><span class="n">updateSendFlag_</span><span class="o">==</span><span class="n">FALSE</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">now</span><span class="o">-</span><span class="n">lastUpdateSent_</span><span class="p">)</span><span class="o">&lt;</span><span class="n">max_iarp_update_period_</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// [Log: MISS_IARP_UPDATE]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">Time</span> <span class="n">now</span> <span class="o">=</span> <span class="n">Scheduler</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">clock</span><span class="p">();</span> <span class="c1">// get the time
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">_%d_ [%6.6f] | MISS_IARP_UPDATE | No Neighbor Changes | -Tlsu %d | &#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">myaddr_</span><span class="p">,</span> <span class="n">now</span><span class="p">,</span> <span class="n">min_iarp_update_period_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">print_tables</span><span class="p">();</span> <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">                    <span class="p">}</span> <span class="c1">// [Log: End]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// schedule next update in min_iarp_update_period sec
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Scheduler</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">schedule</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">intr_</span><span class="p">,</span> <span class="n">min_iarp_update_period_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>        
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// [Task-2]:发送更新
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//判断邻居节点是否为空
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">((</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">ndpAgt_</span><span class="p">).</span><span class="n">neighborLst_</span><span class="p">.</span><span class="n">isEmpty</span><span class="p">()</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="p">{</span>    <span class="c1">// IF neighbor-list is NOT empty
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Packet</span><span class="o">*</span> <span class="n">p</span><span class="p">;</span>        <span class="c1">// 创建传送的包的指针临时变量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// [SubTask-1]: 创建包 (TTL should be &#39;Radius-1&#39;)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 包类型为IARP_UPDATE,IP地址为广播，跳数为当前半径-1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">pktUtil_</span><span class="p">).</span><span class="n">pkt_create</span><span class="p">(</span><span class="n">IARP_UPDATE</span><span class="p">,</span> <span class="n">IP_BROADCAST</span><span class="p">,</span> <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">radius_</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">        <span class="c1">// 在包中创建链路状态的空间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">pktUtil_</span><span class="p">).</span><span class="n">pkt_add_LSU_space</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">ndpAgt_</span><span class="p">).</span><span class="n">neighborLst_</span><span class="p">.</span><span class="n">numNeighbors_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//获取包内的zrp包头的地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">hdr_zrp</span> <span class="o">*</span><span class="n">hdrz</span> <span class="o">=</span> <span class="n">HDR_ZRP</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//加入邻居节点的信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// [SubTask-2]: Add Neighbor-Info(LSUs)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Neighbor</span> <span class="o">*</span><span class="n">cur</span> <span class="o">=</span> <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">ndpAgt_</span><span class="p">).</span><span class="n">neighborLst_</span><span class="p">.</span><span class="n">head_</span><span class="p">;</span>    
</span></span><span class="line"><span class="cl">        <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">ndpAgt_</span><span class="p">).</span><span class="n">neighborLst_</span><span class="p">.</span><span class="n">numNeighbors_</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">links_</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">src_</span> <span class="o">=</span> <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">myaddr_</span><span class="p">;</span>     <span class="c1">// My Address
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">links_</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dest_</span> <span class="o">=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">addr_</span><span class="p">;</span>        <span class="c1">// Neighbor&#39;s Address
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">links_</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">isUp_</span> <span class="o">=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">linkStatus_</span><span class="p">;</span>    <span class="c1">// Neighbor&#39;s Link-Status
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">cur</span> <span class="o">=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">next_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//更新包头内链路状态的数量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">numlinks_</span> <span class="o">=</span> <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">ndpAgt_</span><span class="p">).</span><span class="n">neighborLst_</span><span class="p">.</span><span class="n">numNeighbors_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// [SubTask-3]: 广播包
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">pktUtil_</span><span class="p">).</span><span class="n">pkt_broadcast</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mf">0.00</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// [Log: XMIT_IARP_UPDATE]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">Time</span> <span class="n">now</span> <span class="o">=</span> <span class="n">Scheduler</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">clock</span><span class="p">();</span> <span class="c1">// get the time
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">hdr_zrp</span> <span class="o">*</span><span class="n">hdrz</span> <span class="o">=</span> <span class="n">HDR_ZRP</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>           <span class="c1">// access ZRP part of pkt header
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                      <span class="n">hdr_ip</span> <span class="o">*</span><span class="n">hdrip</span> <span class="o">=</span> <span class="n">HDR_IP</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">_%d_ [%6.6f] | XMIT_IARP_UPDATE | -S %d -IS %d | -SEQ %d | &#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">myaddr_</span><span class="p">,</span> <span class="n">now</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">src_</span><span class="p">,</span> <span class="n">hdrip</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">(),</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">seq_</span><span class="p">);</span>    
</span></span><span class="line"><span class="cl">                    <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">pktUtil_</span><span class="p">).</span><span class="n">pkt_print_links</span><span class="p">(</span><span class="n">p</span><span class="p">);</span> <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">print_tables</span><span class="p">();</span> <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span> <span class="c1">// [Log: End]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// [SubTask-4]: IARP State Change... [For Control Flooding]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 加入Detected-Update Cache
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">iarpAgt_</span><span class="p">).</span><span class="n">upLst_</span><span class="p">.</span><span class="n">addUpdate</span><span class="p">(</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">src_</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">seq_</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                    <span class="n">now</span><span class="o">+</span><span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">iarpAgt_</span><span class="p">).</span><span class="n">updateLifeTime_</span><span class="p">);</span> <span class="c1">// Add into Detected-Update Cache
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//并将更新传送flag设置为false
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">iarpAgt_</span><span class="p">).</span><span class="n">updateSendFlag_</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>    <span class="c1">// Make the flag [FALSE]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//上一次更新设置为当前时间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">lastUpdateSent_</span> <span class="o">=</span> <span class="n">now</span><span class="p">;</span>                <span class="c1">// Store Last_Update_Send Time
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// [SubTask-5]: Drop DOWN Neighbors... [For NDP, removing DOWN Neighbors]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//移除掉LINKDOWN的邻居节点
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">ndpAgt_</span><span class="p">).</span><span class="n">neighborLst_</span><span class="p">.</span><span class="n">purgeDownNeighbors</span><span class="p">();</span>    <span class="c1">// Purge all DOWN Neighbors from NeighborList
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>    <span class="c1">// neighbor-list is EMPTY
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="k">if</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// [Log: IARP_ISOLATED_NODE ]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">Time</span> <span class="n">now</span> <span class="o">=</span> <span class="n">Scheduler</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">clock</span><span class="p">();</span> <span class="c1">// get the time
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">_%d_ [%6.6f] | IARP_ISOLATED_NODE | No Neighbors | &#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">myaddr_</span><span class="p">,</span> <span class="n">now</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">print_tables</span><span class="p">();</span> <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span> <span class="c1">// [Log: End]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>    
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// [Task-3]: Schedule next update in min_iarp_update_period sec
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Scheduler</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">schedule</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">intr_</span><span class="p">,</span> <span class="n">min_iarp_update_period_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr>
<h4 id="316--iarpagent类内成员iarpexpirationtimer类">3.1.6  IARPAgent类内成员IARPExpirationTimer类</h4>
<p>该类为过期检查定时器：- 用于链路状态和路由的过期</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* [SUB-SECTION-3.6]------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="cm"> * EXPIRATION-CHECK TIMER:- FOR EXPIRATION OF LINKSTATE AND ROUTES
</span></span></span><span class="line"><span class="cl"><span class="cm"> * -----------------------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">IARPExpirationTimer</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Handler</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">public</span><span class="o">:</span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// Data...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ZRPAgent</span> <span class="o">*</span><span class="n">agent_</span><span class="p">;</span>        <span class="c1">// 指向ZRP-Agent的指针
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Event</span> <span class="n">intr_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">expiration_check_period_</span><span class="p">;</span>    <span class="c1">// Expiration-Check-Interval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Constructor...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">IARPExpirationTimer</span><span class="p">(</span><span class="n">ZRPAgent</span><span class="o">*</span> <span class="n">agent</span><span class="p">)</span> <span class="o">:</span> <span class="n">agent_</span><span class="p">(</span><span class="n">agent</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="n">expiration_check_period_</span><span class="p">(</span><span class="n">DEFAULT_EXPIRATION_CHECK_PERIOD</span><span class="p">)</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Methods...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="kt">void</span> <span class="nf">handle</span><span class="p">(</span><span class="n">Event</span><span class="o">*</span><span class="p">);</span>          <span class="c1">// function handling the event
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="kt">void</span> <span class="nf">start</span><span class="p">(</span><span class="kt">double</span> <span class="n">thistime</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><hr>
<h5 id="3161-iarpexpirationtimer类的start方法">3.1.6.1 IARPExpirationTimer类的Start()方法</h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* 1. Starts the Timer. */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> 
</span></span><span class="line"><span class="cl"><span class="n">IARPExpirationTimer</span><span class="o">::</span><span class="n">start</span><span class="p">(</span><span class="kt">double</span> <span class="n">thistime</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="n">Scheduler</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">schedule</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">intr_</span><span class="p">,</span> <span class="n">thistime</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr>
<h5 id="3162-iarpexpirationtimer类的handle方法">3.1.6.2 IARPExpirationTimer类的handle()方法</h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* 2. Removes the EXPIRED link-state entries &amp; EXPIRED detected Updates periodically. */</span>
</span></span><span class="line"><span class="cl"><span class="c1">//定期删除过期的link-state entries
</span></span></span><span class="line"><span class="cl"><span class="c1">//定期删除过期的更新信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> 
</span></span><span class="line"><span class="cl"><span class="n">IARPExpirationTimer</span><span class="o">::</span><span class="n">handle</span><span class="p">(</span><span class="n">Event</span><span class="o">*</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// [Task-1]: 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Purge all expired Links from the Link-State List...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 从链接状态列表中清除所有过期链接...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// &amp; Purge all expired detected Updates from IARP Update List...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 从 IARP 更新列表中清除所有检测到的过期更新.    
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">numPurgedLinks</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">    <span class="n">numPurgedLinks</span> <span class="o">=</span> <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">iarpAgt_</span><span class="p">).</span><span class="n">lsLst_</span><span class="p">.</span><span class="n">purgeLinks</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">numPurgedLinks</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">iarpAgt_</span><span class="p">).</span><span class="n">buildRoutingTable</span><span class="p">();</span>      <span class="c1">// Rebuild Routing Table
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">iarpAgt_</span><span class="p">).</span><span class="n">upLst_</span><span class="p">.</span><span class="n">purgeExpiredUpdates</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// [Task-2]: schedule next expiration event
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Scheduler</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">schedule</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">intr_</span><span class="p">,</span> <span class="n">expiration_check_period_</span> <span class="p">);</span>    
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr>
<h4 id="317-iarpagent类内方法startup">3.1.7 IARPAgent类内方法startUp()</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* 1. Starting Timers &amp; Clearing Lists(Tables). */</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 开启Timer
</span></span></span><span class="line"><span class="cl"><span class="c1">// 清空链表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> 
</span></span><span class="line"><span class="cl"><span class="n">IARPAgent</span><span class="o">::</span><span class="n">startUp</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// [Task-1]: Start Timers...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">double</span> <span class="n">startUpJitter</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">PeriodicUpdateTimer_</span><span class="p">.</span><span class="n">start</span><span class="p">(</span><span class="n">startUpJitter</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">startUpJitter</span> <span class="o">=</span>  <span class="n">Random</span><span class="o">::</span><span class="n">uniform</span><span class="p">(</span><span class="n">startup_jitter_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">ExpirationTimer_</span><span class="p">.</span><span class="n">start</span><span class="p">(</span><span class="n">startUpJitter</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// [Task-2]: Clear all Lists...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">lsLst_</span><span class="p">.</span><span class="n">freeList</span><span class="p">();</span>    <span class="c1">// Link State List
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">pnLst_</span><span class="p">.</span><span class="n">freeList</span><span class="p">();</span>    <span class="c1">// Peripheral Node List
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">irLst_</span><span class="p">.</span><span class="n">freeList</span><span class="p">();</span>    <span class="c1">// Inner Route List
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">upLst_</span><span class="p">.</span><span class="n">freeList</span><span class="p">();</span>    <span class="c1">// Detected IARP_Update List
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><hr>
<h4 id="318-iarpagent类内方法buildroutingtable">3.1.8 IARPAgent类内方法buildRoutingTable()</h4>
<p>不是很理解这部分，需要之后重新检查</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* 2. Create Inner Route List based on Link State List. */</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 根据当前的链路状态去更新内部路由表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> 
</span></span><span class="line"><span class="cl"><span class="n">IARPAgent</span><span class="o">::</span><span class="n">buildRoutingTable</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// [Task-1]: Clear the existing Inner Route List &amp; Peirpheral Node List...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 清空已经存在的内部路由表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 清空已经存在的外围节点表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">irLst_</span><span class="p">.</span><span class="n">freeList</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">pnLst_</span><span class="p">.</span><span class="n">freeList</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// [Task-2]: Purge the Expired links &amp; DOWN links...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 清除过期的链路状态
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">lsLst_</span><span class="p">.</span><span class="n">purgeLinks</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// [Task-3]: Generate BFS tree from existing Link-State list &amp; store them into Inner Route List...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 从现有链路状态列表生成 BFS 树并将它们存储到内部路由列表中...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 在innerList里加入初始节点,生成头，头节点为自己的地址 跳数为0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">irLst_</span><span class="p">.</span><span class="n">addRoute</span><span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">myaddr_</span><span class="p">,</span> <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">myaddr_</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>    <span class="c1">// Adding First Entry [0 is IMPortant]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">InnerRoute</span> <span class="o">*</span><span class="n">curNode</span> <span class="o">=</span> <span class="n">irLst_</span><span class="p">.</span><span class="n">head_</span><span class="p">;</span>    <span class="c1">// We just added first Entry
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">numHops</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>    <span class="c1">// Intializing...[0 is IMPortant]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">do</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Scan the Link-State list...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 扫描当前Link-State链表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 获取当前的链路头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">LinkState</span> <span class="o">*</span><span class="n">curLink</span><span class="o">=</span><span class="n">lsLst_</span><span class="p">.</span><span class="n">head_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">InnerRoute</span> <span class="o">*</span><span class="n">dummyHandle</span><span class="p">;</span><span class="c1">// Needed for &#39;irLst_.findRoute()&#39;...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">int</span> <span class="n">flagFoundNewDest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//32bit地址 下一跳
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">nsaddr_t</span> <span class="n">newFoundDest</span><span class="p">,</span> <span class="n">nextHop</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//遍历链路状态表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">lsLst_</span><span class="p">.</span><span class="n">numLinks_</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//初始化数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">flagFoundNewDest</span><span class="o">=</span><span class="n">FALSE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">newFoundDest</span><span class="o">=-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">nextHop</span><span class="o">=-</span><span class="mi">1</span><span class="p">;</span>    
</span></span><span class="line"><span class="cl">            <span class="c1">// [SubTask-1]: Find New Destination...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span><span class="p">(</span><span class="n">curNode</span><span class="o">-&gt;</span><span class="n">addr_</span><span class="o">==</span><span class="n">curLink</span><span class="o">-&gt;</span><span class="n">src_</span><span class="p">)</span> <span class="p">{</span>        <span class="c1">// Found New Destination [Case-1]    
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">newFoundDest</span> <span class="o">=</span> <span class="n">curLink</span><span class="o">-&gt;</span><span class="n">dest_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">flagFoundNewDest</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>    
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span><span class="p">(</span><span class="n">curNode</span><span class="o">-&gt;</span><span class="n">addr_</span><span class="o">==</span><span class="n">curLink</span><span class="o">-&gt;</span><span class="n">dest_</span><span class="p">)</span> <span class="p">{</span>    <span class="c1">// Found New Destination [Case-2]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">newFoundDest</span> <span class="o">=</span> <span class="n">curLink</span><span class="o">-&gt;</span><span class="n">src_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">flagFoundNewDest</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// [SubTask-2]: Check if this destination has been detected before...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// 检查之前是否检测到此目的地...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// If [NO] then add new route entry...    
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// 如果不是 意味着新的路径节点
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span><span class="p">(</span><span class="n">flagFoundNewDest</span><span class="o">==</span><span class="n">TRUE</span> <span class="o">&amp;&amp;</span> <span class="n">irLst_</span><span class="p">.</span><span class="n">findRoute</span><span class="p">(</span><span class="n">newFoundDest</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dummyHandle</span><span class="p">)</span><span class="o">==</span><span class="n">FALSE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// Find numHops for Found Destination... [Here is WHY- Source&#39;s 0 value is IMPortant]    
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">numHops</span> <span class="o">=</span> <span class="n">curNode</span><span class="o">-&gt;</span><span class="n">numHops_</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// Find Next Hop for Found Destination...[2 cases-Neighbors and others]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">if</span><span class="p">(</span><span class="n">numHops</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">nextHop</span> <span class="o">=</span> <span class="n">newFoundDest</span><span class="p">;</span>        <span class="c1">// [Dest = Neighbor] So, [Nexthop = Neighbor]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">numHops</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">nextHop</span> <span class="o">=</span> <span class="n">curNode</span><span class="o">-&gt;</span><span class="n">nextHop_</span><span class="p">;</span>    <span class="c1">// [Dest = Others] So, [CurNode&#39;s route]    
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// Routes are added at the Tail in the list...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">irLst_</span><span class="p">.</span><span class="n">addRoute</span><span class="p">(</span><span class="n">newFoundDest</span><span class="p">,</span> <span class="n">nextHop</span><span class="p">,</span> <span class="n">curNode</span><span class="p">,</span> <span class="n">numHops</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// Check if it is a peripheral Node
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">if</span><span class="p">(</span><span class="n">numHops</span> <span class="o">==</span> <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">radius_</span><span class="p">)</span> <span class="p">{</span>    <span class="c1">// It&#39;s also a peripheral Node
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="k">if</span><span class="p">(</span><span class="n">pnLst_</span><span class="p">.</span><span class="n">findPerNode</span><span class="p">(</span><span class="n">newFoundDest</span><span class="p">)</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="n">pnLst_</span><span class="p">.</span><span class="n">addPerNode</span><span class="p">(</span><span class="n">newFoundDest</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">);</span>    <span class="c1">// Keep it &#39;coveredFlag=FALSE&#39; for IERP...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">curLink</span> <span class="o">=</span> <span class="n">curLink</span><span class="o">-&gt;</span><span class="n">next_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">curNode</span> <span class="o">=</span> <span class="n">curNode</span><span class="o">-&gt;</span><span class="n">next_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="n">curNode</span><span class="o">!=</span><span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr>
<h4 id="319-iarpagent类内方法addrouteinpacket">3.1.9 IARPAgent类内方法addRouteInPacket()</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* 3. Add Existing route in the packet. */</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 在数据包中添加现有的路由
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> 
</span></span><span class="line"><span class="cl"><span class="n">IARPAgent</span><span class="o">::</span><span class="n">addRouteInPacket</span><span class="p">(</span><span class="n">nsaddr_t</span> <span class="n">dest</span><span class="p">,</span> <span class="n">Packet</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//获取包的zrp包头指针
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">hdr_zrp</span> <span class="o">*</span><span class="n">hdrz</span> <span class="o">=</span> <span class="n">HDR_ZRP</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//定义临时存储InnerRoute的变量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">InnerRoute</span> <span class="o">*</span><span class="n">handleToIARPRoute</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">foundIARPRoute</span><span class="p">,</span> <span class="n">routeLen</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//在innerRoutelist查找的flag
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//在他的路由半径内查找
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">foundIARPRoute</span> <span class="o">=</span> <span class="n">irLst_</span><span class="p">.</span><span class="n">findRoute</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">handleToIARPRoute</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span><span class="n">foundIARPRoute</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">);</span>    <span class="c1">// Route Must be Found;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 如果路径被发现
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span><span class="n">foundIARPRoute</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//将路径长度+1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">routeLen</span> <span class="o">=</span> <span class="n">handleToIARPRoute</span><span class="o">-&gt;</span><span class="n">numHops_</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>        <span class="c1">// adding 1 for Source entry...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//在包内创造route的空间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">pktUtil_</span><span class="p">).</span><span class="n">pkt_add_ROUTE_space</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">routeLen</span><span class="p">);</span>    <span class="c1">// Allocate memory to store route
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 按照BFS添加内部路由
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">InnerRoute</span> <span class="o">*</span><span class="n">curNode</span> <span class="o">=</span> <span class="n">handleToIARPRoute</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="n">routeLen</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>    <span class="c1">// Copy route
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">route_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">curNode</span><span class="o">-&gt;</span><span class="n">addr_</span><span class="p">;</span>    
</span></span><span class="line"><span class="cl">            <span class="n">curNode</span> <span class="o">=</span> <span class="n">curNode</span><span class="o">-&gt;</span><span class="n">predecessor_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//确认包头的route[0]为自己
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//确认包头的route[len-1]为目标节点
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">assert</span><span class="p">(</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">route_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">myaddr_</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">        <span class="n">assert</span><span class="p">(</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">route_</span><span class="p">[</span><span class="n">routeLen</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">dest</span><span class="p">);</span>    
</span></span><span class="line"><span class="cl">        <span class="c1">//也设置route的长度
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">routelength_</span> <span class="o">=</span> <span class="n">routeLen</span><span class="p">;</span>    <span class="c1">// Also Route-length is set.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr>
<h4 id="319-iarpagent类内方法recv_iarp_updatepacket-p">3.1.9 IARPAgent类内方法recv_IARP_UPDATE(Packet* p)</h4>
<p>该方法为接收到IARP_UPDATE包下的调用</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* 4. 接收到 IARP Updates. */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> 
</span></span><span class="line"><span class="cl"><span class="n">IARPAgent</span><span class="o">::</span><span class="n">recv_IARP_UPDATE</span><span class="p">(</span><span class="n">Packet</span><span class="o">*</span> <span class="n">p</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// [Log: RECV_IARP_UPDATE]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">Time</span> <span class="n">now</span> <span class="o">=</span> <span class="n">Scheduler</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">clock</span><span class="p">();</span> <span class="c1">// get the time
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">hdr_zrp</span> <span class="o">*</span><span class="n">hdrz</span> <span class="o">=</span> <span class="n">HDR_ZRP</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>           <span class="c1">// access ZRP part of pkt header
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">hdr_ip</span> <span class="o">*</span><span class="n">hdrip</span> <span class="o">=</span> <span class="n">HDR_IP</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">_%d_ [%6.6f] | RECV_IARP_UPDATE | -S %d -IS %d | -SEQ %d | &#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">myaddr_</span><span class="p">,</span> <span class="n">now</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">src_</span><span class="p">,</span> <span class="n">hdrip</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">(),</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">seq_</span><span class="p">);</span>    
</span></span><span class="line"><span class="cl">                    <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">pktUtil_</span><span class="p">).</span><span class="n">pkt_print_links</span><span class="p">(</span><span class="n">p</span><span class="p">);</span> <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">print_tables</span><span class="p">();</span> <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span> <span class="c1">// [Log: End]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//获取包的zrp包头指针地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">hdr_zrp</span> <span class="o">*</span><span class="n">hdrz</span> <span class="o">=</span> <span class="n">HDR_ZRP</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 检查其是否已经被检测到
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 当检测到了 就丢弃该包(该upLst的更新生命周期取决于DEFAULT_UPDATE_LIFETIME)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// [Task-1]: Check if ??this update has been already detected??
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span><span class="n">upLst_</span><span class="p">.</span><span class="n">findUpdate</span><span class="p">(</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">src_</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">seq_</span><span class="p">)</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">pktUtil_</span><span class="p">).</span><span class="n">pkt_drop</span><span class="p">(</span><span class="n">p</span><span class="p">);</span><span class="c1">// Do Nothing and Drop the Packet
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span><span class="p">;</span>  <span class="c1">// Return back
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 对于数据包中的所有 LSU，更新链路状态列表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// [Task-2]: For all LSUs in the packet, Update the Link-State List...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Time</span> <span class="n">now</span> <span class="o">=</span> <span class="n">Scheduler</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">clock</span><span class="p">();</span> <span class="c1">// 获取当前的时间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">LinkState</span> <span class="o">*</span><span class="n">handleToFoundEntry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">changeLSLstFlag</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">numlinks_</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 如果当前LSU已经存在，那么更新他的过期时间和链路状态
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// [Case-1]: If [current LSU is present] then [Just update its Expiry time &amp; Link-State]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span><span class="p">(</span><span class="n">lsLst_</span><span class="p">.</span><span class="n">findLink</span><span class="p">(</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">links_</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">src_</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">links_</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dest_</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">handleToFoundEntry</span><span class="p">)</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="p">(</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">links_</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">isUp_</span> <span class="o">==</span> <span class="n">LINKDOWN</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">changeLSLstFlag</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>        <span class="c1">// One link is DOWN, Must update the Routing-Table
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">handleToFoundEntry</span><span class="o">-&gt;</span><span class="n">isup_</span> <span class="o">=</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">links_</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">isUp_</span><span class="p">;</span><span class="c1">// Update Attributes - Link-State
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">handleToFoundEntry</span><span class="o">-&gt;</span><span class="n">isup_</span> <span class="o">=</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">links_</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">isUp_</span><span class="p">;</span><span class="c1">// Update Attributes - Link-State
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">handleToFoundEntry</span><span class="o">-&gt;</span><span class="n">expiry_</span> <span class="o">=</span> <span class="n">now</span><span class="o">+</span><span class="n">linkLifeTime_</span><span class="p">;</span>  <span class="c1">// Update Attributes - Expiry Time
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 如果当前链路状况不存在
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// [Case-2]: If [current LSU is not present] then [Add LSU]    
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">lsLst_</span><span class="p">.</span><span class="n">addLink</span><span class="p">(</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">links_</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">src_</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">links_</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dest_</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">seq_</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">links_</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">isUp_</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">now</span><span class="o">+</span><span class="n">linkLifeTime_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">changeLSLstFlag</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>    <span class="c1">// At least One new link is added...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 如果检测到任何链路状况变更
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// [Task-3]: If any Change is detected in Link-State List, Then Build the Routing Table...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span><span class="n">changeLSLstFlag</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//先更新内部路由表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">buildRoutingTable</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//检查有什么合适的目的地可以发送
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">route_SendBuffer_pkt</span><span class="p">();</span>    <span class="c1">// Send Buffered packets...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 将其加入到更新的链表，之后查看该链表决定IARP是否更新
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// [Task-4]: Add this in the Detected IARP_UPDATE list...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">upLst_</span><span class="p">.</span><span class="n">addUpdate</span><span class="p">(</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">src_</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">seq_</span><span class="p">,</span> <span class="n">now</span><span class="o">+</span><span class="n">updateLifeTime_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//泛洪，将其提供给下一个节点，只要TIME TO LIVE没有为0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// [Task-5]: Forward the Same Update packet if ttl is not zero.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">hdr_ip</span> <span class="o">*</span><span class="n">hdrip</span> <span class="o">=</span> <span class="n">HDR_IP</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">hdr_cmn</span> <span class="o">*</span><span class="n">hdrc</span> <span class="o">=</span> <span class="n">HDR_CMN</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">ttl</span> <span class="o">=</span> <span class="n">hdrip</span><span class="o">-&gt;</span><span class="n">ttl</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>  <span class="c1">// Decrement the TTL value
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//先减TTL，再判断
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span><span class="n">ttl</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span><span class="c1">//TTL==0 丢弃
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">pktUtil_</span><span class="p">).</span><span class="n">pkt_drop</span><span class="p">(</span><span class="n">p</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">hdrc</span><span class="o">-&gt;</span><span class="n">direction</span><span class="p">()</span> <span class="o">=</span> <span class="n">hdr_cmn</span><span class="o">::</span><span class="n">DOWN</span><span class="p">;</span>    <span class="c1">// Set Fields
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//重新设置广播src_ip
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">hdrip</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">()</span> <span class="o">=</span> <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">myaddr_</span><span class="p">;</span>    <span class="c1">// Re-broadcaster
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//设置TIME TO LIVE
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">hdrip</span><span class="o">-&gt;</span><span class="n">ttl</span><span class="p">()</span> <span class="o">=</span> <span class="n">ttl</span><span class="p">;</span>            <span class="c1">// Decremented TTL value
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//再次泛洪,设置泛洪的flag=1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">forwarded_</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>         <span class="c1">// Setting Forwarding field
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">pktUtil_</span><span class="p">).</span><span class="n">pkt_broadcast</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mf">0.00</span><span class="p">);</span> <span class="c1">// broadcast pkt
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="k">if</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// [Log: XMIT_IARP_UPDATE]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">Time</span> <span class="n">now</span> <span class="o">=</span> <span class="n">Scheduler</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">clock</span><span class="p">();</span> <span class="c1">// get the time
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">_%d_ [%6.6f] | XMIT_IARP_UPDATE | -S %d -IS %d | -SEQ %d | &#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">myaddr_</span><span class="p">,</span> <span class="n">now</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">src_</span><span class="p">,</span> <span class="n">hdrip</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">(),</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">seq_</span><span class="p">);</span>    
</span></span><span class="line"><span class="cl">                    <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">pktUtil_</span><span class="p">).</span><span class="n">pkt_print_links</span><span class="p">(</span><span class="n">p</span><span class="p">);</span> <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">print_tables</span><span class="p">();</span> <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span> <span class="c1">// [Log: End]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr>
<h4 id="3110-iarpagent类内方法recv_iarp_datapacket-p">3.1.10 IARPAgent类内方法recv_IARP_DATA(Packet* p)</h4>
<p>该方法接受IARP_DATA</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* 5. Receiving IARP DATA(Local Traffic) [Either I need to route the pkt OR I am the DESTINATION]. */</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 接受IARP DATA
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> 
</span></span><span class="line"><span class="cl"><span class="n">IARPAgent</span><span class="o">::</span><span class="n">recv_IARP_DATA</span><span class="p">(</span><span class="n">Packet</span><span class="o">*</span> <span class="n">p</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">//获取IP
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">hdr_ip</span> <span class="o">*</span><span class="n">hdrip</span> <span class="o">=</span> <span class="n">HDR_IP</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="c1">//获取普通包头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">hdr_cmn</span> <span class="o">*</span><span class="n">hdrc</span> <span class="o">=</span> <span class="n">HDR_CMN</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="c1">//获取zrp包头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">hdr_zrp</span> <span class="o">*</span><span class="n">hdrz</span> <span class="o">=</span> <span class="n">HDR_ZRP</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// [Log: RECV_IARP_DATA]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">Time</span> <span class="n">now</span> <span class="o">=</span> <span class="n">Scheduler</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">clock</span><span class="p">();</span> <span class="c1">// get the time
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">_%d_ [%6.6f] | RECV_IARP_DATA | -S %d -D %d | -IS %d -ID %d | -SEQ %d | &#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">myaddr_</span><span class="p">,</span> <span class="n">now</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">src_</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">dest_</span><span class="p">,</span> <span class="n">hdrip</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">(),</span> <span class="n">hdrip</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                    <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">seq_</span><span class="p">);</span>    
</span></span><span class="line"><span class="cl">                    <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">pktUtil_</span><span class="p">).</span><span class="n">pkt_print_route</span><span class="p">(</span><span class="n">p</span><span class="p">);</span> <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">print_tables</span><span class="p">();</span> <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span> <span class="c1">// [Log: End]    
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//如果我是目标节点
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// [Case-1]: If I am the Destination...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">dest_</span> <span class="o">==</span> <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">myaddr_</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// [Log: RECV_CBR_DATA]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">Time</span> <span class="n">now</span> <span class="o">=</span> <span class="n">Scheduler</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">clock</span><span class="p">();</span> <span class="c1">// get the time
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">_%d_ [%6.6f] | RECV_CBR_DATA | -S %d -D %d | -SEQ %d -Type IARP -Delay %6.6f | &#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">myaddr_</span><span class="p">,</span> <span class="n">now</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">src_</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">dest_</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">seq_</span><span class="p">,</span> <span class="n">now</span><span class="o">-</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">pktsent_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">pktUtil_</span><span class="p">).</span><span class="n">pkt_print_route</span><span class="p">(</span><span class="n">p</span><span class="p">);</span> <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span> <span class="c1">// [Log: End]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// Delete the route info from the packet [Not Needed Anymore]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// (agent_-&gt;pktUtil_).pkt_free_ROUTE_space(p);// [Currently creates memory problems-Not implemented]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// copy ecnapsulated data back to this packet
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">hdrc</span><span class="o">-&gt;</span><span class="n">ptype</span><span class="p">()</span> <span class="o">=</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">enc_ptype_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">hdrc</span><span class="o">-&gt;</span><span class="n">direction</span><span class="p">()</span> <span class="o">=</span> <span class="n">hdr_cmn</span><span class="o">::</span><span class="n">UP</span><span class="p">;</span>     <span class="c1">// and is sent up
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">hdrc</span><span class="o">-&gt;</span><span class="n">addr_type_</span> <span class="o">=</span> <span class="n">NS_AF_NONE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">hdrc</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">()</span> <span class="o">-=</span> <span class="n">IP_HDR_LEN</span><span class="p">;</span>          <span class="c1">// cut the header
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">hdrip</span><span class="o">-&gt;</span><span class="n">dport</span><span class="p">()</span> <span class="o">=</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">enc_dport_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">hdrip</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">()</span> <span class="o">=</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">src_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">hdrip</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">()</span> <span class="o">=</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">dest_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">hdrip</span><span class="o">-&gt;</span><span class="n">ttl</span><span class="p">()</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">pktUtil_</span><span class="p">).</span><span class="n">pkt_send</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">myaddr_</span><span class="p">,</span> <span class="mf">0.00</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//　我不是目标节点，泛洪该数据包
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// [Case-2]: Forward the packet to Next Hop...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">routeindex_</span><span class="o">++</span><span class="p">;</span>    <span class="c1">// Move 1 hop (FORWARD) into the route(Should be My address)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">assert</span><span class="p">(</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">route_</span><span class="p">[</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">routeindex_</span><span class="p">]</span> <span class="o">==</span> <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">myaddr_</span><span class="p">);</span> <span class="n">assert</span><span class="p">(</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">routeindex_</span><span class="o">+</span><span class="mi">1</span> <span class="o">&lt;</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">routelength_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">hdrc</span><span class="o">-&gt;</span><span class="n">direction</span><span class="p">()</span> <span class="o">=</span> <span class="n">hdr_cmn</span><span class="o">::</span><span class="n">DOWN</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">hdrip</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">()</span> <span class="o">=</span> <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">myaddr_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">hdrip</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">()</span> <span class="o">=</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">route_</span><span class="p">[</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">routeindex_</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">pktUtil_</span><span class="p">).</span><span class="n">pkt_send</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">hdrip</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">(),</span> <span class="mf">0.00</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// [Log: XMIT_IARP_DATA]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">Time</span> <span class="n">now</span> <span class="o">=</span> <span class="n">Scheduler</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">clock</span><span class="p">();</span> <span class="c1">// get the time
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">_%d_ [%6.6f] | XMIT_IARP_DATA | -S %d -D %d | -IS %d -ID %d | -SEQ %d | &#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">myaddr_</span><span class="p">,</span> <span class="n">now</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">src_</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">dest_</span><span class="p">,</span> <span class="n">hdrip</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">(),</span> <span class="n">hdrip</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                    <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">seq_</span><span class="p">);</span>    
</span></span><span class="line"><span class="cl">                    <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">pktUtil_</span><span class="p">).</span><span class="n">pkt_print_route</span><span class="p">(</span><span class="n">p</span><span class="p">);</span> <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">print_tables</span><span class="p">();</span> <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span> <span class="c1">// [Log: End]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr>
<h4 id="3111-iarpagent类内方法print_tables">3.1.11 IARPAgent类内方法print_tables()</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* 6. Print all Tables. */</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 打印所有的表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> 
</span></span><span class="line"><span class="cl"><span class="n">IARPAgent</span><span class="o">::</span><span class="n">print_tables</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// [Task-1]: Print current Peripheral nodes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Peripheral Nodes:[ &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">pnLst_</span><span class="p">.</span><span class="n">numPerNodes_</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;EMPTY&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">PeripheralNode</span> <span class="o">*</span><span class="n">curPN</span> <span class="o">=</span> <span class="n">pnLst_</span><span class="p">.</span><span class="n">head_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">pnLst_</span><span class="p">.</span><span class="n">numPerNodes_</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;%d &#34;</span><span class="p">,</span> <span class="n">curPN</span><span class="o">-&gt;</span><span class="n">addr_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">curPN</span> <span class="o">=</span> <span class="n">curPN</span><span class="o">-&gt;</span><span class="n">next_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;]&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// [Task-2]: Print All Local Routes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Local Routes:[ &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">irLst_</span><span class="p">.</span><span class="n">numRoutes_</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;EMPTY&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">InnerRoute</span> <span class="o">*</span><span class="n">cur</span> <span class="o">=</span> <span class="n">irLst_</span><span class="p">.</span><span class="n">head_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">irLst_</span><span class="p">.</span><span class="n">numRoutes_</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;(%d:%d), &#34;</span><span class="p">,</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">addr_</span><span class="p">,</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">nextHop_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">cur</span> <span class="o">=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">next_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;]&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr>
<h2 id="4ierp-被动协议">4.IERP (被动协议)</h2>
<hr>
<h3 id="41-ierpagent类">4.1 IERPAgent类</h3>
<p>该类为ZRP的被动协议控制类</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* [SUB-SECTION-4.5]------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="cm"> * IERP AGENT:- INTER-ZONE ROUTING AGENT
</span></span></span><span class="line"><span class="cl"><span class="cm"> * -----------------------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">IERPAgent</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//私有方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">private</span><span class="o">:</span>    
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="n">addMyAddressToRoute</span><span class="p">(</span><span class="n">Packet</span> <span class="o">*</span><span class="n">pold</span><span class="p">,</span> <span class="n">Packet</span> <span class="o">*</span><span class="n">pnew</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">markCoveredPN</span><span class="p">(</span><span class="n">DetectedQuery</span> <span class="o">*</span><span class="n">queryInCache</span><span class="p">,</span> <span class="n">nsaddr_t</span> <span class="n">lastBC</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//公共方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Data...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ZRPAgent</span> <span class="o">*</span><span class="n">agent_</span><span class="p">;</span>      <span class="c1">//指向ZRPAgent的指针
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">brpXmitPolicy_</span><span class="p">;</span>    <span class="c1">//边界广播flag(0: UNICAST, 1: MULTICAST).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Lists...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DetectedQueryList</span> <span class="n">dqLst_</span><span class="p">;</span> <span class="c1">//检查到查询的表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">SentQueryList</span> <span class="n">sqLst_</span><span class="p">;</span>    <span class="c1">//它保留所有已发送的路由请求。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">queryLifeTime_</span><span class="p">;</span>        <span class="c1">// DEFAULT_QUERY_LIFETIME  默认询问生存时间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">routeLifeTime_</span><span class="p">;</span>        <span class="c1">// DEFAULT_ROUTE_LIFETIME  默认路由生存时间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">queryRetryTime_</span><span class="p">;</span>    <span class="c1">// DEFAULT_QUERY_RETRY_TIME 默认询问再发时间 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Timers...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//过期检查计时器：- 用于 IERP 请求的过期
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">IERPExpirationTimer</span> <span class="n">ExpirationTimer_</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">startup_jitter_</span><span class="p">;</span>    <span class="c1">// For starting the Timers
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 构造器...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">IERPAgent</span><span class="p">(</span><span class="n">ZRPAgent</span> <span class="o">*</span><span class="n">agent</span><span class="p">)</span> <span class="o">:</span> <span class="n">agent_</span><span class="p">(</span><span class="n">agent</span><span class="p">),</span> 
</span></span><span class="line"><span class="cl">        <span class="n">brpXmitPolicy_</span><span class="p">(</span><span class="n">DEFAULT_BRP_XMIT_POLICY</span><span class="p">),</span> 
</span></span><span class="line"><span class="cl">        <span class="n">queryLifeTime_</span><span class="p">(</span><span class="n">DEFAULT_QUERY_LIFETIME</span><span class="p">),</span> 
</span></span><span class="line"><span class="cl">        <span class="n">routeLifeTime_</span><span class="p">(</span><span class="n">DEFAULT_ROUTE_LIFETIME</span><span class="p">),</span>     
</span></span><span class="line"><span class="cl">        <span class="n">queryRetryTime_</span><span class="p">(</span><span class="n">DEFAULT_QUERY_RETRY_TIME</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="n">ExpirationTimer_</span><span class="p">(</span><span class="n">agent</span><span class="p">),</span> 
</span></span><span class="line"><span class="cl">        <span class="n">startup_jitter_</span><span class="p">(</span><span class="n">DEFAULT_STARTUP_JITTER</span><span class="p">)</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Methods...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">void</span> <span class="nf">startUp</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">recv_IERP_ROUTE_REQUEST_UNI</span><span class="p">(</span><span class="n">Packet</span><span class="o">*</span> <span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">recv_IERP_ROUTE_REQUEST_MC</span><span class="p">(</span><span class="n">Packet</span><span class="o">*</span> <span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">recv_IERP_ROUTE_REPLY</span><span class="p">(</span><span class="n">Packet</span><span class="o">*</span> <span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">recv_IERP_ROUTE_ERROR</span><span class="p">(</span><span class="n">Packet</span><span class="o">*</span> <span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">recv_IERP_DATA</span><span class="p">(</span><span class="n">Packet</span><span class="o">*</span> <span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="nf">addLinkStateFromRoute</span><span class="p">(</span><span class="n">nsaddr_t</span> <span class="o">*</span><span class="n">route</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="nf">removeLinkStateFromBrokenRoute</span><span class="p">(</span><span class="n">nsaddr_t</span> <span class="n">lnkSrc</span><span class="p">,</span> <span class="n">nsaddr_t</span> <span class="n">lnkDest</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">print_tables</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><hr>
<h4 id="411-ierpagent类内私有方法addmyaddresstoroute">4.1.1 IERPAgent类内私有方法addMyAddressToRoute()</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* 2. Appends own address to the route. */</span>
</span></span><span class="line"><span class="cl"><span class="c1">//将自己的地址附加到路由
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> 
</span></span><span class="line"><span class="cl"><span class="n">IERPAgent</span><span class="o">::</span><span class="n">addMyAddressToRoute</span><span class="p">(</span><span class="n">Packet</span> <span class="o">*</span><span class="n">pold</span><span class="p">,</span> <span class="n">Packet</span> <span class="o">*</span><span class="n">pnew</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//旧的zrp的包头的指针
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">hdr_zrp</span> <span class="o">*</span><span class="n">hdrzold</span> <span class="o">=</span> <span class="n">HDR_ZRP</span><span class="p">(</span><span class="n">pold</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//新的zrp的包头的指针
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">hdr_zrp</span> <span class="o">*</span><span class="n">hdrznew</span> <span class="o">=</span> <span class="n">HDR_ZRP</span><span class="p">(</span><span class="n">pnew</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//路由长度的临时变量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">routeLen</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//设置新的路有长度的变量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">routeLen</span> <span class="o">=</span> <span class="n">hdrzold</span><span class="o">-&gt;</span><span class="n">routelength_</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>    <span class="c1">// For My Address
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// [Task-1]: Allocate memory to store route
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 创建内部的存储空间 大小为routeLen
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">pktUtil_</span><span class="p">).</span><span class="n">pkt_add_ROUTE_space</span><span class="p">(</span><span class="n">pnew</span><span class="p">,</span> <span class="n">routeLen</span><span class="p">);</span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// [Task-2]: Copy 1st part of route
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//将旧的路由线路拷贝到新的空间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">hdrzold</span><span class="o">-&gt;</span><span class="n">routelength_</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>        
</span></span><span class="line"><span class="cl">        <span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">route_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdrzold</span><span class="o">-&gt;</span><span class="n">route_</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>    <span class="c1">// [&#39;0&#39; to &#39;hdrzold-&gt;routelength_ - 1&#39;]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 加入自己的地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// [Task-3]: Copy 2nd part of route
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">route_</span><span class="p">[</span><span class="n">routeLen</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">myaddr_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//修改路有的长度
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// [Task-4]: Update Route-Length
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">routelength_</span> <span class="o">=</span> <span class="n">routeLen</span><span class="p">;</span>    <span class="c1">// Also Route-length is set.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><hr>
<h4 id="412-ierpagent类内私有方法markcoveredpn">4.1.2 IERPAgent类内私有方法markCoveredPN()</h4>
<p>不是很明白该方法</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* 3. Marks all covered peripheral nodes based on Last bordercaster Info. */</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 根据 Last bordercaster Info 标记所有覆盖的外围节点。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> 
</span></span><span class="line"><span class="cl"><span class="n">IERPAgent</span><span class="o">::</span><span class="n">markCoveredPN</span><span class="p">(</span><span class="n">DetectedQuery</span> <span class="o">*</span><span class="n">queryInCache</span><span class="p">,</span> <span class="n">nsaddr_t</span> <span class="n">lastBC</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//周边节点的存储指针
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">PeripheralNode</span> <span class="o">*</span><span class="n">cur</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 将其指向检测查询缓存的外围节点的head
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">cur</span> <span class="o">=</span> <span class="p">(</span><span class="n">queryInCache</span><span class="o">-&gt;</span><span class="n">pnLst_</span><span class="p">).</span><span class="n">head_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// InnerRoute的临时变量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">InnerRoute</span> <span class="o">*</span><span class="n">handleToFoundRoute</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// flag
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">foundRouteFlag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="p">(</span><span class="n">queryInCache</span><span class="o">-&gt;</span><span class="n">pnLst_</span><span class="p">).</span><span class="n">numPerNodes_</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">foundRouteFlag</span> <span class="o">=</span> <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">iarpAgt_</span><span class="p">).</span><span class="n">irLst_</span><span class="p">.</span><span class="n">findRoute</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">addr_</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">handleToFoundRoute</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">foundRouteFlag</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>    <span class="c1">// Route to Peripheral node exists [It must exist]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span><span class="p">(</span><span class="n">handleToFoundRoute</span><span class="o">-&gt;</span><span class="n">nextHop_</span> <span class="o">==</span> <span class="n">lastBC</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">cur</span><span class="o">-&gt;</span><span class="n">coveredFlag_</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>    <span class="c1">// Mark this Node
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">cur</span> <span class="o">=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">next_</span><span class="p">;</span>    <span class="c1">// Advance the Pointer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr>
<h4 id="413-ierpagent类内成员detectedquerylist类">4.1.3 IERPAgent类内成员DetectedQueryList类</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">//检测到查询的单个存储类
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">class</span> <span class="nc">DetectedQuery</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Data...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">nsaddr_t</span> <span class="n">src_</span><span class="p">;</span>        <span class="c1">// 32 bits 源节点
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">nsaddr_t</span> <span class="n">dest_</span><span class="p">;</span>        <span class="c1">// 32 bits 目标节点
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">queryID_</span><span class="p">;</span>        <span class="c1">// Query ID 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Time</span> <span class="n">expiry_</span><span class="p">;</span>        <span class="c1">// Expiry of this detected Entry 超时时间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">PeripheralNodeList</span> <span class="n">pnLst_</span><span class="p">;</span>    <span class="c1">// Query-Coverage Info 查询覆盖信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//是否需要发送 或者 泛洪该查询信息的flag
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">querySentFlag_</span><span class="p">;</span>    <span class="c1">// Whether the query is Sent/Forwarded or Not
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">totalReplySent_</span><span class="p">;</span>  <span class="c1">//已为此查询发送了多少答复。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DetectedQuery</span> <span class="o">*</span><span class="n">next_</span><span class="p">;</span>     <span class="c1">// 指向下一个Query
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 构造方法...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DetectedQuery</span><span class="p">()</span> <span class="o">:</span> <span class="n">src_</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">dest_</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">queryID_</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">expiry_</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="n">querySentFlag_</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">totalReplySent_</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">next_</span><span class="p">(</span><span class="nb">NULL</span><span class="p">)</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">    <span class="n">DetectedQuery</span><span class="p">(</span><span class="n">nsaddr_t</span> <span class="n">src</span><span class="p">,</span> <span class="n">nsaddr_t</span> <span class="n">dest</span><span class="p">,</span> <span class="kt">int</span> <span class="n">queryID</span><span class="p">,</span> <span class="n">Time</span> <span class="n">expiry</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">PeripheralNodeList</span> <span class="o">*</span><span class="n">curPNLst</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">src_</span> <span class="o">=</span> <span class="n">src</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">dest_</span> <span class="o">=</span> <span class="n">dest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">queryID_</span> <span class="o">=</span> <span class="n">queryID</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">expiry_</span> <span class="o">=</span> <span class="n">expiry</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">querySentFlag_</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">next_</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">totalReplySent_</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">        <span class="c1">// Add peripheral node list...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//添加外围节点表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span><span class="p">(</span><span class="n">curPNLst</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span><span class="c1">// UNICAST CASE。单播
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//不做任何事情，不需要使用到覆盖节点的信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// Do Nothing [We wont use coverage info]...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>        <span class="c1">// MULTICAST CASE 广播
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// Copies the peripheral-node-list to &#39;pnLst&#39;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// 拷贝当前节点的外围节点表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">curPNLst</span><span class="o">-&gt;</span><span class="n">copyList</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pnLst_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">DetectedQueryList</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Data...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DetectedQuery</span> <span class="o">*</span><span class="n">head_</span><span class="p">;</span> <span class="c1">//查询信息的存储链表的头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">numQueries_</span><span class="p">;</span>    <span class="c1">//链表内元素
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 构造器...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DetectedQueryList</span><span class="p">()</span> <span class="o">:</span> <span class="n">head_</span><span class="p">(</span><span class="nb">NULL</span><span class="p">),</span> <span class="n">numQueries_</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 方法...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">void</span> <span class="nf">addQuery</span><span class="p">(</span><span class="n">nsaddr_t</span> <span class="n">src</span><span class="p">,</span> <span class="n">nsaddr_t</span> <span class="n">dest</span><span class="p">,</span> <span class="kt">int</span> <span class="n">queryID</span><span class="p">,</span> <span class="n">Time</span> <span class="n">expiry</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">PeripheralNodeList</span> <span class="o">*</span><span class="n">curPNLst</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="nf">findQuery</span><span class="p">(</span><span class="n">nsaddr_t</span> <span class="n">src</span><span class="p">,</span> <span class="n">nsaddr_t</span> <span class="n">dest</span><span class="p">,</span> <span class="kt">int</span> <span class="n">queryID</span><span class="p">,</span> <span class="n">DetectedQuery</span>
</span></span><span class="line"><span class="cl">        <span class="o">**</span><span class="n">handle</span><span class="p">);</span>    <span class="c1">// Returns TRUE or FALSE.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">void</span> <span class="nf">removeQuery</span><span class="p">(</span><span class="n">nsaddr_t</span> <span class="n">src</span><span class="p">,</span> <span class="n">nsaddr_t</span> <span class="n">dest</span><span class="p">,</span> <span class="kt">int</span> <span class="n">queryID</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">purgeExpiredQueries</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">freeList</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><hr>
<h5 id="4131-detectedquerylist类内方法addquery">4.1.3.1 DetectedQueryList类内方法addQuery()</h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* 1. Add Detected Query at the head. */</span>
</span></span><span class="line"><span class="cl"><span class="c1">//讲问询信息存储到问询链表中
</span></span></span><span class="line"><span class="cl"><span class="c1">//参数:原节点地址，目标节点地址，问询ID，超时时间，外围节点链表指针
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> 
</span></span><span class="line"><span class="cl"><span class="n">DetectedQueryList</span><span class="o">::</span><span class="n">addQuery</span><span class="p">(</span><span class="n">nsaddr_t</span> <span class="n">src</span><span class="p">,</span> <span class="n">nsaddr_t</span> <span class="n">dest</span><span class="p">,</span> <span class="kt">int</span> <span class="n">queryID</span><span class="p">,</span> <span class="n">Time</span> <span class="n">expiry</span><span class="p">,</span> <span class="n">PeripheralNodeList</span> <span class="o">*</span><span class="n">curPNLst</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">DetectedQuery</span> <span class="o">*</span><span class="n">newDQ</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DetectedQuery</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">queryID</span><span class="p">,</span> <span class="n">expiry</span><span class="p">,</span> <span class="n">curPNLst</span><span class="p">);</span>    <span class="c1">// Create a new Detected Query
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span><span class="n">newDQ</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>    <span class="c1">// Check for Allocation Error
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;### Memory Allocation Error in [DetectedQueryList::addQuery] ###&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//头插法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">newDQ</span><span class="o">-&gt;</span><span class="n">next_</span> <span class="o">=</span> <span class="n">head_</span><span class="p">;</span>    <span class="c1">// Made necessary Joinings            
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">head_</span> <span class="o">=</span> <span class="n">newDQ</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">numQueries_</span><span class="o">++</span><span class="p">;</span>        <span class="c1">// Increment Number of Links
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><h5 id="4132-detectedquerylist类内方法findquery">4.1.3.2 DetectedQueryList类内方法findQuery()</h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* 2. Find the Query and 1)send TRUE &amp; the handle OR 2)send FALSE. */</span>
</span></span><span class="line"><span class="cl"><span class="c1">//查找这个问询信息，返回查找结果
</span></span></span><span class="line"><span class="cl"><span class="c1">//查找这个问询信息，将其交给handle指针
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span> 
</span></span><span class="line"><span class="cl"><span class="n">DetectedQueryList</span><span class="o">::</span><span class="n">findQuery</span><span class="p">(</span><span class="n">nsaddr_t</span> <span class="n">src</span><span class="p">,</span> <span class="n">nsaddr_t</span> <span class="n">dest</span><span class="p">,</span> <span class="kt">int</span> <span class="n">queryID</span><span class="p">,</span> <span class="n">DetectedQuery</span> <span class="o">**</span><span class="n">handle</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">DetectedQuery</span> <span class="o">*</span><span class="n">cur</span><span class="p">;</span><span class="c1">//临时变量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">foundFlag</span><span class="p">;</span><span class="c1">//查找flag
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// [i&lt;numQueries_] condition takes care for EMPTY List case...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">cur</span> <span class="o">=</span> <span class="n">head_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">foundFlag</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//从头查找
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">numQueries_</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">src_</span> <span class="o">==</span> <span class="n">src</span> <span class="o">&amp;&amp;</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">dest_</span> <span class="o">==</span> <span class="n">dest</span> <span class="o">&amp;&amp;</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">queryID_</span> <span class="o">==</span> <span class="n">queryID</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">foundFlag</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">cur</span><span class="o">=</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">next_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">foundFlag</span><span class="p">)</span> <span class="p">{</span>        <span class="c1">// If Query is Found
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">*</span><span class="n">handle</span> <span class="o">=</span> <span class="n">cur</span><span class="p">;</span>    <span class="c1">// ...Return the handle of that Query
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>    <span class="c1">// ...Return Found = TRUE        
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>        <span class="c1">// Query is NOT found (returning FALSE)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><hr>
<h5 id="4133-detectedquerylist类内方法removequery">4.1.3.3 DetectedQueryList类内方法removeQuery()</h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* 3. Find the Query and Delete it. */</span>
</span></span><span class="line"><span class="cl"><span class="c1">//查找到问询并且删除
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> 
</span></span><span class="line"><span class="cl"><span class="n">DetectedQueryList</span><span class="o">::</span><span class="n">removeQuery</span><span class="p">(</span><span class="n">nsaddr_t</span> <span class="n">src</span><span class="p">,</span> <span class="n">nsaddr_t</span> <span class="n">dest</span><span class="p">,</span> <span class="kt">int</span> <span class="n">queryID</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//临时变量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DetectedQuery</span> <span class="o">*</span><span class="n">prev</span><span class="p">,</span> <span class="o">*</span><span class="n">cur</span><span class="p">,</span> <span class="o">*</span><span class="n">toBeDeleted</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 1.头节点需要删除
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// [Case-1]: first Node to Delete...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span><span class="n">head_</span><span class="o">!=</span><span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">head_</span><span class="o">-&gt;</span><span class="n">src_</span> <span class="o">==</span> <span class="n">src</span> <span class="o">&amp;&amp;</span> <span class="n">head_</span><span class="o">-&gt;</span><span class="n">dest_</span> <span class="o">==</span> <span class="n">dest</span> <span class="o">&amp;&amp;</span> <span class="n">head_</span><span class="o">-&gt;</span><span class="n">queryID_</span> <span class="o">==</span> <span class="n">queryID</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">toBeDeleted</span> <span class="o">=</span> <span class="n">head_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">head_</span> <span class="o">=</span> <span class="n">head_</span><span class="o">-&gt;</span><span class="n">next_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="n">toBeDeleted</span><span class="o">-&gt;</span><span class="n">pnLst_</span><span class="p">).</span><span class="n">freeList</span><span class="p">();</span>    <span class="c1">// It frees the memory
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">delete</span> <span class="n">toBeDeleted</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">numQueries_</span><span class="o">--</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 2.普通删除
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// [Case-2]: Normal Case...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">prev</span> <span class="o">=</span> <span class="n">head_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">cur</span> <span class="o">=</span> <span class="n">head_</span><span class="o">-&gt;</span><span class="n">next_</span><span class="p">;</span>    
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">numQueries_</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">src_</span> <span class="o">==</span> <span class="n">src</span> <span class="o">&amp;&amp;</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">dest_</span> <span class="o">==</span> <span class="n">dest</span> <span class="o">&amp;&amp;</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">queryID_</span> <span class="o">==</span> <span class="n">queryID</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">toBeDeleted</span> <span class="o">=</span> <span class="n">cur</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">prev</span><span class="o">-&gt;</span><span class="n">next_</span> <span class="o">=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">next_</span><span class="p">;</span>    <span class="c1">// Make necessary joinings
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="p">(</span><span class="n">toBeDeleted</span><span class="o">-&gt;</span><span class="n">pnLst_</span><span class="p">).</span><span class="n">freeList</span><span class="p">();</span>    <span class="c1">// It frees the memory
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">delete</span> <span class="n">toBeDeleted</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">numQueries_</span><span class="o">--</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">prev</span> <span class="o">=</span> <span class="n">cur</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">cur</span> <span class="o">=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">next_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr>
<h5 id="4133-detectedquerylist类内方法purgeexpiredqueries">4.1.3.3 DetectedQueryList类内方法purgeExpiredQueries()</h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* 4. Remove all Queries for which the lifetime is expired. */</span>
</span></span><span class="line"><span class="cl"><span class="c1">//删除所有的超出生命周期的问询
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> 
</span></span><span class="line"><span class="cl"><span class="n">DetectedQueryList</span><span class="o">::</span><span class="n">purgeExpiredQueries</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//1.如果链表为空
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span><span class="n">numQueries_</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>        <span class="c1">// Nothing to do
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 先抛开头节点
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// [case-1]: Leaving the 1st case(head_ case)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DetectedQuery</span> <span class="o">*</span><span class="n">prev</span><span class="p">,</span> <span class="o">*</span><span class="n">cur</span><span class="p">,</span> <span class="o">*</span><span class="n">toBeDeleted</span><span class="p">;</span><span class="c1">//临时变量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">prev</span> <span class="o">=</span> <span class="n">head_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">cur</span> <span class="o">=</span> <span class="n">head_</span><span class="o">-&gt;</span><span class="n">next_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Time</span> <span class="n">now</span> <span class="o">=</span> <span class="n">Scheduler</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">clock</span><span class="p">();</span><span class="c1">//获取当前时间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">cur</span><span class="o">!=</span><span class="nb">NULL</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">expiry_</span> <span class="o">&lt;</span> <span class="n">now</span><span class="p">)</span> <span class="p">{</span> <span class="c1">//超时则需要删除该问询
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">prev</span><span class="o">-&gt;</span><span class="n">next_</span> <span class="o">=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">next_</span><span class="p">;</span><span class="c1">//先断开删除节点
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">toBeDeleted</span> <span class="o">=</span> <span class="n">cur</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">cur</span> <span class="o">=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">next_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="n">toBeDeleted</span><span class="o">-&gt;</span><span class="n">pnLst_</span><span class="p">).</span><span class="n">freeList</span><span class="p">();</span>    <span class="c1">// It frees the memory
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">delete</span> <span class="n">toBeDeleted</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">numQueries_</span><span class="o">--</span><span class="p">;</span>            <span class="c1">// Decrement Number of Queries
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">prev</span> <span class="o">=</span> <span class="n">cur</span><span class="p">;</span>            <span class="c1">//指针前进
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">cur</span> <span class="o">=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">next_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//单独判断头节点
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// [case-2]: head_ case...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span><span class="n">head_</span><span class="o">!=</span><span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">head_</span><span class="o">-&gt;</span><span class="n">expiry_</span><span class="o">&lt;</span><span class="n">now</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">toBeDeleted</span> <span class="o">=</span> <span class="n">head_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">head_</span> <span class="o">=</span> <span class="n">head_</span><span class="o">-&gt;</span><span class="n">next_</span><span class="p">;</span>        <span class="c1">// Make necessary joinings
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="p">(</span><span class="n">toBeDeleted</span><span class="o">-&gt;</span><span class="n">pnLst_</span><span class="p">).</span><span class="n">freeList</span><span class="p">();</span>    <span class="c1">// It frees the memory
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">delete</span> <span class="n">toBeDeleted</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">numQueries_</span><span class="o">--</span><span class="p">;</span>            <span class="c1">// Decrement Number of Queries
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr>
<h5 id="4133-detectedquerylist类内方法freelist">4.1.3.3 DetectedQueryList类内方法freeList()</h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* 5. Frees the entire list. */</span>
</span></span><span class="line"><span class="cl"><span class="c1">//清空整个链表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> 
</span></span><span class="line"><span class="cl"><span class="n">DetectedQueryList</span><span class="o">::</span><span class="n">freeList</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">numQueries_</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">DetectedQuery</span> <span class="o">*</span><span class="n">toBeDeleted</span><span class="p">,</span> <span class="o">*</span><span class="n">cur</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">cur</span> <span class="o">=</span> <span class="n">head_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">numQueries_</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">toBeDeleted</span> <span class="o">=</span> <span class="n">cur</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">cur</span> <span class="o">=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">next_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="n">toBeDeleted</span><span class="o">-&gt;</span><span class="n">pnLst_</span><span class="p">).</span><span class="n">freeList</span><span class="p">();</span>    <span class="c1">// It frees the memory
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">delete</span> <span class="n">toBeDeleted</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">head_</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">numQueries_</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr>
<h4 id="414-ierpagent类内成员sentquerylist">4.1.4 IERPAgent类内成员SentQueryList()</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* [SUB-SECTION-4.2]------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="cm"> * SENT IERP-REQUEST:- SENT QUERIES CACHE
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 存储所有已经发送的Queries
</span></span></span><span class="line"><span class="cl"><span class="cm"> * -----------------------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="c1">//单个发送Query的info
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">class</span> <span class="nc">SentQuery</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Data...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">nsaddr_t</span> <span class="n">src_</span><span class="p">;</span>      <span class="c1">// 32 bits 送信地址 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">nsaddr_t</span> <span class="n">dest_</span><span class="p">;</span>      <span class="c1">// 32 bits 目标地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Time</span> <span class="n">expiry_</span><span class="p">;</span>        <span class="c1">// Expiry of this detected Entry 超时时间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">SentQuery</span> <span class="o">*</span><span class="n">next_</span><span class="p">;</span>    <span class="c1">// Pointer to Next Element 指向下一个的指针
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Constructors...    
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">SentQuery</span><span class="p">()</span> <span class="o">:</span> <span class="n">src_</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">dest_</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">expiry_</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">),</span> <span class="n">next_</span><span class="p">(</span><span class="nb">NULL</span><span class="p">)</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">    <span class="n">SentQuery</span><span class="p">(</span><span class="n">nsaddr_t</span> <span class="n">src</span><span class="p">,</span> <span class="n">nsaddr_t</span> <span class="n">dest</span><span class="p">,</span> <span class="n">Time</span> <span class="n">expiry</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">src_</span> <span class="o">=</span> <span class="n">src</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">dest_</span> <span class="o">=</span> <span class="n">dest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">expiry_</span> <span class="o">=</span> <span class="n">expiry</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">next_</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 存储已发送的Query的链表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">class</span> <span class="nc">SentQueryList</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Data...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">SentQuery</span> <span class="o">*</span><span class="n">head_</span><span class="p">;</span> <span class="c1">//头节点
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">numQueries_</span><span class="p">;</span> <span class="c1">//链表内部数量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 构造器...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">SentQueryList</span><span class="p">()</span> <span class="o">:</span> <span class="n">head_</span><span class="p">(</span><span class="nb">NULL</span><span class="p">),</span> <span class="n">numQueries_</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 方法...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">void</span> <span class="nf">addQuery</span><span class="p">(</span><span class="n">nsaddr_t</span> <span class="n">src</span><span class="p">,</span> <span class="n">nsaddr_t</span> <span class="n">dest</span><span class="p">,</span> <span class="n">Time</span> <span class="n">expiry</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="nf">findQuery</span><span class="p">(</span><span class="n">nsaddr_t</span> <span class="n">src</span><span class="p">,</span> <span class="n">nsaddr_t</span> <span class="n">dest</span><span class="p">,</span> <span class="n">SentQuery</span> <span class="o">**</span><span class="n">handle</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">removeQuery</span><span class="p">(</span><span class="n">nsaddr_t</span> <span class="n">src</span><span class="p">,</span> <span class="n">nsaddr_t</span> <span class="n">dest</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">purgeExpiredQueries</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">freeList</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><hr>
<h4 id="415-ierpagent类内成员ierpexpirationtimer">4.1.5 IERPAgent类内成员IERPExpirationTimer</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* [SUB-SECTION-4.4]------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="cm"> * EXPIRATION-CHECK TIMER:- FOR EXPIRATION OF IERP-REQUESTS
</span></span></span><span class="line"><span class="cl"><span class="cm"> * -----------------------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 它实现了一个计时器，该计时器定期检查 IERP 表中各种条目的到期时间。
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"> <span class="k">class</span> <span class="nc">IERPExpirationTimer</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Handler</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">public</span><span class="o">:</span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// Data...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">ZRPAgent</span> <span class="o">*</span><span class="n">agent_</span><span class="p">;</span>    <span class="c1">// ZRP-Agent指针
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">Event</span> <span class="n">intr_</span><span class="p">;</span>            
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">expiration_check_period_</span><span class="p">;</span><span class="c1">// 检查时间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 构造器...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">IERPExpirationTimer</span><span class="p">(</span><span class="n">ZRPAgent</span><span class="o">*</span> <span class="n">agent</span><span class="p">)</span> <span class="o">:</span> <span class="n">agent_</span><span class="p">(</span><span class="n">agent</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="n">expiration_check_period_</span><span class="p">(</span><span class="n">DEFAULT_EXPIRATION_CHECK_PERIOD</span><span class="p">)</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 方法...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="kt">void</span> <span class="nf">handle</span><span class="p">(</span><span class="n">Event</span><span class="o">*</span><span class="p">);</span>  <span class="c1">// function handling the event
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="kt">void</span> <span class="nf">start</span><span class="p">(</span><span class="kt">double</span> <span class="n">thistime</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><hr>
<h5 id="4151-ierpexpirationtimer类内方法start">4.1.5.1 IERPExpirationTimer类内方法start()</h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* 1. Starts the Timer, Called by startUp() method. */</span>
</span></span><span class="line"><span class="cl"><span class="c1">//该方法开启该定时器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> 
</span></span><span class="line"><span class="cl"><span class="n">IERPExpirationTimer</span><span class="o">::</span><span class="n">start</span><span class="p">(</span><span class="kt">double</span> <span class="n">thistime</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Scheduler</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">schedule</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">intr_</span><span class="p">,</span> <span class="n">thistime</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr>
<h5 id="4151-ierpexpirationtimer类内方法handle">4.1.5.1 IERPExpirationTimer类内方法handle()</h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* 2. Purge all expired Queries/Routes. */</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 该方法定时清除所有超市的root或者Query
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span>
</span></span><span class="line"><span class="cl"><span class="n">IERPExpirationTimer</span><span class="o">::</span><span class="n">handle</span><span class="p">(</span><span class="n">Event</span><span class="o">*</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// [Task-1]: Purge all expired Queries from the Query-Detect(/Sent) List...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//         &amp; Purge all Outer Routes from Outer-Route List...    
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">ierpAgt_</span><span class="p">).</span><span class="n">dqLst_</span><span class="p">.</span><span class="n">purgeExpiredQueries</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">ierpAgt_</span><span class="p">).</span><span class="n">sqLst_</span><span class="p">.</span><span class="n">purgeExpiredQueries</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 调用zrpAgent内的sendBuf中的清除超时包的方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">sendBuf_</span><span class="p">).</span><span class="n">purgeExpiredPackets</span><span class="p">();</span>    <span class="c1">// For ZRP agent
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// [Task-2]: schedule next expiration event
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Scheduler</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">schedule</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">intr_</span><span class="p">,</span> <span class="n">expiration_check_period_</span> <span class="p">);</span>    
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr>
<h4 id="416-ierpagent类内方法startup">4.1.6 IERPAgent类内方法startUp()</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">//该方法被ZrpAgent::startUp()方法调用
</span></span></span><span class="line"><span class="cl"><span class="c1">//启动一系列关于IEZRPAgent相关的定时器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> 
</span></span><span class="line"><span class="cl"><span class="n">IERPAgent</span><span class="o">::</span><span class="n">startUp</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// [Task-1]: Start Timers...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">double</span> <span class="n">startUpJitter</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">startUpJitter</span> <span class="o">=</span>  <span class="n">Random</span><span class="o">::</span><span class="n">uniform</span><span class="p">(</span><span class="n">startup_jitter_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">ExpirationTimer_</span><span class="p">.</span><span class="n">start</span><span class="p">(</span><span class="n">startUpJitter</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// [Task-2]: Clear all Lists...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">dqLst_</span><span class="p">.</span><span class="n">freeList</span><span class="p">();</span>    <span class="c1">// Detected-Query List
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">sqLst_</span><span class="p">.</span><span class="n">purgeExpiredQueries</span><span class="p">();</span>    <span class="c1">// Sent-Query List
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><hr>
<h4 id="417-ierpagent类内方法-recv_ierp_route_request_uni">4.1.7 IERPAgent类内方法 recv_IERP_ROUTE_REQUEST_UNI()</h4>
<p>当节点收到路由请求消息时调用它。在收到路由请求时</p>
<p>1.它将查询添加到检测到的查询表中</p>
<p>2.如果节点本身是预期目的地，那么它会创建一个“ROUTE_REPLY”并将其发送回路由请求发起者。</p>
<p>3.如果目的地位于节点的区域中，则它向目的地单播路由请求。</p>
<p>4.节点通过以下步骤对查询进行边界广播</p>
<p>    4.1如果在此之前收到此查询，则什么都不做并返回</p>
<p>    4.2它生成一个邻居集，通过它可以到达所有外围节点。 – 它将查询转发给所有这些邻居。     [多条消息]</p>
<p>不是很了解广播Query的时候的那个NbList如何添加的</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* 4. Receiving IERP-route-request. [Unicast Case] */</span>
</span></span><span class="line"><span class="cl"><span class="c1">//接收 IERP 路由请求。 [单播案例]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> 
</span></span><span class="line"><span class="cl"><span class="n">IERPAgent</span><span class="o">::</span><span class="n">recv_IERP_ROUTE_REQUEST_UNI</span><span class="p">(</span><span class="n">Packet</span><span class="o">*</span> <span class="n">p</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">hdr_zrp</span> <span class="o">*</span><span class="n">hdrz</span> <span class="o">=</span> <span class="n">HDR_ZRP</span><span class="p">(</span><span class="n">p</span><span class="p">);</span><span class="c1">//获取zrp包头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">hdr_ip</span> <span class="o">*</span><span class="n">hdrip</span> <span class="o">=</span> <span class="n">HDR_IP</span><span class="p">(</span><span class="n">p</span><span class="p">);</span><span class="c1">//获取IP包头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="k">if</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// [Log: RECV_IERP_REQUEST]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="k">if</span><span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">myaddr_</span> <span class="o">!=</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">src_</span><span class="p">)</span> <span class="p">{</span>    <span class="c1">// Only Non-source case...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">Time</span> <span class="n">now</span> <span class="o">=</span> <span class="n">Scheduler</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">clock</span><span class="p">();</span> <span class="c1">// get the time
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">_%d_ [%6.6f] | RECV_IERP_REQUEST | -S %d -D %d | -IS %d -ID %d | -QID %d | &#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">myaddr_</span><span class="p">,</span> <span class="n">now</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">src_</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">dest_</span><span class="p">,</span> <span class="n">hdrip</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">(),</span> <span class="n">hdrip</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                    <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">queryID_</span><span class="p">);</span>    
</span></span><span class="line"><span class="cl">                    <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">pktUtil_</span><span class="p">).</span><span class="n">pkt_print_route</span><span class="p">(</span><span class="n">p</span><span class="p">);</span> <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">print_tables</span><span class="p">();</span> <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span> <span class="c1">// [Log: End]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// [CommonTask]: Check if this is a new query?? If Yes, Add this Query to the Cache
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 检查是不是新的Query消息，如果是的话将它加入到DetectedQueryList中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Time</span> <span class="n">now</span> <span class="o">=</span> <span class="n">Scheduler</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">clock</span><span class="p">();</span> <span class="c1">//获取当前时间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DetectedQuery</span> <span class="o">*</span><span class="n">handleToFoundDQ</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span><span class="c1">//临时变量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">foundQueryFlag</span><span class="p">;</span><span class="c1">//查询flag
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//先检查DetectedQueryList有没有当前Query
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">foundQueryFlag</span> <span class="o">=</span> <span class="n">dqLst_</span><span class="p">.</span><span class="n">findQuery</span><span class="p">(</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">src_</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">dest_</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">queryID_</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">handleToFoundDQ</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">foundQueryFlag</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span><span class="c1">//查询到该Query在当前链表中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//如果该Query的地址不是
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span><span class="p">(</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">dest_</span> <span class="o">!=</span> <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">myaddr_</span><span class="p">)</span> <span class="p">{</span><span class="c1">// Need to send multiple replies if I am dest.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">pktUtil_</span><span class="p">).</span><span class="n">pkt_drop</span><span class="p">(</span><span class="n">p</span><span class="p">);</span> <span class="c1">//丢弃该包
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">return</span><span class="p">;</span><span class="c1">//什么也不做
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// For Control Flooding //否则将其加入DetectedQueryList
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">dqLst_</span><span class="p">.</span><span class="n">addQuery</span><span class="p">(</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">src_</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">dest_</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">queryID_</span><span class="p">,</span> <span class="n">now</span><span class="o">+</span><span class="n">queryLifeTime_</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// [Task-1]: If I am the Destination [Create a ROUTE-REPLY(New Packet) and Send it back]]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 如果我是目标节点，创建一个ROUTE-REPLY包并且发送他
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">dest_</span> <span class="o">==</span> <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">myaddr_</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 检查已发送了多少回复。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// [SubTask-0]: Check how many replies have been sent.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">DetectedQuery</span> <span class="o">*</span><span class="n">handleToFoundDQ</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span><span class="c1">//临时
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">int</span> <span class="n">foundQueryFlag</span><span class="p">;</span><span class="c1">//查找flag
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">foundQueryFlag</span> <span class="o">=</span> <span class="n">dqLst_</span><span class="p">.</span><span class="n">findQuery</span><span class="p">(</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">src_</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">dest_</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">queryID_</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">handleToFoundDQ</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">assert</span><span class="p">(</span><span class="n">foundQueryFlag</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//如果该Query内的最大回复数目超过默认的最大回复数量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span><span class="p">(</span><span class="n">handleToFoundDQ</span><span class="o">-&gt;</span><span class="n">totalReplySent_</span> <span class="o">&gt;=</span> <span class="n">DEFAULT_MAX_IERP_REPLY</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//不需要发送太多回复
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">return</span><span class="p">;</span> <span class="c1">// No more replies should be sent.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//先++回复，回复会在下面的代码中创建
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">handleToFoundDQ</span><span class="o">-&gt;</span><span class="n">totalReplySent_</span><span class="o">++</span><span class="p">;</span>    <span class="c1">// Reply is sent in below code.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// [SubTask-1]: Create a IERP_REPLY packet [&#39;hdrz-&gt;routelength_+1&#39;: My address needs to be added]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//创建一个IERP_REPLY包，内部的路由长度+1，并添加上自己的地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Packet</span> <span class="o">*</span><span class="n">pnew</span> <span class="o">=</span> <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">pktUtil_</span><span class="p">).</span><span class="n">pkt_create</span><span class="p">(</span><span class="n">IERP_REPLY</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">dest_</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">routelength_</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">addMyAddressToRoute</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">pnew</span><span class="p">);</span>    <span class="c1">// Add My address to the route
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// [SubTask-2]: Set Parameters...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 设定参数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">hdr_zrp</span> <span class="o">*</span><span class="n">hdrznew</span> <span class="o">=</span> <span class="n">HDR_ZRP</span><span class="p">(</span><span class="n">pnew</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">src_</span> <span class="o">=</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">src_</span><span class="p">;</span>  <span class="c1">// Identification fields at Sender of the Query
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">dest_</span> <span class="o">=</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">dest_</span><span class="p">;</span> <span class="c1">// Identification fields at Sender of the Query
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">seq_</span> <span class="o">=</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">seq_</span><span class="p">;</span>   <span class="c1">// Identification fields at Sender of the Query
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">queryID_</span> <span class="o">=</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">queryID_</span><span class="p">;</span> <span class="c1">// Identification fields at Sender of the Query
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">routeindex_</span> <span class="o">=</span> <span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">routelength_</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span><span class="c1">// My_address in the route
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// [SubTask-3]: Send the Packet
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//发送包
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">hdr_ip</span> <span class="o">*</span><span class="n">hdripnew</span> <span class="o">=</span> <span class="n">HDR_IP</span><span class="p">(</span><span class="n">pnew</span><span class="p">);</span> <span class="c1">//读取IP头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">hdripnew</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">()</span> <span class="o">=</span> <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">myaddr_</span><span class="p">;</span><span class="c1">//将IP发送地址设置为自己
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//将目标地址设置为Route的前一个路由
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">hdripnew</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">()</span> <span class="o">=</span> <span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">route_</span><span class="p">[</span><span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">routeindex_</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span><span class="c1">// Previous Hop
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">pktUtil_</span><span class="p">).</span><span class="n">pkt_send</span><span class="p">(</span><span class="n">pnew</span><span class="p">,</span> <span class="n">hdripnew</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">(),</span> <span class="mf">0.00</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// [Log: XMIT_IERP_REPLY]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">Time</span> <span class="n">now</span> <span class="o">=</span> <span class="n">Scheduler</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">clock</span><span class="p">();</span> <span class="c1">// get the time
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">_%d_ [%6.6f] | XMIT_IERP_REPLY | -S %d -D %d | -IS %d -ID %d | -QID %d | &#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">myaddr_</span><span class="p">,</span> <span class="n">now</span><span class="p">,</span> <span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">src_</span><span class="p">,</span> <span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">dest_</span><span class="p">,</span> <span class="n">hdripnew</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                    <span class="n">hdripnew</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">(),</span> <span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">queryID_</span><span class="p">);</span>    
</span></span><span class="line"><span class="cl">                    <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">pktUtil_</span><span class="p">).</span><span class="n">pkt_print_route</span><span class="p">(</span><span class="n">pnew</span><span class="p">);</span> <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">print_tables</span><span class="p">();</span> <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span> <span class="c1">// [Log: End]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 监听回复
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// [SubTask-4]: Snooping the replies.. Adding this info into topology table.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">int</span> <span class="n">routingTableUpdatedFlag</span><span class="o">=</span><span class="n">FALSE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">routingTableUpdatedFlag</span> <span class="o">=</span> <span class="n">addLinkStateFromRoute</span><span class="p">(</span><span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">route_</span><span class="p">,</span> <span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">routelength_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">routingTableUpdatedFlag</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">route_SendBuffer_pkt</span><span class="p">();</span>    <span class="c1">// Send Buffered packets...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// [SubTask-5]: Drop the original Packet 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">pktUtil_</span><span class="p">).</span><span class="n">pkt_drop</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>    
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//如果该目标节点在自己的范围内，单播到目标节点
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// [Task-2]: If Destination lies in My Zone.. [Unicast the request to Destination]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">InnerRoute</span> <span class="o">*</span><span class="n">handleToFoundRoute</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span><span class="c1">//临时变量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">foundRouteFlag</span><span class="p">,</span> <span class="n">alreadySentNb</span><span class="o">=-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//从内部路径表内查找目标节点，如果查找到则将其给handle
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">foundRouteFlag</span> <span class="o">=</span> <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">iarpAgt_</span><span class="p">).</span><span class="n">irLst_</span><span class="p">.</span><span class="n">findRoute</span><span class="p">(</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">dest_</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">handleToFoundRoute</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//如果查找到了区域内节点
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span><span class="n">foundRouteFlag</span> <span class="o">==</span> <span class="n">TRUE</span> <span class="o">&amp;&amp;</span> <span class="n">handleToFoundRoute</span><span class="o">-&gt;</span><span class="n">nextHop_</span> <span class="o">!=</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">lastbc_</span><span class="p">)</span> <span class="p">{</span>    <span class="c1">// Found Route in Zone
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// [SubTask-1]: Create a packet//创建包
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">hdr_ip</span> <span class="o">*</span><span class="n">hdrip</span> <span class="o">=</span> <span class="n">HDR_IP</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">ttl</span> <span class="o">=</span> <span class="n">hdrip</span><span class="o">-&gt;</span><span class="n">ttl</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>    <span class="c1">// Reducing the TTL value
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Packet</span> <span class="o">*</span><span class="n">pnew</span> <span class="o">=</span> <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">pktUtil_</span><span class="p">).</span><span class="n">pkt_create</span><span class="p">(</span><span class="n">IERP_REQUEST</span><span class="p">,</span> <span class="n">handleToFoundRoute</span><span class="o">-&gt;</span><span class="n">nextHop_</span><span class="p">,</span> <span class="n">ttl</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">addMyAddressToRoute</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">pnew</span><span class="p">);</span>    <span class="c1">// Add My address to the route
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// [SubTask-2]: Set Parameters...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">hdr_zrp</span> <span class="o">*</span><span class="n">hdrznew</span> <span class="o">=</span> <span class="n">HDR_ZRP</span><span class="p">(</span><span class="n">pnew</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">src_</span> <span class="o">=</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">src_</span><span class="p">;</span>    <span class="c1">// Identification fields at Sender of the Query
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">dest_</span> <span class="o">=</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">dest_</span><span class="p">;</span>    <span class="c1">// Identification fields at Sender of the Query
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">seq_</span> <span class="o">=</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">seq_</span><span class="p">;</span>    <span class="c1">// Identification fields at Sender of the Query
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">queryID_</span> <span class="o">=</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">queryID_</span><span class="p">;</span><span class="c1">// Identification fields at Sender of the Query
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">lastbc_</span> <span class="o">=</span> <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">myaddr_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">routeindex_</span> <span class="o">=</span> <span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">routelength_</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>    <span class="c1">// My_address in the route [Just Added b4]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// [SubTask-3]: Send the Packet...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">hdr_ip</span> <span class="o">*</span><span class="n">hdripnew</span> <span class="o">=</span> <span class="n">HDR_IP</span><span class="p">(</span><span class="n">pnew</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">hdripnew</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">()</span> <span class="o">=</span> <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">myaddr_</span><span class="p">;</span>    
</span></span><span class="line"><span class="cl">            <span class="n">hdripnew</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">()</span> <span class="o">=</span> <span class="n">handleToFoundRoute</span><span class="o">-&gt;</span><span class="n">nextHop_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">pktUtil_</span><span class="p">).</span><span class="n">pkt_send</span><span class="p">(</span><span class="n">pnew</span><span class="p">,</span> <span class="n">handleToFoundRoute</span><span class="o">-&gt;</span><span class="n">nextHop_</span><span class="p">,</span> <span class="mf">0.00</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">alreadySentNb</span> <span class="o">=</span> <span class="n">handleToFoundRoute</span><span class="o">-&gt;</span><span class="n">nextHop_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// [Log: XMIT_IERP_REQUEST]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">Time</span> <span class="n">now</span> <span class="o">=</span> <span class="n">Scheduler</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">clock</span><span class="p">();</span> <span class="c1">// get the time
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">_%d_ [%6.6f] | XMIT_IERP_REQUEST | -S %d -D %d | -IS %d -ID %d | -QID %d |&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">myaddr_</span><span class="p">,</span> <span class="n">now</span><span class="p">,</span> <span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">src_</span><span class="p">,</span> <span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">dest_</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                    <span class="n">hdripnew</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">(),</span> <span class="n">hdripnew</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">(),</span> <span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">queryID_</span><span class="p">);</span>    
</span></span><span class="line"><span class="cl">                    <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">pktUtil_</span><span class="p">).</span><span class="n">pkt_print_route</span><span class="p">(</span><span class="n">pnew</span><span class="p">);</span> <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">print_tables</span><span class="p">();</span> <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span> <span class="c1">// [Log: End]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//广播该Query
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// [Task-3]: Bordercast The Query...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// [SubTask-1]: Bordercast it(Find all Next-Hop neighbors to  un-covered-perpheral-nodes)...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Bordercast it（找到未覆盖外围节点的所有下一跳邻居）...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">NeighborList</span> <span class="n">NbLst</span><span class="p">;</span> <span class="c1">// Temporary list of query-forwarders
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">PeripheralNode</span> <span class="o">*</span><span class="n">curPN</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">handleToFoundRoute</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">foundRouteFlag</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">curPN</span> <span class="o">=</span> <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">iarpAgt_</span><span class="p">).</span><span class="n">pnLst_</span><span class="p">.</span><span class="n">head_</span><span class="p">;</span><span class="c1">// Fetch PN-list from IARP
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//遍历循环查找周边节点链表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">iarpAgt_</span><span class="p">).</span><span class="n">pnLst_</span><span class="p">.</span><span class="n">numPerNodes_</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span><span class="c1">// For all Peripheral Nodes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//将周围节点的地址放到内部路由表内查找，并获取查找的Flag
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">foundRouteFlag</span> <span class="o">=</span> <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">iarpAgt_</span><span class="p">).</span><span class="n">irLst_</span><span class="p">.</span><span class="n">findRoute</span><span class="p">(</span><span class="n">curPN</span><span class="o">-&gt;</span><span class="n">addr_</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">handleToFoundRoute</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//如果查找到了
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span><span class="p">(</span><span class="n">foundRouteFlag</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>    <span class="c1">// Add these Neighbors into List
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="kt">int</span> <span class="n">foundNbFlag</span><span class="p">;</span><span class="c1">//定义查找邻居节点的flag
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">Neighbor</span> <span class="o">*</span><span class="n">handleToFoundNb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="c1">// Do Not add Same Neighbors
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//将查找到的内部路由的下一条丢到邻居节点内查询
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">foundNbFlag</span> <span class="o">=</span> <span class="n">NbLst</span><span class="p">.</span><span class="n">findNeighbor</span><span class="p">(</span><span class="n">handleToFoundRoute</span><span class="o">-&gt;</span><span class="n">nextHop_</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">handleToFoundNb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="p">(</span><span class="n">foundNbFlag</span> <span class="o">==</span> <span class="n">FALSE</span>                     <span class="c1">// Not already added
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">&amp;&amp;</span> <span class="n">handleToFoundRoute</span><span class="o">-&gt;</span><span class="n">nextHop_</span> <span class="o">!=</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">lastbc_</span>     <span class="c1">// Not Last BorderCaster
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">&amp;&amp;</span> <span class="n">handleToFoundRoute</span><span class="o">-&gt;</span><span class="n">nextHop_</span> <span class="o">!=</span> <span class="n">alreadySentNb</span>    <span class="c1">// Not already sent above &amp; No loop
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">pktUtil_</span><span class="p">).</span><span class="n">pkt_AmIOnTheRoute</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">handleToFoundRoute</span><span class="o">-&gt;</span><span class="n">nextHop_</span><span class="p">)</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// Last-2 args-doesnt matter
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">NbLst</span><span class="p">.</span><span class="n">addNeighbor</span><span class="p">(</span><span class="n">handleToFoundRoute</span><span class="o">-&gt;</span><span class="n">nextHop_</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">LINKDOWN</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">curPN</span> <span class="o">=</span> <span class="n">curPN</span><span class="o">-&gt;</span><span class="n">next_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//广播，将查询广播到任何一个在该链表内的邻居节点
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// [SubTask-2]: Bordercast it(Send a Query to every neighbor in the list)...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span><span class="n">NbLst</span><span class="p">.</span><span class="n">isEmpty</span><span class="p">()</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">hdr_ip</span> <span class="o">*</span><span class="n">hdrip</span> <span class="o">=</span> <span class="n">HDR_IP</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">ttl</span> <span class="o">=</span> <span class="n">hdrip</span><span class="o">-&gt;</span><span class="n">ttl</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span><span class="c1">// Reducing the TTL value
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span><span class="p">(</span><span class="n">ttl</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">pktUtil_</span><span class="p">).</span><span class="n">pkt_drop</span><span class="p">(</span><span class="n">p</span><span class="p">);</span><span class="c1">// Drop the Packet [No need to Forward]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">Neighbor</span> <span class="o">*</span><span class="n">curNb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">curNb</span> <span class="o">=</span> <span class="n">NbLst</span><span class="p">.</span><span class="n">head_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">NbLst</span><span class="p">.</span><span class="n">numNeighbors_</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Create a Packet... 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">Packet</span> <span class="o">*</span><span class="n">pnew</span> <span class="o">=</span> <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">pktUtil_</span><span class="p">).</span><span class="n">pkt_create</span><span class="p">(</span><span class="n">IERP_REQUEST</span><span class="p">,</span> <span class="n">curNb</span><span class="o">-&gt;</span><span class="n">addr_</span><span class="p">,</span> <span class="n">ttl</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">addMyAddressToRoute</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">pnew</span><span class="p">);</span>    <span class="c1">// Add My address to the route
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// Set Parameters...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">hdr_zrp</span> <span class="o">*</span><span class="n">hdrznew</span> <span class="o">=</span> <span class="n">HDR_ZRP</span><span class="p">(</span><span class="n">pnew</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">src_</span> <span class="o">=</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">src_</span><span class="p">;</span>    <span class="c1">// Identification fields at Sender of the Query
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">dest_</span> <span class="o">=</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">dest_</span><span class="p">;</span>    <span class="c1">// Identification fields at Sender of the Query
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">seq_</span> <span class="o">=</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">seq_</span><span class="p">;</span>    <span class="c1">// Identification fields at Sender of the Query
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">queryID_</span> <span class="o">=</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">queryID_</span><span class="p">;</span><span class="c1">// Identification fields at Sender of the Query
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">lastbc_</span> <span class="o">=</span> <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">myaddr_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">routeindex_</span> <span class="o">=</span> <span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">routelength_</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>    <span class="c1">// My_address in the route [Just Added b4]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Send the Packet...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">hdr_ip</span> <span class="o">*</span><span class="n">hdripnew</span> <span class="o">=</span> <span class="n">HDR_IP</span><span class="p">(</span><span class="n">pnew</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">hdripnew</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">()</span> <span class="o">=</span> <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">myaddr_</span><span class="p">;</span>    
</span></span><span class="line"><span class="cl">                <span class="n">hdripnew</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">()</span> <span class="o">=</span> <span class="n">curNb</span><span class="o">-&gt;</span><span class="n">addr_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">Time</span> <span class="n">jitter</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">jitter</span> <span class="o">=</span>  <span class="n">Random</span><span class="o">::</span><span class="n">uniform</span><span class="p">(</span><span class="n">IERP_XMIT_JITTER</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">pktUtil_</span><span class="p">).</span><span class="n">pkt_send</span><span class="p">(</span><span class="n">pnew</span><span class="p">,</span> <span class="n">curNb</span><span class="o">-&gt;</span><span class="n">addr_</span><span class="p">,</span> <span class="n">jitter</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// [Log: XMIT_IERP_REQUEST]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">Time</span> <span class="n">now</span> <span class="o">=</span> <span class="n">Scheduler</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">clock</span><span class="p">();</span> <span class="c1">// get the time
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">_%d_ [%6.6f] | XMIT_IERP_REQUEST | -S %d -D %d | -IS %d -ID %d | -QID %d |&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">myaddr_</span><span class="p">,</span> <span class="n">now</span><span class="o">+</span><span class="n">jitter</span><span class="p">,</span> <span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">src_</span><span class="p">,</span> <span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">dest_</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                    <span class="n">hdripnew</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">(),</span> <span class="n">hdripnew</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">(),</span> <span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">queryID_</span><span class="p">);</span>    
</span></span><span class="line"><span class="cl">                    <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">pktUtil_</span><span class="p">).</span><span class="n">pkt_print_route</span><span class="p">(</span><span class="n">pnew</span><span class="p">);</span> <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">print_tables</span><span class="p">();</span> <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span> <span class="c1">// [Log: End]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">curNb</span> <span class="o">=</span> <span class="n">curNb</span><span class="o">-&gt;</span><span class="n">next_</span><span class="p">;</span>        <span class="c1">// Advance the Pointer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/*[Cumulative Log-Entry]if(DEBUG) { // [Log: EVENT_XMIT_IERP_REQUEST_FORWARDED]
</span></span></span><span class="line"><span class="cl"><span class="cm">                    Time now = Scheduler::instance().clock(); // get the time
</span></span></span><span class="line"><span class="cl"><span class="cm">                    printf(&#34;\n_%d_ [%6.6f] | EVENT_XMIT_IERP_REQUEST_FORWARDED | Node %d has forwarded &#34;
</span></span></span><span class="line"><span class="cl"><span class="cm">                    &#34;IERP_REQUEST(seq=%d) | [ SRC = %d : DEST = %d ] | To following Neighbors - &#34;,
</span></span></span><span class="line"><span class="cl"><span class="cm">                    agent_-&gt;myaddr_, now, agent_-&gt;myaddr_, hdrz-&gt;seq_, hdrz-&gt;src_, hdrz-&gt;dest_);    
</span></span></span><span class="line"><span class="cl"><span class="cm">                    NbLst.printNeighbors(); (agent_-&gt;pktUtil_).pkt_print_route(p); 
</span></span></span><span class="line"><span class="cl"><span class="cm">                    agent_-&gt;print_tables(); printf(&#34;\n&#34;); 
</span></span></span><span class="line"><span class="cl"><span class="cm">                    } // [Log: End]    */</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">pktUtil_</span><span class="p">).</span><span class="n">pkt_drop</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>    <span class="c1">// Drop the original Packet 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><hr>
<h4 id="418-ierpagent类内方法recv_ierp_route_request_mc">4.1.8 IERPAgent类内方法recv_IERP_ROUTE_REQUEST_MC()</h4>
<p>当节点收到路由请求消息时调用它。在收到路由请求时</p>
<p>1.它将查询添加到检测到的查询表中。</p>
<p>2.如果节点本身是预期目的地，那么它会创建一个“ROUTE_REPLY”并将其发送回路由请求发起者。</p>
<p>3.如果目的地位于节点的区域中，则它向目的地单播路由请求。</p>
<p>4.节点通过以下步骤对查询进行边界广播：</p>
<p>    4.1标记查询覆盖的所有外围节点。</p>
<p>    4.2如果节点不在“MULTICAST_RECEIVER_LIST”中，则什么都不做并返回。</p>
<p>    4.3如果节点在“MULTICAST_RECEIVER_LIST”中，那么，</p>
<p>    4.4它生成一个邻居集，通过它可以到达所有未覆盖的外围节点。</p>
<p>    4.5它将查询转发给所有这些邻居。 [单条消息]</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* 5. Receiving IERP-route-request. [Multi-cast Case] */</span>
</span></span><span class="line"><span class="cl"><span class="c1">//接收 IERP 路由请求。 [多播案例]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> 
</span></span><span class="line"><span class="cl"><span class="n">IERPAgent</span><span class="o">::</span><span class="n">recv_IERP_ROUTE_REQUEST_MC</span><span class="p">(</span><span class="n">Packet</span><span class="o">*</span> <span class="n">p</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">hdr_zrp</span> <span class="o">*</span><span class="n">hdrz</span> <span class="o">=</span> <span class="n">HDR_ZRP</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">hdr_ip</span> <span class="o">*</span><span class="n">hdrip</span> <span class="o">=</span> <span class="n">HDR_IP</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// [Log: RECV_IERP_REQUEST]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="k">if</span><span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">myaddr_</span> <span class="o">!=</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">src_</span><span class="p">)</span> <span class="p">{</span>    <span class="c1">// Only Non-source case...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">Time</span> <span class="n">now</span> <span class="o">=</span> <span class="n">Scheduler</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">clock</span><span class="p">();</span> <span class="c1">// get the time
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">_%d_ [%6.6f] | RECV_IERP_REQUEST | -S %d -D %d | -IS %d -ID %d | -QID %d | &#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">myaddr_</span><span class="p">,</span> <span class="n">now</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">src_</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">dest_</span><span class="p">,</span> <span class="n">hdrip</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">(),</span> <span class="n">hdrip</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                    <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">queryID_</span><span class="p">);</span>    
</span></span><span class="line"><span class="cl">                    <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">pktUtil_</span><span class="p">).</span><span class="n">pkt_print_route</span><span class="p">(</span><span class="n">p</span><span class="p">);</span> <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">print_tables</span><span class="p">();</span> <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span> <span class="c1">// [Log: End]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// [CommonTask-1]: Check if this is a new query?? If not, Add this Query to the Cache
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Time</span> <span class="n">now</span> <span class="o">=</span> <span class="n">Scheduler</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">clock</span><span class="p">();</span> <span class="c1">// get the time
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DetectedQuery</span> <span class="o">*</span><span class="n">handleToFoundDQ</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">foundQueryFlag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">foundQueryFlag</span> <span class="o">=</span> <span class="n">dqLst_</span><span class="p">.</span><span class="n">findQuery</span><span class="p">(</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">src_</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">dest_</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">queryID_</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">handleToFoundDQ</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">foundQueryFlag</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">dest_</span> <span class="o">!=</span> <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">myaddr_</span> <span class="o">&amp;&amp;</span> <span class="n">handleToFoundDQ</span><span class="o">-&gt;</span><span class="n">querySentFlag_</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>    <span class="c1">// Already sent the Query
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">pktUtil_</span><span class="p">).</span><span class="n">pkt_drop</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>    <span class="c1">// Drop the original Packet 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">return</span><span class="p">;</span>    <span class="c1">// Nothing to Do
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>    <span class="c1">// For control Flooding...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">dqLst_</span><span class="p">.</span><span class="n">addQuery</span><span class="p">(</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">src_</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">dest_</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">queryID_</span><span class="p">,</span> <span class="n">now</span><span class="o">+</span><span class="n">queryLifeTime_</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">((</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">iarpAgt_</span><span class="p">).</span><span class="n">pnLst_</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//如果我不是发送源
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// [CommonTask-2]: If I am not the Source, Do the Following...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//如果我不是查询的发起者
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">src_</span> <span class="o">!=</span> <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">myaddr_</span><span class="p">)</span> <span class="p">{</span>    <span class="c1">// If I am not the originator of the query
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 根据之前的 bordercaster 信息标记所有覆盖的外围节点。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// [Sub-CommonTask-1]: Mark All covered peripheral nodes based on previous bordercaster info.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">foundQueryFlag</span> <span class="o">=</span> <span class="n">dqLst_</span><span class="p">.</span><span class="n">findQuery</span><span class="p">(</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">src_</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">dest_</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">queryID_</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">handleToFoundDQ</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">assert</span><span class="p">(</span><span class="n">foundQueryFlag</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">);</span><span class="c1">//一定会在该缓存中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">markCoveredPN</span><span class="p">(</span><span class="n">handleToFoundDQ</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">lastbc_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//检查我是否是多播接收者
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//hdrz-&gt;mcLst_的添加方法在此处不明，可能在下面添加
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// [Sub-CommonTask-2]: Check if I am a Multicast receiver or not
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">int</span> <span class="n">receiveFlag</span> <span class="o">=</span> <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">pktUtil_</span><span class="p">).</span><span class="n">pkt_AmIMultiCastReciver</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">myaddr_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">receiveFlag</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span><span class="p">;</span><span class="c1">// Nothing to Do
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//如果我是目标节点
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// [Task-1]: If I am the Destination [Create a ROUTE-REPLY(New Packet) and Send it back]]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">dest_</span> <span class="o">==</span> <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">myaddr_</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//检查我发了多少replies
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// [SubTask-0]: Check how many replies have been sent.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">DetectedQuery</span> <span class="o">*</span><span class="n">handleToFoundDQ</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">foundQueryFlag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">foundQueryFlag</span> <span class="o">=</span> <span class="n">dqLst_</span><span class="p">.</span><span class="n">findQuery</span><span class="p">(</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">src_</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">dest_</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">queryID_</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">handleToFoundDQ</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">assert</span><span class="p">(</span><span class="n">foundQueryFlag</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">handleToFoundDQ</span><span class="o">-&gt;</span><span class="n">totalReplySent_</span> <span class="o">&gt;=</span> <span class="n">DEFAULT_MAX_IERP_REPLY</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span><span class="p">;</span> <span class="c1">// No more replies should be sent.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">handleToFoundDQ</span><span class="o">-&gt;</span><span class="n">totalReplySent_</span><span class="o">++</span><span class="p">;</span>    <span class="c1">// Reply is sent in below code.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//创建IERP_REPLY包
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// [SubTask-1]: Create a IERP_REPLY packet [&#39;hdrz-&gt;routelength_+1&#39;: My address needs to be added]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Packet</span> <span class="o">*</span><span class="n">pnew</span> <span class="o">=</span> <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">pktUtil_</span><span class="p">).</span><span class="n">pkt_create</span><span class="p">(</span><span class="n">IERP_REPLY</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">dest_</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">routelength_</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">addMyAddressToRoute</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">pnew</span><span class="p">);</span>    <span class="c1">// Add My address to the route
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// [SubTask-2]: Set Parameters...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">hdr_zrp</span> <span class="o">*</span><span class="n">hdrznew</span> <span class="o">=</span> <span class="n">HDR_ZRP</span><span class="p">(</span><span class="n">pnew</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">src_</span> <span class="o">=</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">src_</span><span class="p">;</span>            <span class="c1">// Identification fields at Sender of the Query
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">dest_</span> <span class="o">=</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">dest_</span><span class="p">;</span>            <span class="c1">// Identification fields at Sender of the Query
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">seq_</span> <span class="o">=</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">seq_</span><span class="p">;</span>            <span class="c1">// Identification fields at Sender of the Query
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">queryID_</span> <span class="o">=</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">queryID_</span><span class="p">;</span>        <span class="c1">// Identification fields at Sender of the Query
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">routeindex_</span> <span class="o">=</span> <span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">routelength_</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>    <span class="c1">// My_address in the route
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// [SubTask-3]: Send the Packet
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">hdr_ip</span> <span class="o">*</span><span class="n">hdripnew</span> <span class="o">=</span> <span class="n">HDR_IP</span><span class="p">(</span><span class="n">pnew</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">hdripnew</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">()</span> <span class="o">=</span> <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">myaddr_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">hdripnew</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">()</span> <span class="o">=</span> <span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">route_</span><span class="p">[</span><span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">routeindex_</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>    <span class="c1">// Previous Hop
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">pktUtil_</span><span class="p">).</span><span class="n">pkt_send</span><span class="p">(</span><span class="n">pnew</span><span class="p">,</span> <span class="n">hdripnew</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">(),</span> <span class="mf">0.00</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// [Log: XMIT_IERP_REPLY]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">Time</span> <span class="n">now</span> <span class="o">=</span> <span class="n">Scheduler</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">clock</span><span class="p">();</span> <span class="c1">// get the time
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">_%d_ [%6.6f] | XMIT_IERP_REPLY | -S %d -D %d | -IS %d -ID %d | -QID %d | &#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">myaddr_</span><span class="p">,</span> <span class="n">now</span><span class="p">,</span> <span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">src_</span><span class="p">,</span> <span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">dest_</span><span class="p">,</span> <span class="n">hdripnew</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                    <span class="n">hdripnew</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">(),</span> <span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">queryID_</span><span class="p">);</span>    
</span></span><span class="line"><span class="cl">                    <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">pktUtil_</span><span class="p">).</span><span class="n">pkt_print_route</span><span class="p">(</span><span class="n">pnew</span><span class="p">);</span> <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">print_tables</span><span class="p">();</span> <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span> <span class="c1">// [Log: End]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 为查询发送设置标志。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// [SubTask-4]: Set the flag for Query-Sent...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">handleToFoundDQ</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">foundQueryFlag</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">foundQueryFlag</span> <span class="o">=</span> <span class="n">dqLst_</span><span class="p">.</span><span class="n">findQuery</span><span class="p">(</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">src_</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">dest_</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">queryID_</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">handleToFoundDQ</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">assert</span><span class="p">(</span><span class="n">foundQueryFlag</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">);</span>                <span class="c1">// Query Must be in the cache
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">assert</span><span class="p">(</span><span class="n">handleToFoundDQ</span><span class="o">-&gt;</span><span class="n">querySentFlag_</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">);</span>    <span class="c1">// Query must not be sent before
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">handleToFoundDQ</span><span class="o">-&gt;</span><span class="n">querySentFlag_</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>            <span class="c1">// Set the flag for query-sent [Here, Query-processed]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// [SubTask-5]: Drop the Packet...//丢弃包
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">pktUtil_</span><span class="p">).</span><span class="n">pkt_drop</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>    <span class="c1">// Drop the original Packet 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// [任务 2]：如果 Destination 位于 My Zone 中.. [向 Destination 单播请求]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// [Task-2]: If Destination lies in My Zone.. [Unicast the request to Destination]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// This Node should multicast - too - to only 1 node [weird use of words ;)]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">InnerRoute</span> <span class="o">*</span><span class="n">handleToFoundRoute</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">foundRouteFlag</span><span class="p">,</span> <span class="n">alreadySentNb</span><span class="o">=-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//在自己的内部路由表查询该目标节点//返回查询标志
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">foundRouteFlag</span> <span class="o">=</span> <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">iarpAgt_</span><span class="p">).</span><span class="n">irLst_</span><span class="p">.</span><span class="n">findRoute</span><span class="p">(</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">dest_</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">handleToFoundRoute</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">foundRouteFlag</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span><span class="c1">// Found Route in Zone//该节点在范围内
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// [SubTask-1]: Create a packet//创建包
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">hdr_ip</span> <span class="o">*</span><span class="n">hdrip</span> <span class="o">=</span> <span class="n">HDR_IP</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">ttl</span> <span class="o">=</span> <span class="n">hdrip</span><span class="o">-&gt;</span><span class="n">ttl</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>    <span class="c1">// Reducing the TTL value
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//创建IERP_REQUEST的包
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Packet</span> <span class="o">*</span><span class="n">pnew</span> <span class="o">=</span> <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">pktUtil_</span><span class="p">).</span><span class="n">pkt_create</span><span class="p">(</span><span class="n">IERP_REQUEST</span><span class="p">,</span> <span class="n">handleToFoundRoute</span><span class="o">-&gt;</span><span class="n">nextHop_</span><span class="p">,</span> <span class="n">ttl</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">addMyAddressToRoute</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">pnew</span><span class="p">);</span>    <span class="c1">// Add My address to the route
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// [SubTask-2]: 设置参数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">hdr_zrp</span> <span class="o">*</span><span class="n">hdrznew</span> <span class="o">=</span> <span class="n">HDR_ZRP</span><span class="p">(</span><span class="n">pnew</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">src_</span> <span class="o">=</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">src_</span><span class="p">;</span>    <span class="c1">// Identification fields at Sender of the Query
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">dest_</span> <span class="o">=</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">dest_</span><span class="p">;</span>    <span class="c1">// Identification fields at Sender of the Query
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">seq_</span> <span class="o">=</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">seq_</span><span class="p">;</span>    <span class="c1">// Identification fields at Sender of the Query
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">queryID_</span> <span class="o">=</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">queryID_</span><span class="p">;</span><span class="c1">// Identification fields at Sender of the Query
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">lastbc_</span> <span class="o">=</span> <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">myaddr_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">routeindex_</span> <span class="o">=</span> <span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">routelength_</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>    <span class="c1">// My_address in the route [Just Added b4]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// [SubTask-3]: 发送
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">hdr_ip</span> <span class="o">*</span><span class="n">hdripnew</span> <span class="o">=</span> <span class="n">HDR_IP</span><span class="p">(</span><span class="n">pnew</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">hdripnew</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">()</span> <span class="o">=</span> <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">myaddr_</span><span class="p">;</span>    
</span></span><span class="line"><span class="cl">        <span class="n">hdripnew</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">()</span> <span class="o">=</span> <span class="n">handleToFoundRoute</span><span class="o">-&gt;</span><span class="n">nextHop_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//该部分创建Muti-Cast链表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">pktUtil_</span><span class="p">).</span><span class="n">pkt_add_ADDRESS_space</span><span class="p">(</span><span class="n">pnew</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span><span class="c1">// Add Multi-cast Addresses [Allocate Memory]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">mcLstSize_</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="c1">// 设置参数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">mcLst_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">handleToFoundRoute</span><span class="o">-&gt;</span><span class="n">nextHop_</span><span class="p">;</span><span class="c1">// Adding multi-cast address
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//====================
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">pktUtil_</span><span class="p">).</span><span class="n">pkt_send</span><span class="p">(</span><span class="n">pnew</span><span class="p">,</span> <span class="n">hdripnew</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">(),</span> <span class="mf">0.00</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">alreadySentNb</span> <span class="o">=</span> <span class="n">handleToFoundRoute</span><span class="o">-&gt;</span><span class="n">nextHop_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// [Log: XMIT_IERP_REQUEST]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">Time</span> <span class="n">now</span> <span class="o">=</span> <span class="n">Scheduler</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">clock</span><span class="p">();</span> <span class="c1">// get the time
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">_%d_ [%6.6f] | XMIT_IERP_REQUEST | -S %d -D %d | -IS %d -ID %d | -QID %d |&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">myaddr_</span><span class="p">,</span> <span class="n">now</span><span class="p">,</span> <span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">src_</span><span class="p">,</span> <span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">dest_</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                    <span class="n">hdripnew</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">(),</span> <span class="n">hdripnew</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">(),</span> <span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">queryID_</span><span class="p">);</span>    
</span></span><span class="line"><span class="cl">                    <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">pktUtil_</span><span class="p">).</span><span class="n">pkt_print_route</span><span class="p">(</span><span class="n">pnew</span><span class="p">);</span> <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">print_tables</span><span class="p">();</span> <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span> <span class="c1">// [Log: End]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// [SubTask-4]: Set the flag for Query-Sent...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">DetectedQuery</span> <span class="o">*</span><span class="n">handleToFoundDQ</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">foundQueryFlag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">foundQueryFlag</span> <span class="o">=</span> <span class="n">dqLst_</span><span class="p">.</span><span class="n">findQuery</span><span class="p">(</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">src_</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">dest_</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">queryID_</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">handleToFoundDQ</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">assert</span><span class="p">(</span><span class="n">foundQueryFlag</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">);</span>                <span class="c1">// Query Must be in the cache
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">assert</span><span class="p">(</span><span class="n">handleToFoundDQ</span><span class="o">-&gt;</span><span class="n">querySentFlag_</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">);</span>    <span class="c1">// Query must not be sent before
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">handleToFoundDQ</span><span class="o">-&gt;</span><span class="n">querySentFlag_</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>            <span class="c1">// Set the flag for query-sent
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//广播Query
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// [Task-3]: Bordercast The Query... 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// [SubTask-1]: Bordercast it(Find all Next-Hop neighbors to  un-covered-perpheral-nodes)...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">NeighborList</span> <span class="n">NbLst</span><span class="p">;</span> <span class="c1">// Temporary list of query-forwarders
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">PeripheralNode</span> <span class="o">*</span><span class="n">curPN</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">handleToFoundRoute</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">foundRouteFlag</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">handleToFoundDQ</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">foundQueryFlag</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>    
</span></span><span class="line"><span class="cl">    <span class="n">foundQueryFlag</span> <span class="o">=</span> <span class="n">dqLst_</span><span class="p">.</span><span class="n">findQuery</span><span class="p">(</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">src_</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">dest_</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">queryID_</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">handleToFoundDQ</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span><span class="n">foundQueryFlag</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">);</span> <span class="c1">// Query Must be in the cache
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">curPN</span> <span class="o">=</span> <span class="p">(</span><span class="n">handleToFoundDQ</span><span class="o">-&gt;</span><span class="n">pnLst_</span><span class="p">).</span><span class="n">head_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="p">(</span><span class="n">handleToFoundDQ</span><span class="o">-&gt;</span><span class="n">pnLst_</span><span class="p">).</span><span class="n">numPerNodes_</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>    <span class="c1">// For all Peripheral Nodes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span><span class="p">(</span><span class="n">curPN</span><span class="o">-&gt;</span><span class="n">coveredFlag_</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">curPN</span> <span class="o">=</span> <span class="n">curPN</span><span class="o">-&gt;</span><span class="n">next_</span><span class="p">;</span>    <span class="c1">// Advance Pointer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">continue</span><span class="p">;</span>        <span class="c1">// Skip this Peripheral Node
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">foundRouteFlag</span> <span class="o">=</span> <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">iarpAgt_</span><span class="p">).</span><span class="n">irLst_</span><span class="p">.</span><span class="n">findRoute</span><span class="p">(</span><span class="n">curPN</span><span class="o">-&gt;</span><span class="n">addr_</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">handleToFoundRoute</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">foundRouteFlag</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>    <span class="c1">// Add these Neighbors into List
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="kt">int</span> <span class="n">foundNbFlag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">Neighbor</span> <span class="o">*</span><span class="n">handleToFoundNb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>    <span class="c1">// Do Not Replicate Same Neighbors
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">foundNbFlag</span> <span class="o">=</span> <span class="n">NbLst</span><span class="p">.</span><span class="n">findNeighbor</span><span class="p">(</span><span class="n">handleToFoundRoute</span><span class="o">-&gt;</span><span class="n">nextHop_</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">handleToFoundNb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="p">(</span><span class="n">foundNbFlag</span> <span class="o">==</span> <span class="n">FALSE</span> <span class="o">&amp;&amp;</span> <span class="n">handleToFoundRoute</span><span class="o">-&gt;</span><span class="n">nextHop_</span> <span class="o">!=</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">lastbc_</span>
</span></span><span class="line"><span class="cl">                        <span class="o">&amp;&amp;</span> <span class="n">handleToFoundRoute</span><span class="o">-&gt;</span><span class="n">nextHop_</span> <span class="o">!=</span> <span class="n">alreadySentNb</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// Last-2 args-doesnt matter
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">NbLst</span><span class="p">.</span><span class="n">addNeighbor</span><span class="p">(</span><span class="n">handleToFoundRoute</span><span class="o">-&gt;</span><span class="n">nextHop_</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">LINKDOWN</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">curPN</span><span class="o">-&gt;</span><span class="n">coveredFlag_</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>    <span class="c1">// We are sending the query    
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">curPN</span> <span class="o">=</span> <span class="n">curPN</span><span class="o">-&gt;</span><span class="n">next_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// [SubTask-2]: Bordercast it(Send a Query to every neighbor in the list)...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span><span class="n">NbLst</span><span class="p">.</span><span class="n">isEmpty</span><span class="p">()</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">hdr_ip</span> <span class="o">*</span><span class="n">hdrip</span> <span class="o">=</span> <span class="n">HDR_IP</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">ttl</span> <span class="o">=</span> <span class="n">hdrip</span><span class="o">-&gt;</span><span class="n">ttl</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>    <span class="c1">// Reducing the TTL value
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 1. Create a Packet... 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Packet</span> <span class="o">*</span><span class="n">pnew</span> <span class="o">=</span> <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">pktUtil_</span><span class="p">).</span><span class="n">pkt_create</span><span class="p">(</span><span class="n">IERP_REQUEST</span><span class="p">,</span> <span class="n">IP_BROADCAST</span><span class="p">,</span> <span class="n">ttl</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 2. Add My address to the route...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">addMyAddressToRoute</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">pnew</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 3. Add Multicast addresses...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">hdr_zrp</span> <span class="o">*</span><span class="n">hdrznew</span> <span class="o">=</span> <span class="n">HDR_ZRP</span><span class="p">(</span><span class="n">pnew</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">pktUtil_</span><span class="p">).</span><span class="n">pkt_add_ADDRESS_space</span><span class="p">(</span><span class="n">pnew</span><span class="p">,</span> <span class="n">NbLst</span><span class="p">.</span><span class="n">numNeighbors_</span><span class="p">);</span><span class="c1">// Add Multi-cast Addresses[Allocate Memory]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">mcLstSize_</span> <span class="o">=</span> <span class="n">NbLst</span><span class="p">.</span><span class="n">numNeighbors_</span><span class="p">;</span>    <span class="c1">// Setting parameter
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Neighbor</span> <span class="o">*</span><span class="n">curNb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">        <span class="n">curNb</span> <span class="o">=</span> <span class="n">NbLst</span><span class="p">.</span><span class="n">head_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">NbLst</span><span class="p">.</span><span class="n">numNeighbors_</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">mcLst_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">curNb</span><span class="o">-&gt;</span><span class="n">addr_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">curNb</span> <span class="o">=</span> <span class="n">curNb</span><span class="o">-&gt;</span><span class="n">next_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 4. Set parameters...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">src_</span> <span class="o">=</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">src_</span><span class="p">;</span>    <span class="c1">// Identification fields at Sender of the Query
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">dest_</span> <span class="o">=</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">dest_</span><span class="p">;</span>    <span class="c1">// Identification fields at Sender of the Query
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">seq_</span> <span class="o">=</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">seq_</span><span class="p">;</span>    <span class="c1">// Identification fields at Sender of the Query
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">queryID_</span> <span class="o">=</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">queryID_</span><span class="p">;</span><span class="c1">// Identification fields at Sender of the Query
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">lastbc_</span> <span class="o">=</span> <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">myaddr_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">routeindex_</span> <span class="o">=</span> <span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">routelength_</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>    <span class="c1">// My_address in the route [Just Added b4]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 5. Multicast(Broadcast) the Packet...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">hdr_ip</span> <span class="o">*</span><span class="n">hdripnew</span> <span class="o">=</span> <span class="n">HDR_IP</span><span class="p">(</span><span class="n">pnew</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">hdripnew</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">()</span> <span class="o">=</span> <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">myaddr_</span><span class="p">;</span>    
</span></span><span class="line"><span class="cl">            <span class="n">hdripnew</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">()</span> <span class="o">=</span> <span class="n">IP_BROADCAST</span><span class="p">;</span><span class="c1">// Just to be sure
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">pktUtil_</span><span class="p">).</span><span class="n">pkt_broadcast</span><span class="p">(</span><span class="n">pnew</span><span class="p">,</span> <span class="p">(</span><span class="kt">double</span><span class="p">)(</span><span class="n">IERP_XMIT_JITTER</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// [Log: XMIT_IERP_REQUEST]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">Time</span> <span class="n">now</span> <span class="o">=</span> <span class="n">Scheduler</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">clock</span><span class="p">();</span> <span class="c1">// get the time
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">_%d_ [%6.6f] | XMIT_IERP_REQUEST | -S %d -D %d | -IS %d -ID BROADCAST | &#34;</span>
</span></span><span class="line"><span class="cl">                    <span class="s">&#34;-QID %d | Sent to &#34;</span><span class="p">,</span> <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">myaddr_</span><span class="p">,</span> <span class="n">now</span><span class="p">,</span> <span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">src_</span><span class="p">,</span> <span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">dest_</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                    <span class="n">hdripnew</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">(),</span> <span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">queryID_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="n">NbLst</span><span class="p">.</span><span class="n">printNeighbors</span><span class="p">();</span> <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">pktUtil_</span><span class="p">).</span><span class="n">pkt_print_route</span><span class="p">(</span><span class="n">pnew</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">                    <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">print_tables</span><span class="p">();</span> <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span> <span class="c1">// [Log: End]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 6. Set the flag for Query-Sent...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">DetectedQuery</span> <span class="o">*</span><span class="n">handleToFoundDQ</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">foundQueryFlag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">foundQueryFlag</span> <span class="o">=</span> <span class="n">dqLst_</span><span class="p">.</span><span class="n">findQuery</span><span class="p">(</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">src_</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">dest_</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">queryID_</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">handleToFoundDQ</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">assert</span><span class="p">(</span><span class="n">foundQueryFlag</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">);</span>                <span class="c1">// Query Must be in the cache
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">assert</span><span class="p">(</span><span class="n">handleToFoundDQ</span><span class="o">-&gt;</span><span class="n">querySentFlag_</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">);</span>    <span class="c1">// Query must not be sent before
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">handleToFoundDQ</span><span class="o">-&gt;</span><span class="n">querySentFlag_</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>            <span class="c1">// Set the flag for query-sent
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">pktUtil_</span><span class="p">).</span><span class="n">pkt_drop</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>    <span class="c1">// Drop the original Packet 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><hr>
<h4 id="419-ierpagent类内方法addlinkstatefromroute">4.1.9 IERPAgent类内方法addLinkStateFromRoute()</h4>
<p>当从路由回复消息中提取链路状态信息时调用此函数。这链路状态信息从源路由中提取并添加到链路状态表中。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">//该函数再次更新link-status情报
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span> 
</span></span><span class="line"><span class="cl"><span class="n">IERPAgent</span><span class="o">::</span><span class="n">addLinkStateFromRoute</span><span class="p">(</span><span class="n">nsaddr_t</span> <span class="o">*</span><span class="n">route</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// For each link in route, add them in the IARP-Link-State-Table
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//对于路由中的每个链接，将它们添加到 IARP-Link-State-Table
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">assert</span><span class="p">(</span><span class="n">size</span><span class="o">!=</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">Time</span> <span class="n">now</span> <span class="o">=</span> <span class="n">Scheduler</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">clock</span><span class="p">();</span> <span class="c1">// get the time
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">LinkState</span> <span class="o">*</span><span class="n">handleToFoundLS</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">LSFoundFlag</span><span class="p">,</span> <span class="n">LSTChangeFlag</span><span class="o">=</span><span class="n">FALSE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">handleToFoundLS</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">LSFoundFlag</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">LSFoundFlag</span> <span class="o">=</span> <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">iarpAgt_</span><span class="p">).</span><span class="n">lsLst_</span><span class="p">.</span><span class="n">findLink</span><span class="p">(</span><span class="n">route</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">route</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">handleToFoundLS</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">LSFoundFlag</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="p">{</span>    <span class="c1">// New one
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">iarpAgt_</span><span class="p">).</span><span class="n">lsLst_</span><span class="p">.</span><span class="n">addLink</span><span class="p">(</span><span class="n">route</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">route</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">LINKUP</span><span class="p">,</span> <span class="n">now</span><span class="o">+</span><span class="n">routeLifeTime_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">LSTChangeFlag</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>            <span class="c1">// Existing One
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span><span class="p">(</span><span class="n">handleToFoundLS</span><span class="o">-&gt;</span><span class="n">isup_</span> <span class="o">==</span> <span class="n">LINKDOWN</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">LSTChangeFlag</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">handleToFoundLS</span><span class="o">-&gt;</span><span class="n">isup_</span> <span class="o">=</span> <span class="n">LINKUP</span><span class="p">;</span>        <span class="c1">// Update Attributes - Link-State
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">handleToFoundLS</span><span class="o">-&gt;</span><span class="n">expiry_</span> <span class="o">=</span> <span class="n">now</span><span class="o">+</span><span class="n">routeLifeTime_</span><span class="p">;</span><span class="c1">// Update Attributes - Expiry Time
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// If there is a change in Link-State-Table, then rebuild the routing table.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span><span class="n">LSTChangeFlag</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">iarpAgt_</span><span class="p">).</span><span class="n">buildRoutingTable</span><span class="p">();</span>          <span class="c1">// Rebuild Routing Table
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//agent_-&gt;route_SendBuffer_pkt();    // Send Buffered packets... [Its done at callee function]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">LSTChangeFlag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr>
<h4 id="4110-ierpagent类内方法removelinkstatefrombrokenroute">4.1.10 IERPAgent类内方法removeLinkStateFromBrokenRoute()</h4>
<p>当从路由错误消息中提取损坏的链路状态信息时调用此函数。断开的链路状态信息从源路由中提取并添加到链路状态表中。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">int</span> 
</span></span><span class="line"><span class="cl"><span class="n">IERPAgent</span><span class="o">::</span><span class="n">removeLinkStateFromBrokenRoute</span><span class="p">(</span><span class="n">nsaddr_t</span> <span class="n">lnkSrc</span><span class="p">,</span> <span class="n">nsaddr_t</span> <span class="n">lnkDest</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Remove the broken link from the link-state-list if it exists.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">LinkState</span> <span class="o">*</span><span class="n">handleToFoundLS</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">LSFoundFlag</span><span class="o">=</span><span class="n">FALSE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">LSFoundFlag</span> <span class="o">=</span> <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">iarpAgt_</span><span class="p">).</span><span class="n">lsLst_</span><span class="p">.</span><span class="n">findLink</span><span class="p">(</span><span class="n">lnkSrc</span><span class="p">,</span> <span class="n">lnkDest</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">handleToFoundLS</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// If there is a change in Link-State-Table, then rebuild the routing table.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span><span class="n">LSFoundFlag</span>  <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">handleToFoundLS</span><span class="o">-&gt;</span><span class="n">isup_</span> <span class="o">=</span> <span class="n">LINKDOWN</span><span class="p">;</span>      <span class="c1">// Set the link-stauts = DOWN 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">iarpAgt_</span><span class="p">).</span><span class="n">buildRoutingTable</span><span class="p">();</span>          <span class="c1">// Rebuild Routing Table
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">LSFoundFlag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr>
<h4 id="4111ierpagent类内方法recv_ierp_route_reply">4.1.11IERPAgent类内方法recv_IERP_ROUTE_REPLY()</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* 6. Receiving IERP-route-reply. */</span>
</span></span><span class="line"><span class="cl"><span class="c1">//接受IERP-route-reply
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> 
</span></span><span class="line"><span class="cl"><span class="n">IERPAgent</span><span class="o">::</span><span class="n">recv_IERP_ROUTE_REPLY</span><span class="p">(</span><span class="n">Packet</span><span class="o">*</span> <span class="n">p</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">hdr_ip</span> <span class="o">*</span><span class="n">hdrip</span> <span class="o">=</span> <span class="n">HDR_IP</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">hdr_cmn</span> <span class="o">*</span><span class="n">hdrc</span> <span class="o">=</span> <span class="n">HDR_CMN</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">hdr_zrp</span> <span class="o">*</span><span class="n">hdrz</span> <span class="o">=</span> <span class="n">HDR_ZRP</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// [Log: RECV_IERP_REPLY]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">Time</span> <span class="n">now</span> <span class="o">=</span> <span class="n">Scheduler</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">clock</span><span class="p">();</span> <span class="c1">// get the time
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">_%d_ [%6.6f] | RECV_IERP_REPLY | -S %d -D %d | -IS %d -ID %d | -QID %d | &#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">myaddr_</span><span class="p">,</span> <span class="n">now</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">src_</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">dest_</span><span class="p">,</span> <span class="n">hdrip</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">(),</span> <span class="n">hdrip</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                    <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">queryID_</span><span class="p">);</span>    
</span></span><span class="line"><span class="cl">                    <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">pktUtil_</span><span class="p">).</span><span class="n">pkt_print_route</span><span class="p">(</span><span class="n">p</span><span class="p">);</span> <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">print_tables</span><span class="p">();</span> <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span> <span class="c1">// [Log: End]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//获取当前时间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Time</span> <span class="n">now</span> <span class="o">=</span> <span class="n">Scheduler</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">clock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// [Task-1]: (IF) I am the Source.. [Store the route in OUTER-ROUTE-LIST - 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//    2-Cases: 1) Enter New Route; OR 2)Replace the old One(If new one is better)]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 放入新的路由或者替换掉旧的(如果你有新的更好的)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 意味着我是发送源节点，我已经发送过该Query
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">src_</span> <span class="o">==</span> <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">myaddr_</span><span class="p">)</span> <span class="p">{</span>    <span class="c1">// MEANS - I have intitated the Query
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//更新拓扑表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// [SubTask-1]: Adding this info to topology table...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">int</span> <span class="n">routingTableUpdatedFlag</span><span class="o">=</span><span class="n">FALSE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">routingTableUpdatedFlag</span> <span class="o">=</span> <span class="n">addLinkStateFromRoute</span><span class="p">(</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">route_</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">routelength_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">routingTableUpdatedFlag</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">route_SendBuffer_pkt</span><span class="p">();</span>    <span class="c1">// Send Buffered packets...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//从已经送信QueryBuffer中删除该Query，因为已经完成
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// [SubTask-2]: Delete the query from Sent_Query_List
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">SentQuery</span> <span class="o">*</span><span class="n">handleToFoundSQ</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">foundSQFlag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">foundSQFlag</span> <span class="o">=</span> <span class="n">sqLst_</span><span class="p">.</span><span class="n">findQuery</span><span class="p">(</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">src_</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">dest_</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">handleToFoundSQ</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">foundSQFlag</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>    <span class="c1">// Remove the Entry
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">sqLst_</span><span class="p">.</span><span class="n">removeQuery</span><span class="p">(</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">src_</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">dest_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 丢掉该包
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// [SubTask-3]: Drop the packet
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">pktUtil_</span><span class="p">).</span><span class="n">pkt_drop</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// [Task-2]: (ELSE) Forward it along the Route (Backwards) [No need to generate new packet]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 继续转发该包，不需要产生新的
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 转发回复.. 将此信息添加到拓扑表中。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// Snooping the forwarding replies.. Adding this info into topology table.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span><span class="p">(</span><span class="n">IERP_REPLY_SNOOP</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">routingTableUpdatedFlag</span><span class="o">=</span><span class="n">FALSE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">routingTableUpdatedFlag</span> <span class="o">=</span> <span class="n">addLinkStateFromRoute</span><span class="p">(</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">route_</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">routelength_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="p">(</span><span class="n">routingTableUpdatedFlag</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">route_SendBuffer_pkt</span><span class="p">();</span>    <span class="c1">// Send Buffered packets...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//沿路由转发（向后）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// Forward it along the Route (Backwards) [No need to generate new packet]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">routeindex_</span><span class="o">--</span><span class="p">;</span>    <span class="c1">// Move 1 hop (PREV) into the route(Should be My address)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">assert</span><span class="p">(</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">route_</span><span class="p">[</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">routeindex_</span><span class="p">]</span> <span class="o">==</span> <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">myaddr_</span><span class="p">);</span> <span class="n">assert</span><span class="p">(</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">routeindex_</span><span class="o">-</span><span class="mi">1</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">hdrc</span><span class="o">-&gt;</span><span class="n">direction</span><span class="p">()</span> <span class="o">=</span> <span class="n">hdr_cmn</span><span class="o">::</span><span class="n">DOWN</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">hdrip</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">()</span> <span class="o">=</span> <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">myaddr_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">hdrip</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">()</span> <span class="o">=</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">route_</span><span class="p">[</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">routeindex_</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>    <span class="c1">// Previous hop in the route    
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">pktUtil_</span><span class="p">).</span><span class="n">pkt_send</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">hdrip</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">(),</span> <span class="mf">0.00</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// [Log: XMIT_IERP_REPLY]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">Time</span> <span class="n">now</span> <span class="o">=</span> <span class="n">Scheduler</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">clock</span><span class="p">();</span> <span class="c1">// get the time
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">_%d_ [%6.6f] | XMIT_IERP_REPLY | -S %d -D %d | -IS %d -ID %d | -QID %d | &#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">myaddr_</span><span class="p">,</span> <span class="n">now</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">src_</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">dest_</span><span class="p">,</span> <span class="n">hdrip</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">(),</span> <span class="n">hdrip</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                    <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">queryID_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">pktUtil_</span><span class="p">).</span><span class="n">pkt_print_route</span><span class="p">(</span><span class="n">p</span><span class="p">);</span> <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">print_tables</span><span class="p">();</span> <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span> <span class="c1">// [Log: End]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr>
<h4 id="4112-ierpagent类内方法recv_ierp_route_error">4.1.12 IERPAgent类内方法recv_IERP_ROUTE_ERROR()</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* 7. Receiving IERP-route-error. */</span>
</span></span><span class="line"><span class="cl"><span class="c1">//接收到IERP-route-error包
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span>
</span></span><span class="line"><span class="cl"><span class="n">IERPAgent</span><span class="o">::</span><span class="n">recv_IERP_ROUTE_ERROR</span><span class="p">(</span><span class="n">Packet</span><span class="o">*</span> <span class="n">p</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// [Task-1]: (IF) I am the Source.. [Discard the route in OUTER-ROUTE-LIST]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">hdr_cmn</span> <span class="o">*</span><span class="n">hdrc</span> <span class="o">=</span> <span class="n">HDR_CMN</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">hdr_zrp</span> <span class="o">*</span><span class="n">hdrz</span> <span class="o">=</span> <span class="n">HDR_ZRP</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">hdr_ip</span> <span class="o">*</span><span class="n">hdrip</span> <span class="o">=</span> <span class="n">HDR_IP</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// [Log: RECV_IERP_ERROR]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">Time</span> <span class="n">now</span> <span class="o">=</span> <span class="n">Scheduler</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">clock</span><span class="p">();</span> <span class="c1">// get the time
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">_%d_ [%6.6f] | RECV_IERP_ERROR | -S %d -D %d | -IS %d -ID %d | -SEQ %d | &#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">myaddr_</span><span class="p">,</span> <span class="n">now</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">src_</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">dest_</span><span class="p">,</span> <span class="n">hdrip</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">(),</span> <span class="n">hdrip</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                    <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">seq_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">pktUtil_</span><span class="p">).</span><span class="n">pkt_print_route</span><span class="p">(</span><span class="n">p</span><span class="p">);</span> <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">print_tables</span><span class="p">();</span> <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span> <span class="c1">// [Log: End]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">src_</span> <span class="o">==</span> <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">myaddr_</span><span class="p">)</span> <span class="p">{</span>    <span class="c1">// I am the Source...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// [SubTask-1]: Remove the broken link info from topology table.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">removeLinkStateFromBrokenRoute</span><span class="p">(</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">links_</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">src_</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">links_</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">dest_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// [SubTask-2]: Drop the packet
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">pktUtil_</span><span class="p">).</span><span class="n">pkt_drop</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// [Task-2]: (ELSE) Forward it along the Route (Backwards) [No need to generate new packet]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">IERP_ERROR_SNOOP</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Remove the broken link info from topology table.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">removeLinkStateFromBrokenRoute</span><span class="p">(</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">links_</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">src_</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">links_</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">dest_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">routeindex_</span><span class="o">--</span><span class="p">;</span>    <span class="c1">// Move 1 hop (PREV) into the route(Should be My address)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">assert</span><span class="p">(</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">route_</span><span class="p">[</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">routeindex_</span><span class="p">]</span> <span class="o">==</span> <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">myaddr_</span><span class="p">);</span> <span class="n">assert</span><span class="p">(</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">routeindex_</span><span class="o">-</span><span class="mi">1</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">hdrc</span><span class="o">-&gt;</span><span class="n">direction</span><span class="p">()</span> <span class="o">=</span> <span class="n">hdr_cmn</span><span class="o">::</span><span class="n">DOWN</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">hdrip</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">()</span> <span class="o">=</span> <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">myaddr_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">hdrip</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">()</span> <span class="o">=</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">route_</span><span class="p">[</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">routeindex_</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">pktUtil_</span><span class="p">).</span><span class="n">pkt_send</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">hdrip</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">(),</span> <span class="mf">0.00</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// [Log: RECV_IERP_ERROR]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">Time</span> <span class="n">now</span> <span class="o">=</span> <span class="n">Scheduler</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">clock</span><span class="p">();</span> <span class="c1">// get the time
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">_%d_ [%6.6f] | RECV_IERP_ERROR | -S %d -D %d | -IS %d -ID %d | -SEQ %d | &#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">myaddr_</span><span class="p">,</span> <span class="n">now</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">src_</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">dest_</span><span class="p">,</span> <span class="n">hdrip</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">(),</span> <span class="n">hdrip</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                    <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">seq_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">pktUtil_</span><span class="p">).</span><span class="n">pkt_print_route</span><span class="p">(</span><span class="n">p</span><span class="p">);</span> <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">print_tables</span><span class="p">();</span> <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span> <span class="c1">// [Log: End]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr>
<h2 id="5zrpzone-routing-protocol">5.ZRP(ZONE ROUTING PROTOCOL)</h2>
<h3 id="51-zrp的包头类">5.1 ZRP的包头类</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* [SECTION-5]------------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="cm"> *    1) ZRP HEADER STRUCTURE
</span></span></span><span class="line"><span class="cl"><span class="cm"> * [SUB-SECTION-5.1]------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="cm"> * ZRP HEADER STRUCTURE:-
</span></span></span><span class="line"><span class="cl"><span class="cm"> * -----------------------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">LSU</span><span class="p">;</span>    <span class="c1">// Pre-Declaration
</span></span></span><span class="line"><span class="cl"><span class="c1">//zrp的包头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">hdr_zrp</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Common Attributes to All packets... [Default Size = 10 bytes]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">zrptype_</span><span class="p">;</span>         <span class="c1">// Packet type                    [1 byte]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Time</span> <span class="n">pktsent_</span><span class="p">;</span>        <span class="c1">// Packet Sending time                [Logically not sent]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">radius_</span><span class="p">;</span>        <span class="c1">// Sender&#39;s Zone Radius (Maybe Useful in Future)[Not Used]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">seq_</span><span class="p">;</span>             <span class="c1">// Sequence number of a packet            [1 byte]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">nsaddr_t</span> <span class="n">src_</span><span class="p">;</span>        <span class="c1">// 32-bit Address                [4 bytes]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">nsaddr_t</span> <span class="n">dest_</span><span class="p">;</span>        <span class="c1">// 32-bit Address                [4 bytes]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// IARP Specific...            [IARP size = 2 + 5*links]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">forwarded_</span><span class="p">;</span>      <span class="c1">// TRUE if forwarded before            [1 byte]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">LSU</span> <span class="o">*</span><span class="n">links_</span><span class="p">;</span>          <span class="c1">// pointer to link state list             [5 bytes per link - address(4) + link(1)]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">numlinks_</span><span class="p">;</span>        <span class="c1">// Number of links in packet            [1 byte]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// IERP Specific...            [IERP size (for REQUEST) = 7 + 4*routelength]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//                    [    (for REPLY) = 3 + 4*routelength]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//                    [    (for ERROR) = 2 + 5(for link info) + 4*routelength] 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//                    [    (for DATA) = 2 + 4*routelength]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">nsaddr_t</span> <span class="o">*</span><span class="n">mcLst_</span><span class="p">;</span>    <span class="c1">// List of addresses to relay(Multicast) the    [Not Used]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="c1">// route-request query
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">mcLstSize_</span><span class="p">;</span>        <span class="c1">// Size of above list                [Not Used]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">nsaddr_t</span> <span class="n">lastbc_</span><span class="p">;</span>    <span class="c1">// 32-bit Address [Not Used much]        [REQUEST - 4 bytes]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">nsaddr_t</span> <span class="o">*</span><span class="n">route_</span><span class="p">;</span>     <span class="c1">// pointer to route list data            [REQUEST/REPLY/ERROR/DATA 4 bytes per address]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">routelength_</span><span class="p">;</span>    <span class="c1">// Route Length of IERP route stored in route_    [REQUEST/REPLY/ERROR/DATA 1 byte]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="kt">int</span> <span class="n">routeindex_</span><span class="p">;</span>      <span class="c1">// Pointer to a current route node in route_    [REQUEST/REPLY/ERROR/DATA 1 byte]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">queryID_</span><span class="p">;</span>          <span class="c1">// IERP query id counter            [REQUEST/REPLY 1 byte]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">      <span class="c1">// this is where the original data for upper layer pkts
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// is saved while ZRP routes pkt, at dest this is placed
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// back into hdrip-&gt;dport(), ie this is part of encapsulated data
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="kt">int</span> <span class="n">enc_dport_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="kt">int</span> <span class="n">enc_daddr_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">packet_t</span> <span class="n">enc_ptype_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Calculate the size of the header
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">size</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">switch</span><span class="p">(</span><span class="n">zrptype_</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="nl">NDP_BEACON</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">s</span> <span class="o">=</span> <span class="n">ZRP_DEFAULT_HDR_LEN</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="nl">NDP_BEACON_ACK</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">s</span> <span class="o">=</span> <span class="n">ZRP_DEFAULT_HDR_LEN</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="nl">IARP_UPDATE</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">s</span> <span class="o">=</span> <span class="n">ZRP_DEFAULT_HDR_LEN</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">5</span><span class="o">*</span><span class="n">numlinks_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="nl">IERP_REPLY</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">s</span> <span class="o">=</span> <span class="n">ZRP_DEFAULT_HDR_LEN</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">4</span><span class="o">*</span><span class="n">routelength_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="nl">IERP_REQUEST</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">s</span> <span class="o">=</span> <span class="n">ZRP_DEFAULT_HDR_LEN</span> <span class="o">+</span> <span class="mi">7</span> <span class="o">+</span> <span class="mi">4</span><span class="o">*</span><span class="n">routelength_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="nl">IERP_ROUTE_ERROR</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">s</span> <span class="o">=</span> <span class="n">ZRP_DEFAULT_HDR_LEN</span> <span class="o">+</span> <span class="mi">7</span> <span class="o">+</span> <span class="mi">4</span><span class="o">*</span><span class="n">routelength_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="nl">IARP_DATA</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="nl">IERP_DATA</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">s</span> <span class="o">=</span> <span class="n">ZRP_DEFAULT_HDR_LEN</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">4</span><span class="o">*</span><span class="n">routelength_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">s</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// Packet header access functions
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">static</span> <span class="kt">int</span> <span class="n">offset_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="kr">inline</span> <span class="k">static</span> <span class="kt">int</span><span class="o">&amp;</span> <span class="n">offset</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">offset_</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="kr">inline</span> <span class="k">static</span> <span class="n">hdr_zrp</span><span class="o">*</span> <span class="nf">access</span><span class="p">(</span><span class="k">const</span> <span class="n">Packet</span><span class="o">*</span> <span class="n">p</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="p">(</span><span class="n">hdr_zrp</span><span class="o">*</span><span class="p">)</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">access</span><span class="p">(</span><span class="n">offset_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="c1">//链路状态
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">class</span> <span class="nc">LSU</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">public</span><span class="o">:</span>    
</span></span><span class="line"><span class="cl">    <span class="n">nsaddr_t</span> <span class="n">src_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">nsaddr_t</span> <span class="n">dest_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">isUp_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Constructors...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">LSU</span><span class="p">()</span> <span class="o">:</span> <span class="n">src_</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">dest_</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">isUp_</span><span class="p">(</span><span class="n">LINKDOWN</span><span class="p">)</span> <span class="p">{}</span>    <span class="c1">// Invalid Entries...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">LSU</span><span class="p">(</span><span class="n">nsaddr_t</span> <span class="n">src</span><span class="p">,</span> <span class="n">nsaddr_t</span> <span class="n">dest</span><span class="p">,</span> <span class="kt">int</span> <span class="n">isUp</span><span class="p">)</span> <span class="o">:</span> <span class="n">src_</span><span class="p">(</span><span class="n">src</span><span class="p">),</span> <span class="n">dest_</span><span class="p">(</span><span class="n">dest</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="n">isUp_</span><span class="p">(</span><span class="n">isUp</span><span class="p">)</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><hr>
<h5 id="511-zrp的包头类的内部方法">5.1.1 ZRP的包头类的内部方法</h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* A supporting function used in finding the ZRP header in a packet. */</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">hdr_zrp</span><span class="o">::</span><span class="n">offset_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="k">class</span> <span class="nc">ZRPHeaderClass</span> <span class="o">:</span> <span class="k">public</span> <span class="n">PacketHeaderClass</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">  	<span class="n">ZRPHeaderClass</span><span class="p">()</span> <span class="o">:</span> <span class="n">PacketHeaderClass</span><span class="p">(</span><span class="s">&#34;PacketHeader/ZRP&#34;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hdr_zrp</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          	<span class="n">bind_offset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdr_zrp</span><span class="o">::</span><span class="n">offset_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="kt">void</span> <span class="nf">export_offsets</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">field_offset</span><span class="p">(</span><span class="s">&#34;zrptype_&#34;</span><span class="p">,</span> <span class="n">OFFSET</span><span class="p">(</span><span class="n">hdr_zrp</span><span class="p">,</span> <span class="n">zrptype_</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">		<span class="n">field_offset</span><span class="p">(</span><span class="s">&#34;src_&#34;</span><span class="p">,</span> <span class="n">OFFSET</span><span class="p">(</span><span class="n">hdr_zrp</span><span class="p">,</span> <span class="n">src_</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">		<span class="n">field_offset</span><span class="p">(</span><span class="s">&#34;dest_&#34;</span><span class="p">,</span> <span class="n">OFFSET</span><span class="p">(</span><span class="n">hdr_zrp</span><span class="p">,</span> <span class="n">dest_</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">		<span class="n">field_offset</span><span class="p">(</span><span class="s">&#34;seq_&#34;</span><span class="p">,</span> <span class="n">OFFSET</span><span class="p">(</span><span class="n">hdr_zrp</span><span class="p">,</span> <span class="n">seq_</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">		<span class="n">field_offset</span><span class="p">(</span><span class="s">&#34;queryID_&#34;</span><span class="p">,</span> <span class="n">OFFSET</span><span class="p">(</span><span class="n">hdr_zrp</span><span class="p">,</span> <span class="n">queryID_</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">		<span class="n">field_offset</span><span class="p">(</span><span class="s">&#34;lastbc_&#34;</span><span class="p">,</span> <span class="n">OFFSET</span><span class="p">(</span><span class="n">hdr_zrp</span><span class="p">,</span> <span class="n">lastbc_</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span><span class="n">class_zrp_hdr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* A binding between ZRP and TCL, you will most likely not change this. */</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="k">class</span> <span class="nc">ZRPClass</span> <span class="o">:</span> <span class="k">public</span> <span class="n">TclClass</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	<span class="n">ZRPClass</span><span class="p">()</span> <span class="o">:</span> <span class="n">TclClass</span><span class="p">(</span><span class="s">&#34;Agent/ZRP&#34;</span><span class="p">)</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">	<span class="n">TclObject</span><span class="o">*</span> <span class="nf">create</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span><span class="k">const</span><span class="o">*</span> <span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span><span class="p">(</span><span class="k">new</span> <span class="n">ZRPAgent</span><span class="p">((</span><span class="n">nsaddr_t</span><span class="p">)</span> <span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">4</span><span class="p">])));</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// Tcl code will attach me and then pass in addr to me
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// see tcl/lib/ns-lib.tcl, under create-zrp-agent,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// is done by &#34;set ragent [new Agent/ZRP [$node id]]&#34;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">class_zrp</span><span class="p">;</span>
</span></span></code></pre></div><h3 id="52-zrp的packetutil类">5.2 ZRP的PacketUtil类</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"> <span class="cm">/* [SUB-SECTION-5.2]------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="cm"> * PACKET UTILITIES CLASS:- PACKET RELATED UTILITIES
</span></span></span><span class="line"><span class="cl"><span class="cm"> * -----------------------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">PacketUtil</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Data...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">seq_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">ZRPAgent</span> <span class="o">*</span><span class="n">agent_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">startup_jitter_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">PacketUtil</span><span class="p">(</span><span class="n">ZRPAgent</span> <span class="o">*</span><span class="n">agent</span><span class="p">)</span> <span class="o">:</span> <span class="n">seq_</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">agent_</span><span class="p">(</span><span class="n">agent</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="n">startup_jitter_</span><span class="p">(</span><span class="n">DEFAULT_STARTUP_JITTER</span><span class="p">)</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Methods...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Packet</span><span class="o">*</span> <span class="nf">pkt_create</span><span class="p">(</span><span class="n">ZRPTYPE</span> <span class="n">zrp_type</span><span class="p">,</span> <span class="n">nsaddr_t</span> <span class="n">addressee</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ttl</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">      <span class="kt">void</span> <span class="nf">pkt_copy</span><span class="p">(</span><span class="n">Packet</span> <span class="o">*</span><span class="n">pfrom</span><span class="p">,</span> <span class="n">Packet</span> <span class="o">*</span><span class="n">pto</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">inc_seq</span><span class="p">()</span> <span class="p">{</span> <span class="n">seq_</span><span class="o">++</span><span class="p">;</span> <span class="k">if</span> <span class="p">(</span><span class="n">seq_</span> <span class="o">&gt;</span> <span class="n">MAX_SEQUENCE_ID</span><span class="p">)</span> <span class="n">seq_</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">pkt_send</span><span class="p">(</span><span class="n">Packet</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">nsaddr_t</span> <span class="n">addressee</span><span class="p">,</span> <span class="n">Time</span> <span class="n">delay</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">pkt_broadcast</span><span class="p">(</span><span class="n">Packet</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">Time</span> <span class="n">randomJitter</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">pkt_add_LSU_space</span><span class="p">(</span><span class="n">Packet</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">pkt_free_LSU_space</span><span class="p">(</span><span class="n">Packet</span> <span class="o">*</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">pkt_add_ROUTE_space</span><span class="p">(</span><span class="n">Packet</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">pkt_free_ROUTE_space</span><span class="p">(</span><span class="n">Packet</span> <span class="o">*</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">pkt_add_ADDRESS_space</span><span class="p">(</span><span class="n">Packet</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">pkt_free_ADDRESS_space</span><span class="p">(</span><span class="n">Packet</span> <span class="o">*</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="nf">pkt_AmIMultiCastReciver</span><span class="p">(</span><span class="n">Packet</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">nsaddr_t</span> <span class="n">addressToCheck</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="nf">pkt_AmIOnTheRoute</span><span class="p">(</span><span class="n">Packet</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">nsaddr_t</span> <span class="n">addressToCheck</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">pkt_print_links</span><span class="p">(</span><span class="n">Packet</span> <span class="o">*</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">pkt_print_route</span><span class="p">(</span><span class="n">Packet</span> <span class="o">*</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">pkt_drop</span><span class="p">(</span><span class="n">Packet</span> <span class="o">*</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><hr>
<h4 id="521--packetutil类的内部方法pkt_create">5.2.1  PacketUtil类的内部方法pkt_create()</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* 1. Creates a fresh new packet and initializes as much as it knows how. */</span>
</span></span><span class="line"><span class="cl"><span class="n">Packet</span><span class="o">*</span> 
</span></span><span class="line"><span class="cl"><span class="n">PacketUtil</span><span class="o">::</span><span class="n">pkt_create</span><span class="p">(</span><span class="n">ZRPTYPE</span> <span class="n">zrp_type</span><span class="p">,</span> <span class="n">nsaddr_t</span> <span class="n">addressee</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ttl</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">Time</span> <span class="n">now</span> <span class="o">=</span> <span class="n">Scheduler</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">clock</span><span class="p">();</span> <span class="c1">// get the time
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  	<span class="n">Packet</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">Myallocpkt</span><span class="p">();</span> <span class="c1">// fresh new packet
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="n">hdr_ip</span> <span class="o">*</span><span class="n">hdrip</span> <span class="o">=</span> <span class="n">HDR_IP</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  	<span class="n">hdr_cmn</span> <span class="o">*</span><span class="n">hdrc</span> <span class="o">=</span> <span class="n">HDR_CMN</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  	<span class="n">hdr_zrp</span> <span class="o">*</span><span class="n">hdrz</span> <span class="o">=</span> <span class="n">HDR_ZRP</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Common Header
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  	<span class="n">hdrc</span><span class="o">-&gt;</span><span class="n">ptype</span><span class="p">()</span> <span class="o">=</span> <span class="n">PT_ZRP</span><span class="p">;</span>   	<span class="c1">// ZRP pkt type
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  	<span class="n">hdrc</span><span class="o">-&gt;</span><span class="n">next_hop</span><span class="p">()</span> <span class="o">=</span> <span class="n">addressee</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">	<span class="n">hdrc</span><span class="o">-&gt;</span><span class="n">direction</span><span class="p">()</span> <span class="o">=</span> <span class="n">hdr_cmn</span><span class="o">::</span><span class="n">DOWN</span><span class="p">;</span>	<span class="c1">// Sending packets DOWN
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  	<span class="n">hdrc</span><span class="o">-&gt;</span><span class="n">addr_type_</span> <span class="o">=</span> <span class="n">NS_AF_NONE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  	<span class="n">hdrc</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">()</span> <span class="o">=</span> <span class="n">IP_HDR_LEN</span><span class="p">;</span>  	<span class="c1">//  set default packet size
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// IP Header
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  	<span class="n">hdrip</span><span class="o">-&gt;</span><span class="n">ttl</span><span class="p">()</span> <span class="o">=</span> <span class="n">ttl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  	<span class="n">hdrip</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">()</span> <span class="o">=</span> <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">myaddr_</span><span class="p">;</span>       <span class="c1">// source address
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  	<span class="n">hdrip</span><span class="o">-&gt;</span><span class="n">sport</span><span class="p">()</span> <span class="o">=</span> <span class="n">ROUTER_PORT</span><span class="p">;</span>   <span class="c1">// source port
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  	<span class="n">hdrip</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">()</span> <span class="o">=</span> <span class="n">addressee</span><span class="p">;</span>     <span class="c1">// dest address
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  	<span class="n">hdrip</span><span class="o">-&gt;</span><span class="n">dport</span><span class="p">()</span> <span class="o">=</span> <span class="n">ROUTER_PORT</span><span class="p">;</span>   <span class="c1">// dest port
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// ZRP Header
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  	<span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">zrptype_</span> <span class="o">=</span> <span class="n">zrp_type</span><span class="p">;</span>      <span class="c1">// which zrp pkt am I?
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">pktsent_</span> <span class="o">=</span> <span class="n">now</span><span class="p">;</span>		<span class="c1">// Packet Sending Time
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">radius_</span> <span class="o">=</span> <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">radius_</span><span class="p">;</span><span class="c1">// Sender&#39;s Radius
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  	<span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">seq_</span> <span class="o">=</span> <span class="n">seq_</span><span class="p">;</span>              <span class="c1">// copy from gobal sequence counter
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  	<span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">forwarded_</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>           <span class="c1">// have not been forwarded before
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  	<span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">src_</span> <span class="o">=</span> <span class="n">agent_</span><span class="o">-&gt;</span><span class="n">myaddr_</span><span class="p">;</span>   <span class="c1">// I am originator, this is used by NDP/IARP
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">dest_</span> <span class="o">=</span> <span class="n">addressee</span><span class="p">;</span>	<span class="c1">// dest address
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">links_</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>		<span class="c1">// Nothing in IARP Update
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">numlinks_</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="c1">//	&#34;	&#34;	 		
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">mcLst_</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>		<span class="c1">// Addresses to Multicast
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">mcLstSize_</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="c1">// Number of addresses to Multicast
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">lastbc_</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>		<span class="c1">// &#39;-1&#39; is an invalid address 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">route_</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>		<span class="c1">// Nothing in IERP Route
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">routelength_</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="c1">// 	&#34; 	&#34;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  	<span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">routeindex_</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>          <span class="c1">// where in the route list am I sending ?
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">queryID_</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>		<span class="c1">// Invalid Query ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="n">inc_seq</span><span class="p">();</span> 			<span class="c1">// increments global sequence counter
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr>
<h4 id="522-packetutil类的内部方法pkt_copy">5.2.2 PacketUtil类的内部方法pkt_copy()</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* 2. Copy an entire packet to another. */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span>
</span></span><span class="line"><span class="cl"><span class="n">PacketUtil</span><span class="o">::</span><span class="n">pkt_copy</span><span class="p">(</span><span class="n">Packet</span> <span class="o">*</span><span class="n">pfrom</span><span class="p">,</span> <span class="n">Packet</span> <span class="o">*</span><span class="n">pto</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  	<span class="n">hdr_cmn</span> <span class="o">*</span><span class="n">hdrcfrom</span> <span class="o">=</span> <span class="n">HDR_CMN</span><span class="p">(</span><span class="n">pfrom</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  	<span class="n">hdr_ip</span> <span class="o">*</span><span class="n">hdripfrom</span> <span class="o">=</span> <span class="n">HDR_IP</span><span class="p">(</span><span class="n">pfrom</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  	<span class="n">hdr_zrp</span> <span class="o">*</span><span class="n">hdrzfrom</span> <span class="o">=</span> <span class="n">HDR_ZRP</span><span class="p">(</span><span class="n">pfrom</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  	<span class="n">hdr_cmn</span> <span class="o">*</span><span class="n">hdrcto</span> <span class="o">=</span> <span class="n">HDR_CMN</span><span class="p">(</span><span class="n">pto</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  	<span class="n">hdr_ip</span> <span class="o">*</span><span class="n">hdripto</span> <span class="o">=</span> <span class="n">HDR_IP</span><span class="p">(</span><span class="n">pto</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  	<span class="n">hdr_zrp</span> <span class="o">*</span><span class="n">hdrzto</span> <span class="o">=</span> <span class="n">HDR_ZRP</span><span class="p">(</span><span class="n">pto</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Common Header
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  	<span class="n">hdrcto</span><span class="o">-&gt;</span><span class="n">direction</span><span class="p">()</span> <span class="o">=</span> <span class="n">hdrcfrom</span><span class="o">-&gt;</span><span class="n">direction</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  	<span class="n">hdrcto</span><span class="o">-&gt;</span><span class="n">ptype</span><span class="p">()</span> <span class="o">=</span> <span class="n">hdrcfrom</span><span class="o">-&gt;</span><span class="n">ptype</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  	<span class="n">hdrcto</span><span class="o">-&gt;</span><span class="n">next_hop</span><span class="p">()</span> <span class="o">=</span> <span class="n">hdrcfrom</span><span class="o">-&gt;</span><span class="n">next_hop</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  	<span class="n">hdrcto</span><span class="o">-&gt;</span><span class="n">addr_type_</span> <span class="o">=</span> <span class="n">hdrcfrom</span><span class="o">-&gt;</span><span class="n">addr_type_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  	<span class="n">hdrcto</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">()</span> <span class="o">=</span> <span class="n">hdrcfrom</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">()</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// IP Header
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  	<span class="n">hdripto</span><span class="o">-&gt;</span><span class="n">ttl</span><span class="p">()</span> <span class="o">=</span> <span class="n">hdripfrom</span><span class="o">-&gt;</span><span class="n">ttl</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  	<span class="n">hdripto</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">()</span> <span class="o">=</span> <span class="n">hdripfrom</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  	<span class="n">hdripto</span><span class="o">-&gt;</span><span class="n">sport</span><span class="p">()</span> <span class="o">=</span> <span class="n">hdripfrom</span><span class="o">-&gt;</span><span class="n">sport</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  	<span class="n">hdripto</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">()</span> <span class="o">=</span>  <span class="n">hdripfrom</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  	<span class="n">hdripto</span><span class="o">-&gt;</span><span class="n">dport</span><span class="p">()</span> <span class="o">=</span> <span class="n">hdripfrom</span><span class="o">-&gt;</span><span class="n">dport</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ZRP Header
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  	<span class="n">hdrzto</span><span class="o">-&gt;</span><span class="n">zrptype_</span> <span class="o">=</span> <span class="n">hdrzfrom</span><span class="o">-&gt;</span><span class="n">zrptype_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  	<span class="n">hdrzto</span><span class="o">-&gt;</span><span class="n">pktsent_</span> <span class="o">=</span> <span class="n">hdrzfrom</span><span class="o">-&gt;</span><span class="n">pktsent_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  	<span class="n">hdrzto</span><span class="o">-&gt;</span><span class="n">radius_</span> <span class="o">=</span> <span class="n">hdrzfrom</span><span class="o">-&gt;</span><span class="n">radius_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  	<span class="n">hdrzto</span><span class="o">-&gt;</span><span class="n">seq_</span> <span class="o">=</span> <span class="n">hdrzfrom</span><span class="o">-&gt;</span><span class="n">seq_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  	<span class="n">hdrzto</span><span class="o">-&gt;</span><span class="n">forwarded_</span> <span class="o">=</span> <span class="n">hdrzfrom</span><span class="o">-&gt;</span><span class="n">forwarded_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  	<span class="n">hdrzto</span><span class="o">-&gt;</span><span class="n">src_</span> <span class="o">=</span> <span class="n">hdrzfrom</span><span class="o">-&gt;</span><span class="n">src_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  	<span class="n">hdrzto</span><span class="o">-&gt;</span><span class="n">dest_</span> <span class="o">=</span> <span class="n">hdrzfrom</span><span class="o">-&gt;</span><span class="n">dest_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  	<span class="n">hdrzto</span><span class="o">-&gt;</span><span class="n">numlinks_</span> <span class="o">=</span> <span class="n">hdrzfrom</span><span class="o">-&gt;</span><span class="n">numlinks_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">hdrzto</span><span class="o">-&gt;</span><span class="n">mcLstSize_</span> <span class="o">=</span> <span class="n">hdrzfrom</span><span class="o">-&gt;</span><span class="n">mcLstSize_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  	<span class="n">hdrzto</span><span class="o">-&gt;</span><span class="n">routelength_</span> <span class="o">=</span> <span class="n">hdrzfrom</span><span class="o">-&gt;</span><span class="n">routelength_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  	<span class="n">hdrzto</span><span class="o">-&gt;</span><span class="n">lastbc_</span> <span class="o">=</span> <span class="n">hdrzfrom</span><span class="o">-&gt;</span><span class="n">lastbc_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">hdrzto</span><span class="o">-&gt;</span><span class="n">queryID_</span> <span class="o">=</span> <span class="n">hdrzfrom</span><span class="o">-&gt;</span><span class="n">queryID_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">hdrzto</span><span class="o">-&gt;</span><span class="n">routeindex_</span> <span class="o">=</span> <span class="n">hdrzfrom</span><span class="o">-&gt;</span><span class="n">routeindex_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  	<span class="n">hdrzto</span><span class="o">-&gt;</span><span class="n">enc_dport_</span> <span class="o">=</span> <span class="n">hdrzfrom</span><span class="o">-&gt;</span><span class="n">enc_dport_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  	<span class="n">hdrzto</span><span class="o">-&gt;</span><span class="n">enc_daddr_</span> <span class="o">=</span> <span class="n">hdrzfrom</span><span class="o">-&gt;</span><span class="n">enc_daddr_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  	<span class="n">hdrzto</span><span class="o">-&gt;</span><span class="n">enc_ptype_</span> <span class="o">=</span> <span class="n">hdrzfrom</span><span class="o">-&gt;</span><span class="n">enc_ptype_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  	
</span></span><span class="line"><span class="cl">	<span class="c1">// Filling LSUs...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">pkt_add_LSU_space</span><span class="p">(</span><span class="n">pto</span><span class="p">,</span> <span class="n">hdrzfrom</span><span class="o">-&gt;</span><span class="n">numlinks_</span><span class="p">);</span>		<span class="c1">// If zero, No memory is allocated
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">hdrzfrom</span><span class="o">-&gt;</span><span class="n">numlinks_</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>	
</span></span><span class="line"><span class="cl">		<span class="n">hdrzto</span><span class="o">-&gt;</span><span class="n">links_</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">src_</span> <span class="o">=</span> <span class="n">hdrzfrom</span><span class="o">-&gt;</span><span class="n">links_</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">src_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">hdrzto</span><span class="o">-&gt;</span><span class="n">links_</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dest_</span> <span class="o">=</span> <span class="n">hdrzfrom</span><span class="o">-&gt;</span><span class="n">links_</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dest_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">hdrzto</span><span class="o">-&gt;</span><span class="n">links_</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">isUp_</span> <span class="o">=</span> <span class="n">hdrzfrom</span><span class="o">-&gt;</span><span class="n">links_</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">isUp_</span><span class="p">;</span>	
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// Filling Route...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">pkt_add_ROUTE_space</span><span class="p">(</span><span class="n">pto</span><span class="p">,</span> <span class="n">hdrzfrom</span><span class="o">-&gt;</span><span class="n">routelength_</span><span class="p">);</span> 	<span class="c1">// If zero, No memory is allocated
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">hdrzfrom</span><span class="o">-&gt;</span><span class="n">routelength_</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>	
</span></span><span class="line"><span class="cl">		<span class="n">hdrzto</span><span class="o">-&gt;</span><span class="n">route_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdrzfrom</span><span class="o">-&gt;</span><span class="n">route_</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// Filling Multi-Cast List
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">pkt_add_ADDRESS_space</span><span class="p">(</span><span class="n">pto</span><span class="p">,</span> <span class="n">hdrzfrom</span><span class="o">-&gt;</span><span class="n">mcLstSize_</span><span class="p">);</span>	<span class="c1">// If zero, No memory is allocated
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">hdrzfrom</span><span class="o">-&gt;</span><span class="n">mcLstSize_</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">hdrzto</span><span class="o">-&gt;</span><span class="n">mcLst_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdrzfrom</span><span class="o">-&gt;</span><span class="n">mcLst_</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr>
<h4 id="523-packetutil类的内部方法pkt_send">5.2.3 PacketUtil类的内部方法pkt_send()</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* 3. Send packet, ie schedule it for sometime in future to target_ of ZRP, 
</span></span></span><span class="line"><span class="cl"><span class="cm">   which is handled by LL. This is unicast only to &#34;addressee&#34; */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> 
</span></span><span class="line"><span class="cl"><span class="n">PacketUtil</span><span class="o">::</span><span class="n">pkt_send</span><span class="p">(</span><span class="n">Packet</span><span class="o">*</span> <span class="n">p</span><span class="p">,</span> <span class="n">nsaddr_t</span> <span class="n">addressee</span><span class="p">,</span> <span class="n">Time</span> <span class="n">delay</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  	<span class="n">hdr_ip</span> <span class="o">*</span><span class="n">hdrip</span> <span class="o">=</span> <span class="n">HDR_IP</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  	<span class="n">hdr_cmn</span> <span class="o">*</span><span class="n">hdrc</span> <span class="o">=</span> <span class="n">HDR_CMN</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">hdr_zrp</span> <span class="o">*</span><span class="n">hdrz</span> <span class="o">=</span> <span class="n">HDR_ZRP</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 1. For Mac Failure
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">hdrc</span><span class="o">-&gt;</span><span class="n">xmit_failure_</span> <span class="o">=</span> <span class="n">zrp_xmit_failure_callback</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">hdrc</span><span class="o">-&gt;</span><span class="n">xmit_failure_data_</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">agent_</span><span class="p">;</span>	
</span></span><span class="line"><span class="cl">  	<span class="c1">// 2. set next hop and dest to addressee
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span><span class="p">(</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">zrptype_</span> <span class="o">==</span> <span class="n">IARP_DATA</span> <span class="o">||</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">zrptype_</span> <span class="o">==</span> <span class="n">IERP_DATA</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span><span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">myaddr_</span> <span class="o">==</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">src_</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">hdrc</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">()</span> <span class="o">+=</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">hdrc</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">()</span> <span class="o">=</span> <span class="n">IP_HDR_LEN</span> <span class="o">+</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">();</span>	<span class="c1">// Adding the header length...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">}</span>
</span></span><span class="line"><span class="cl">  	<span class="n">hdrc</span><span class="o">-&gt;</span><span class="n">next_hop</span><span class="p">()</span> <span class="o">=</span> <span class="n">addressee</span><span class="p">;</span>	<span class="c1">// UNICAST...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  	<span class="n">hdrip</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">()</span> <span class="o">=</span> <span class="n">addressee</span><span class="p">;</span>	<span class="c1">// UNICAST...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  	<span class="c1">// 3. transmit, no delay
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">agent_</span><span class="o">-&gt;</span><span class="n">XmitPacket</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">delay</span><span class="p">);</span>	<span class="c1">// No jitter
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">agent_</span><span class="o">-&gt;</span><span class="n">tx_</span><span class="o">++</span><span class="p">;</span> 			<span class="c1">// increment pkt transmitted counter
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><hr>
<h4 id="524-packetutil类的内部方法pkt_broadcast">5.2.4 PacketUtil类的内部方法pkt_broadcast()</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* 4.Broadcast packet to all neighbors. */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> 
</span></span><span class="line"><span class="cl"><span class="n">PacketUtil</span><span class="o">::</span><span class="n">pkt_broadcast</span><span class="p">(</span><span class="n">Packet</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">Time</span> <span class="n">randomJitter</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">hdr_ip</span> <span class="o">*</span><span class="n">hdrip</span> <span class="o">=</span> <span class="n">HDR_IP</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">hdr_cmn</span> <span class="o">*</span><span class="n">hdrc</span> <span class="o">=</span> <span class="n">HDR_CMN</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">hdr_zrp</span> <span class="o">*</span><span class="n">hdrz</span> <span class="o">=</span> <span class="n">HDR_ZRP</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  	<span class="c1">// 1. set next hop and dest to addressee
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span><span class="p">(</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">zrptype_</span> <span class="o">==</span> <span class="n">IARP_DATA</span> <span class="o">||</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">zrptype_</span> <span class="o">==</span> <span class="n">IERP_DATA</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span><span class="p">(</span><span class="n">agent_</span><span class="o">-&gt;</span><span class="n">myaddr_</span> <span class="o">==</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">src_</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">hdrc</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">()</span> <span class="o">+=</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">hdrc</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">()</span> <span class="o">=</span> <span class="n">IP_HDR_LEN</span> <span class="o">+</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">();</span>	<span class="c1">// Adding the header length...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">hdrc</span><span class="o">-&gt;</span><span class="n">next_hop</span><span class="p">()</span> <span class="o">=</span> <span class="n">IP_BROADCAST</span><span class="p">;</span><span class="c1">// BROADCAST...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">hdrip</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">()</span> <span class="o">=</span> <span class="n">IP_BROADCAST</span><span class="p">;</span>	<span class="c1">// BROADCAST...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  	<span class="c1">// 2. transmit, with delay
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">agent_</span><span class="o">-&gt;</span><span class="n">XmitPacket</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">randomJitter</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  	<span class="n">agent_</span><span class="o">-&gt;</span><span class="n">tx_</span><span class="o">++</span><span class="p">;</span> 			<span class="c1">// increment pkt transmitted counter
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><hr>
<h4 id="525-packetutil类的内部方法pkt_add_lsu_space">5.2.5 PacketUtil类的内部方法pkt_add_LSU_space()</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* 5. Adds Link-space in the Packet. */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> 
</span></span><span class="line"><span class="cl"><span class="n">PacketUtil</span><span class="o">::</span><span class="n">pkt_add_LSU_space</span><span class="p">(</span><span class="n">Packet</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 1. If some previous allocation is there then delete it...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  	<span class="n">hdr_zrp</span> <span class="o">*</span><span class="n">hdrz</span> <span class="o">=</span> <span class="n">HDR_ZRP</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">links_</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">delete</span> <span class="p">[]</span> <span class="p">(</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">links_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">links_</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">			
</span></span><span class="line"><span class="cl">	<span class="c1">// 2. Allocate Memory...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span><span class="p">(</span><span class="n">size</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">links_</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LSU</span><span class="p">[</span><span class="n">size</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span><span class="p">(</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">links_</span><span class="o">==</span><span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">printf</span><span class="p">(</span><span class="s">&#34;### Memory Allocation Error in [PacketUtil::pkt_add_LSU_space] ###&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr>
<h4 id="526-packetutil类的内部方法pkt_free_lsu_space">5.2.6 PacketUtil类的内部方法pkt_free_LSU_space()</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* 6. Frees Link-space in the Packet. [Not using because of memory corruption at MAC layer] */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> 
</span></span><span class="line"><span class="cl"><span class="n">PacketUtil</span><span class="o">::</span><span class="n">pkt_free_LSU_space</span><span class="p">(</span><span class="n">Packet</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="cm">/*// If some previous allocation is there then delete it...
</span></span></span><span class="line"><span class="cl"><span class="cm">  	hdr_zrp *hdrz = HDR_ZRP(p);
</span></span></span><span class="line"><span class="cl"><span class="cm">	if (hdrz-&gt;links_ != NULL) {
</span></span></span><span class="line"><span class="cl"><span class="cm">		delete [] (hdrz-&gt;links_);
</span></span></span><span class="line"><span class="cl"><span class="cm">		hdrz-&gt;links_ = NULL;
</span></span></span><span class="line"><span class="cl"><span class="cm">	}*/</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr>
<h4 id="527-packetutil类的内部方法pkt_add_route_space">5.2.7 PacketUtil类的内部方法pkt_add_ROUTE_space()</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* 7. Adds Route-space in the Packet. */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> 
</span></span><span class="line"><span class="cl"><span class="n">PacketUtil</span><span class="o">::</span><span class="n">pkt_add_ROUTE_space</span><span class="p">(</span><span class="n">Packet</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 1. If some previous allocation is there then delete it...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  	<span class="n">hdr_zrp</span> <span class="o">*</span><span class="n">hdrz</span> <span class="o">=</span> <span class="n">HDR_ZRP</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>	
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">route_</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">delete</span> <span class="p">[]</span> <span class="p">(</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">route_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">route_</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">			
</span></span><span class="line"><span class="cl">	<span class="c1">// 2. Allocate Memory...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span><span class="p">(</span><span class="n">size</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">route_</span> <span class="o">=</span> <span class="k">new</span> <span class="n">nsaddr_t</span><span class="p">[</span><span class="n">size</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span><span class="p">(</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">route_</span><span class="o">==</span><span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">printf</span><span class="p">(</span><span class="s">&#34;### Memory Allocation Error in [PacketUtil::pkt_add_ROUTE_space] ###&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr>
<h4 id="528-packetutil类的内部方法pkt_free_route_space">5.2.8 PacketUtil类的内部方法pkt_free_ROUTE_space()</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* 8. Frees Route-space in the Packet. */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> 
</span></span><span class="line"><span class="cl"><span class="n">PacketUtil</span><span class="o">::</span><span class="n">pkt_free_ROUTE_space</span><span class="p">(</span><span class="n">Packet</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="cm">/*// If some previous allocation is there then delete it...
</span></span></span><span class="line"><span class="cl"><span class="cm">  	hdr_zrp *hdrz = HDR_ZRP(p);	
</span></span></span><span class="line"><span class="cl"><span class="cm">	if (hdrz-&gt;route_ != NULL) {
</span></span></span><span class="line"><span class="cl"><span class="cm">		delete [] (hdrz-&gt;route_);
</span></span></span><span class="line"><span class="cl"><span class="cm">		hdrz-&gt;route_ = NULL;
</span></span></span><span class="line"><span class="cl"><span class="cm">	}*/</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr>
<h4 id="529-packetutil类的内部方法pkt_add_address_space">5.2.9 PacketUtil类的内部方法pkt_add_ADDRESS_space()</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* 9. Adds Multicast-Address-space in the Packet. */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> 
</span></span><span class="line"><span class="cl"><span class="n">PacketUtil</span><span class="o">::</span><span class="n">pkt_add_ADDRESS_space</span><span class="p">(</span><span class="n">Packet</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 1. If some previous allocation is there then delete it...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  	<span class="n">hdr_zrp</span> <span class="o">*</span><span class="n">hdrz</span> <span class="o">=</span> <span class="n">HDR_ZRP</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>	
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">mcLst_</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">delete</span> <span class="p">[]</span> <span class="p">(</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">mcLst_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">mcLst_</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">			
</span></span><span class="line"><span class="cl">	<span class="c1">// 2. Allocate Memory...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span><span class="p">(</span><span class="n">size</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">mcLst_</span> <span class="o">=</span> <span class="k">new</span> <span class="n">nsaddr_t</span><span class="p">[</span><span class="n">size</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span><span class="p">(</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">mcLst_</span><span class="o">==</span><span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">printf</span><span class="p">(</span><span class="s">&#34;### Memory Allocation Error in [PacketUtil::pkt_add_ADDRESS_space] ###&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr>
<h4 id="5210-packetutil类的内部方法pkt_free_address_space">5.2.10 PacketUtil类的内部方法pkt_free_ADDRESS_space()</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* 10. Frees Multicast-Address-space in the Packet. */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> 
</span></span><span class="line"><span class="cl"><span class="n">PacketUtil</span><span class="o">::</span><span class="n">pkt_free_ADDRESS_space</span><span class="p">(</span><span class="n">Packet</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="cm">/*// If some previous allocation is there then delete it...
</span></span></span><span class="line"><span class="cl"><span class="cm">  	hdr_zrp *hdrz = HDR_ZRP(p);	
</span></span></span><span class="line"><span class="cl"><span class="cm">	if (hdrz-&gt;mcLst_ != NULL) {
</span></span></span><span class="line"><span class="cl"><span class="cm">		delete [] (hdrz-&gt;mcLst_);
</span></span></span><span class="line"><span class="cl"><span class="cm">		hdrz-&gt;mcLst_ = NULL;
</span></span></span><span class="line"><span class="cl"><span class="cm">	}*/</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr>
<h4 id="5211-packetutil类的内部方法pkt_amimulticastreciver">5.2.11 PacketUtil类的内部方法pkt_AmIMultiCastReciver()</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* 11. Checks if &#39;addressToCheck&#39; is on Multicast list or not. */</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> 
</span></span><span class="line"><span class="cl"><span class="n">PacketUtil</span><span class="o">::</span><span class="n">pkt_AmIMultiCastReciver</span><span class="p">(</span><span class="n">Packet</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">nsaddr_t</span> <span class="n">addressToCheck</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">hdr_zrp</span> <span class="o">*</span><span class="n">hdrz</span> <span class="o">=</span> <span class="n">HDR_ZRP</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 1. If list is EMPTY, return FALSE.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span><span class="p">(</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">mcLstSize_</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 2. Search for the address.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">int</span> <span class="n">foundFlag</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">mcLstSize_</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span><span class="p">(</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">mcLst_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">addressToCheck</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">foundFlag</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">foundFlag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr>
<h4 id="5212-packetutil类的内部方法pkt_amiontheroute">5.2.12 PacketUtil类的内部方法pkt_AmIOnTheRoute()</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* 12. Find if the asked Address is in the route of the packet or not. */</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> 
</span></span><span class="line"><span class="cl"><span class="n">PacketUtil</span><span class="o">::</span><span class="n">pkt_AmIOnTheRoute</span><span class="p">(</span><span class="n">Packet</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">nsaddr_t</span> <span class="n">addressToCheck</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">hdr_zrp</span> <span class="o">*</span><span class="n">hdrz</span> <span class="o">=</span> <span class="n">HDR_ZRP</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">foundFlag</span><span class="o">=</span><span class="n">FALSE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">routelength_</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">routelength_</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span><span class="p">(</span><span class="n">addressToCheck</span> <span class="o">==</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">route_</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">foundFlag</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">foundFlag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr>
<h4 id="5213-packetutil类的内部方法pkt_print_links">5.2.13 PacketUtil类的内部方法pkt_print_links()</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* 13. Print all links contained in the Packet. */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> 
</span></span><span class="line"><span class="cl"><span class="n">PacketUtil</span><span class="o">::</span><span class="n">pkt_print_links</span><span class="p">(</span><span class="n">Packet</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">hdr_zrp</span> <span class="o">*</span><span class="n">hdrz</span> <span class="o">=</span> <span class="n">HDR_ZRP</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;| Packet contains Links: &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">numlinks_</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;None. |&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">numlinks_</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">links_</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">isUp_</span> <span class="o">==</span> <span class="n">LINKUP</span><span class="p">)</span> <span class="p">{</span>	<span class="c1">// UP link
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="n">printf</span><span class="p">(</span><span class="s">&#34;[%d=%d], &#34;</span><span class="p">,</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">links_</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">src_</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">links_</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dest_</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>				<span class="c1">// DOWN link
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="n">printf</span><span class="p">(</span><span class="s">&#34;[%d#%d], &#34;</span><span class="p">,</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">links_</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">src_</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">links_</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dest_</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;|&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr>
<h4 id="5214-packetutil类的内部方法pkt_print_route">5.2.14 PacketUtil类的内部方法pkt_print_route()</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* 14. Print route contained in the Packet.*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> 
</span></span><span class="line"><span class="cl"><span class="n">PacketUtil</span><span class="o">::</span><span class="n">pkt_print_route</span><span class="p">(</span><span class="n">Packet</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">hdr_zrp</span> <span class="o">*</span><span class="n">hdrz</span> <span class="o">=</span> <span class="n">HDR_ZRP</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;| Packet contains Route: [&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">routelength_</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;Empty] |&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">routelength_</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span><span class="p">(</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">routeindex_</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>	<span class="c1">// Highlighting Route_index field
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="n">printf</span><span class="p">(</span><span class="s">&#34; (%d)&#34;</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">route_</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="n">printf</span><span class="p">(</span><span class="s">&#34; %d&#34;</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">route_</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;] |&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr>
<h4 id="5215-packetutil类的内部方法pkt_drop">5.2.15 PacketUtil类的内部方法pkt_drop()</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* 15. Drop the Packet. */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> 
</span></span><span class="line"><span class="cl"><span class="n">PacketUtil</span><span class="o">::</span><span class="n">pkt_drop</span><span class="p">(</span><span class="n">Packet</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">Packet</span><span class="o">::</span><span class="n">free</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="cm">/*hdr_zrp *hdrz = HDR_ZRP(p);
</span></span></span><span class="line"><span class="cl"><span class="cm">	switch(hdrz-&gt;zrptype_) {
</span></span></span><span class="line"><span class="cl"><span class="cm">		case NDP_BEACON:
</span></span></span><span class="line"><span class="cl"><span class="cm">		case NDP_BEACON_ACK:
</span></span></span><span class="line"><span class="cl"><span class="cm">			Packet::free(p);
</span></span></span><span class="line"><span class="cl"><span class="cm">		break;	
</span></span></span><span class="line"><span class="cl"><span class="cm">	}*/</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr>
<h3 id="53-zrp的sendbuffer类">5.3 ZRP的sendBuffer类</h3>
<p>该类存储还未发送的包</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* [SUB-SECTION-5.3]------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="cm"> * SEND BUFFER:- BUFFER TO STORE UN-DELIVERED UPPER-LAYER PACKETS
</span></span></span><span class="line"><span class="cl"><span class="cm"> * -----------------------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">SendBufferEntry</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	<span class="n">Packet</span> <span class="o">*</span><span class="n">pkt_</span><span class="p">;</span>		<span class="c1">// Packet to Send from Upper-Layer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">nsaddr_t</span> <span class="n">dest_</span><span class="p">;</span> 	<span class="c1">// Address of Destination
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">Time</span> <span class="n">expiry_</span><span class="p">;</span>		<span class="c1">// Time to expire the packet
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">SendBufferEntry</span> <span class="o">*</span><span class="n">next_</span><span class="p">;</span>	<span class="c1">// Link to next entry in the list
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="n">SendBufferEntry</span><span class="p">()</span> <span class="o">:</span> <span class="n">pkt_</span><span class="p">(</span><span class="nb">NULL</span><span class="p">),</span> <span class="n">dest_</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">expiry_</span><span class="p">(</span><span class="mf">0.00</span><span class="p">),</span> <span class="n">next_</span><span class="p">(</span><span class="nb">NULL</span><span class="p">)</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">	<span class="n">SendBufferEntry</span><span class="p">(</span><span class="n">Packet</span> <span class="o">*</span><span class="n">pkt</span><span class="p">,</span> <span class="n">nsaddr_t</span> <span class="n">dest</span><span class="p">,</span> <span class="n">Time</span> <span class="n">expiry</span><span class="p">)</span> <span class="o">:</span> <span class="n">pkt_</span><span class="p">(</span><span class="n">pkt</span><span class="p">),</span> 
</span></span><span class="line"><span class="cl">		<span class="n">dest_</span><span class="p">(</span><span class="n">dest</span><span class="p">),</span> <span class="n">expiry_</span><span class="p">(</span><span class="n">expiry</span><span class="p">),</span> <span class="n">next_</span><span class="p">(</span><span class="nb">NULL</span><span class="p">)</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">SendBuffer</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	<span class="n">ZRPAgent</span> <span class="o">*</span><span class="n">agent_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">SendBufferEntry</span> <span class="o">*</span><span class="n">head_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">numPackets_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">SendBuffer</span><span class="p">(</span><span class="n">ZRPAgent</span> <span class="o">*</span><span class="n">agent</span><span class="p">)</span> <span class="o">:</span> <span class="n">agent_</span><span class="p">(</span><span class="n">agent</span><span class="p">),</span> <span class="n">head_</span><span class="p">(</span><span class="nb">NULL</span><span class="p">),</span> <span class="n">numPackets_</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Methods...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">void</span> <span class="nf">addPacket</span><span class="p">(</span><span class="n">Packet</span> <span class="o">*</span><span class="n">pkt</span><span class="p">,</span> <span class="n">nsaddr_t</span> <span class="n">dest</span><span class="p">,</span> <span class="n">Time</span> <span class="n">expiry</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">void</span> <span class="nf">purgeExpiredPackets</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="kt">void</span> <span class="nf">freeList</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><hr>
<h4 id="531-sendbuffer类内部方法addpacket">5.3.1 sendBuffer类内部方法addPacket()</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* 1. Add Packet at the head. */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> 
</span></span><span class="line"><span class="cl"><span class="n">SendBuffer</span><span class="o">::</span><span class="n">addPacket</span><span class="p">(</span><span class="n">Packet</span> <span class="o">*</span><span class="n">pkt</span><span class="p">,</span> <span class="n">nsaddr_t</span> <span class="n">dest</span><span class="p">,</span> <span class="n">Time</span> <span class="n">expiry</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">SendBufferEntry</span> <span class="o">*</span><span class="n">newPkt</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SendBufferEntry</span><span class="p">(</span><span class="n">pkt</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">expiry</span><span class="p">);</span> <span class="c1">// Create a new Entry
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span><span class="p">(</span><span class="n">newPkt</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>	<span class="c1">// Check for Allocation Error
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;### Memory Allocation Error in [SendBuffer::addPacket] ###&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">newPkt</span><span class="o">-&gt;</span><span class="n">next_</span> <span class="o">=</span> <span class="n">head_</span><span class="p">;</span>	<span class="c1">// Made necessary Joinings			
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">head_</span> <span class="o">=</span> <span class="n">newPkt</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">numPackets_</span><span class="o">++</span><span class="p">;</span>		<span class="c1">// Increment Number of Packets
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><hr>
<h4 id="532-sendbuffer类内部方法purgeexpiredpackets">5.3.2 sendBuffer类内部方法purgeExpiredPackets()</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* 2. Remove all Expired-Packets. */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> 
</span></span><span class="line"><span class="cl"><span class="n">SendBuffer</span><span class="o">::</span><span class="n">purgeExpiredPackets</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">numPackets_</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span><span class="p">;</span>		<span class="c1">// Nothing to do
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// [case-1]: Leaving the 1st case(head_ case)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">SendBufferEntry</span> <span class="o">*</span><span class="n">prev</span><span class="p">,</span> <span class="o">*</span><span class="n">cur</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">prev</span> <span class="o">=</span> <span class="n">head_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">cur</span> <span class="o">=</span> <span class="n">head_</span><span class="o">-&gt;</span><span class="n">next_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  	<span class="n">Time</span> <span class="n">now</span> <span class="o">=</span> <span class="n">Scheduler</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">clock</span><span class="p">();</span> 	<span class="c1">// get the time
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">cur</span><span class="o">!=</span><span class="nb">NULL</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">expiry_</span><span class="o">&lt;</span><span class="n">now</span><span class="p">)</span> <span class="p">{</span> 		<span class="c1">// Delete the Expired-Packet
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="n">prev</span><span class="o">-&gt;</span><span class="n">next_</span> <span class="o">=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">next_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">SendBufferEntry</span> <span class="o">*</span><span class="n">toBeDeleted</span> <span class="o">=</span> <span class="n">cur</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">cur</span> <span class="o">=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">next_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">assert</span><span class="p">(</span><span class="n">toBeDeleted</span><span class="o">-&gt;</span><span class="n">pkt_</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="n">agent_</span><span class="o">-&gt;</span><span class="n">Mydrop</span><span class="p">(</span><span class="n">toBeDeleted</span><span class="o">-&gt;</span><span class="n">pkt_</span><span class="p">,</span> <span class="n">DROP_RTR_QTIMEOUT</span><span class="p">);</span>	<span class="c1">// drops the packet
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="c1">//Packet::free(toBeDeleted-&gt;pkt_); // Not needed anymore
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="k">delete</span> <span class="n">toBeDeleted</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">numPackets_</span><span class="o">--</span><span class="p">;</span>		<span class="c1">// Decrement Number of Packets
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">prev</span> <span class="o">=</span> <span class="n">cur</span><span class="p">;</span>		<span class="c1">// Advance the Pointers
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="n">cur</span> <span class="o">=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">next_</span><span class="p">;</span>				
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// [case-2]: head_ case...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span><span class="p">(</span><span class="n">head_</span><span class="o">!=</span><span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span><span class="p">(</span><span class="n">head_</span><span class="o">-&gt;</span><span class="n">expiry_</span><span class="o">&lt;</span><span class="n">now</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">SendBufferEntry</span> <span class="o">*</span><span class="n">toBeDeleted</span> <span class="o">=</span> <span class="n">head_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">head_</span> <span class="o">=</span> <span class="n">head_</span><span class="o">-&gt;</span><span class="n">next_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">assert</span><span class="p">(</span><span class="n">toBeDeleted</span><span class="o">-&gt;</span><span class="n">pkt_</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="n">agent_</span><span class="o">-&gt;</span><span class="n">Mydrop</span><span class="p">(</span><span class="n">toBeDeleted</span><span class="o">-&gt;</span><span class="n">pkt_</span><span class="p">,</span> <span class="n">DROP_RTR_QTIMEOUT</span><span class="p">);</span>	<span class="c1">// drops the packet
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="c1">//Packet::free(toBeDeleted-&gt;pkt_); // Not needed anymore
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="k">delete</span> <span class="n">toBeDeleted</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">numPackets_</span><span class="o">--</span><span class="p">;</span>		<span class="c1">// Decrement Number of Packets
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr>
<h4 id="533-sendbuffer类内部方法freelist">5.3.3 sendBuffer类内部方法freeList()</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* 3. Empty the Buffer. */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> 
</span></span><span class="line"><span class="cl"><span class="n">SendBuffer</span><span class="o">::</span><span class="n">freeList</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">numPackets_</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="n">SendBufferEntry</span> <span class="o">*</span><span class="n">cur</span><span class="p">,</span> <span class="o">*</span><span class="n">toBeDeleted</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">cur</span> <span class="o">=</span> <span class="n">head_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">numPackets_</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">toBeDeleted</span> <span class="o">=</span> <span class="n">cur</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">assert</span><span class="p">(</span><span class="n">toBeDeleted</span><span class="o">-&gt;</span><span class="n">pkt_</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">Packet</span><span class="o">::</span><span class="n">free</span><span class="p">(</span><span class="n">toBeDeleted</span><span class="o">-&gt;</span><span class="n">pkt_</span><span class="p">);</span> <span class="c1">// Not needed anymore
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">cur</span> <span class="o">=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">next_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">delete</span> <span class="n">toBeDeleted</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">head_</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">numPackets_</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr>
<h3 id="54-zrpagent类">5.4 ZRPAgent类</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* [SUB-SECTION-5.4]------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="cm"> * ZRP AGENT:- ZONE ROUTING AGENT
</span></span></span><span class="line"><span class="cl"><span class="cm"> * -----------------------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">ZRPAgent</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Agent</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Tcl Related...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">char</span><span class="o">*</span>  <span class="n">myid_</span><span class="p">;</span>   	<span class="c1">// (char *)myid_ is string equiv of (int)myaddr_
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">PriQueue</span><span class="o">*</span> <span class="n">ll_queue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">Trace</span><span class="o">*</span> <span class="n">tracetarget</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">MobileNode</span><span class="o">*</span> <span class="n">node_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">NsObject</span><span class="o">*</span> <span class="n">port_dmux_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Common Data...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">nsaddr_t</span> <span class="n">myaddr_</span><span class="p">;</span>	<span class="c1">// My-own-address
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">int</span> <span class="n">radius_</span><span class="p">;</span>   		<span class="c1">// Zone-Radius
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">int</span> <span class="n">tx_</span><span class="p">;</span> 		<span class="c1">// total pkts transmitted by agent
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">int</span> <span class="n">rx_</span><span class="p">;</span> 		<span class="c1">// total pkts received by agent
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">int</span> <span class="n">queryID_</span><span class="p">;</span>		<span class="c1">// IERP query IDs
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="c1">// General Objects...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">SendBuffer</span> <span class="n">sendBuf_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">PacketUtil</span> <span class="n">pktUtil_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">NDPAgent</span> <span class="n">ndpAgt_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">IARPAgent</span> <span class="n">iarpAgt_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">IERPAgent</span> <span class="n">ierpAgt_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Constructors...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">ZRPAgent</span><span class="p">();</span> 		<span class="c1">// Default Constructor - (1)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">ZRPAgent</span><span class="p">(</span><span class="n">nsaddr_t</span> <span class="n">id</span><span class="p">);</span>	<span class="c1">// Parameterized Constructor - (2)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Methods...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// 1. General...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="kt">void</span> <span class="nf">startUp</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">		<span class="kt">int</span>  <span class="nf">command</span> <span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span><span class="k">const</span><span class="o">*</span> <span class="n">argv</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="kt">void</span> <span class="nf">recv</span><span class="p">(</span><span class="n">Packet</span> <span class="o">*</span> <span class="n">p</span><span class="p">,</span> <span class="n">Handler</span> <span class="o">*</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="kt">void</span> <span class="nf">route_pkt</span><span class="p">(</span><span class="n">Packet</span><span class="o">*</span> <span class="n">p</span><span class="p">,</span> <span class="n">nsaddr_t</span> <span class="n">dest</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="kt">void</span> <span class="nf">route_SendBuffer_pkt</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">		<span class="kt">void</span> <span class="nf">sendPacketUsingIARPRoute</span><span class="p">(</span><span class="n">Packet</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">nsaddr_t</span> <span class="n">dest</span><span class="p">,</span> <span class="n">Time</span> <span class="n">delay</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="kt">int</span>  <span class="nf">initialized</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">target_</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="kt">void</span> <span class="nf">print_tables</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// 2. Mac Failed...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="kt">void</span> <span class="nf">mac_failed</span><span class="p">(</span><span class="n">Packet</span> <span class="o">*</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">		<span class="c1">// 3. Methods for Packet Handling
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">Packet</span><span class="o">*</span> <span class="nf">Myallocpkt</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">Packet</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">allocpkt</span><span class="p">();</span> 	<span class="c1">// fresh new packet
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="k">return</span> <span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="kt">void</span> <span class="nf">Mydrop</span><span class="p">(</span><span class="n">Packet</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			 <span class="n">drop</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="kt">void</span> <span class="nf">XmitPacket</span><span class="p">(</span><span class="n">Packet</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">Time</span> <span class="n">randomJitter</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">Scheduler</span> <span class="o">&amp;</span> <span class="n">s</span> <span class="o">=</span> <span class="n">Scheduler</span><span class="o">::</span><span class="n">instance</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">		  	<span class="n">s</span><span class="p">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">target_</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">randomJitter</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><hr>
<h4 id="541-zrpagent类内方法startup">5.4.1 ZRPAgent类内方法startUp()</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* 3. Start Up Function(s). */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> 
</span></span><span class="line"><span class="cl"><span class="n">ZRPAgent</span><span class="o">::</span><span class="n">startUp</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Clear the send buffer...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">sendBuf_</span><span class="p">.</span><span class="n">freeList</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Start all Sub-Agents...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">ndpAgt_</span><span class="p">.</span><span class="n">startUp</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="n">iarpAgt_</span><span class="p">.</span><span class="n">startUp</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="n">ierpAgt_</span><span class="p">.</span><span class="n">startUp</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr>
<h4 id="542-zrpagent类内方法command">5.4.2 ZRPAgent类内方法command()</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* 4. TCL interface. */</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> 
</span></span><span class="line"><span class="cl"><span class="n">ZRPAgent</span><span class="o">::</span><span class="n">command</span> <span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span><span class="k">const</span><span class="o">*</span> <span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">Time</span> <span class="n">now</span> <span class="o">=</span> <span class="n">Scheduler</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">clock</span><span class="p">();</span> 		<span class="c1">// get the time
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// [First set: if argc == 2]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// No argument from TCL
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span> <span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&#34;start&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// Init ZRP Agent
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="n">startUp</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      			<span class="k">return</span> <span class="p">(</span><span class="n">TCL_OK</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    		<span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">strcasecmp</span> <span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&#34;ll-queue&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// who is my ll	//[There is no argv[2] here ??]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ll_queue</span> <span class="o">=</span> <span class="p">(</span><span class="n">PriQueue</span> <span class="o">*</span><span class="p">)</span> <span class="n">TclObject</span><span class="o">::</span><span class="n">lookup</span> <span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">])))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="n">fprintf</span> <span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;ZRP_Agent: ll-queue lookup &#34;</span>
</span></span><span class="line"><span class="cl">		 		<span class="s">&#34;of %s failed</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span> <span class="n">TCL_ERROR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      			<span class="p">}</span>
</span></span><span class="line"><span class="cl">      			<span class="k">return</span> <span class="n">TCL_OK</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">    		<span class="p">}</span>
</span></span><span class="line"><span class="cl">    	<span class="c1">// [Second set: if argc == 3]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>   <span class="p">{</span> <span class="c1">// One argument from TCL		// [Parameter 1 - RADIUS]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    		<span class="k">if</span> <span class="p">(</span><span class="n">strcasecmp</span> <span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&#34;radius&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>		<span class="c1">// change the radius, takes (int) num hops
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      			<span class="kt">int</span> <span class="n">temp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      			<span class="n">temp</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">      			<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// don&#39;t change radius unless input is valid value
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="n">printf</span><span class="p">(</span><span class="s">&#34;_%2d_ [%6.6f] | Radius change from %d to %d &#34;</span><span class="p">,</span><span class="n">myaddr_</span><span class="p">,</span> <span class="n">now</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		       		<span class="n">radius_</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">				<span class="n">print_tables</span><span class="p">();</span> <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">				<span class="n">radius_</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      			<span class="p">}</span>
</span></span><span class="line"><span class="cl">      			<span class="k">return</span> <span class="n">TCL_OK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    		<span class="p">}</span>							<span class="c1">// [Parameter 2 - MIN_BEACON_PERIOD]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    		<span class="k">if</span> <span class="p">(</span><span class="n">strcasecmp</span> <span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&#34;beacon_period&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>	<span class="c1">// change beacon period, takes (int) number of secs
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      			<span class="kt">int</span> <span class="n">temp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      			<span class="n">temp</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">      			<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// don&#39;t change unless input is valid value
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="n">printf</span><span class="p">(</span><span class="s">&#34;_%2d_ [%6.6f] | Beacon period change from %d to %d &#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	       			<span class="n">myaddr_</span><span class="p">,</span><span class="n">now</span><span class="p">,</span> <span class="n">ndpAgt_</span><span class="p">.</span><span class="n">BeaconTransmitTimer_</span><span class="p">.</span><span class="n">beacon_period_</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">				<span class="n">print_tables</span><span class="p">();</span> <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">				<span class="n">ndpAgt_</span><span class="p">.</span><span class="n">BeaconTransmitTimer_</span><span class="p">.</span><span class="n">beacon_period_</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      			<span class="p">}</span>
</span></span><span class="line"><span class="cl">      			<span class="k">return</span> <span class="n">TCL_OK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    		<span class="p">}</span><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">    		// change beacon period jitter, takes (int) number of secs
</span></span></span><span class="line"><span class="cl"><span class="cm">    		if (strcasecmp (argv[1], &#34;beacon_period_jitter&#34;) == 0) { 
</span></span></span><span class="line"><span class="cl"><span class="cm">      			int temp;
</span></span></span><span class="line"><span class="cl"><span class="cm">      			temp = atoi(argv[2]);
</span></span></span><span class="line"><span class="cl"><span class="cm">      			if (temp &gt; 0) { // don&#39;t change unless input is valid value
</span></span></span><span class="line"><span class="cl"><span class="cm">				printf(&#34;_%2d_ [%6.6f] | Beacon period jitter change from %d to %d &#34;,
</span></span></span><span class="line"><span class="cl"><span class="cm">	       			myaddr_,now, beacon_period_jitter_, temp);
</span></span></span><span class="line"><span class="cl"><span class="cm">				print_tables();
</span></span></span><span class="line"><span class="cl"><span class="cm">				printf(&#34;\n&#34;);
</span></span></span><span class="line"><span class="cl"><span class="cm">				beacon_period_jitter_ = temp;
</span></span></span><span class="line"><span class="cl"><span class="cm">      			}
</span></span></span><span class="line"><span class="cl"><span class="cm">      			return TCL_OK;
</span></span></span><span class="line"><span class="cl"><span class="cm">    		}
</span></span></span><span class="line"><span class="cl"><span class="cm">    		// change neighbor timeout, takes (int) number of secs    
</span></span></span><span class="line"><span class="cl"><span class="cm">    		if (strcasecmp (argv[1], &#34;neighbor_timeout&#34;) == 0) {
</span></span></span><span class="line"><span class="cl"><span class="cm">      			int temp;
</span></span></span><span class="line"><span class="cl"><span class="cm">      			temp = atoi(argv[2]);
</span></span></span><span class="line"><span class="cl"><span class="cm">      			if (temp &gt; 0) { // don&#39;t change unless input is valid value
</span></span></span><span class="line"><span class="cl"><span class="cm">				printf(&#34;_%2d_ [%6.6f] | Neighbor timeout change from %d to %d &#34;,
</span></span></span><span class="line"><span class="cl"><span class="cm">	       			myaddr_,now, neighbor_timeout_, temp);
</span></span></span><span class="line"><span class="cl"><span class="cm">				print_tables();
</span></span></span><span class="line"><span class="cl"><span class="cm">				printf(&#34;\n&#34;);
</span></span></span><span class="line"><span class="cl"><span class="cm">				neighbor_timeout_ = temp;
</span></span></span><span class="line"><span class="cl"><span class="cm">      			}
</span></span></span><span class="line"><span class="cl"><span class="cm">      			return TCL_OK;
</span></span></span><span class="line"><span class="cl"><span class="cm">    		}
</span></span></span><span class="line"><span class="cl"><span class="cm">    		// change neighbor ack timeout, takes (int) number of secs    
</span></span></span><span class="line"><span class="cl"><span class="cm">    		if (strcasecmp (argv[1], &#34;neighbor_ack_timeout&#34;) == 0) {
</span></span></span><span class="line"><span class="cl"><span class="cm">      			int temp;
</span></span></span><span class="line"><span class="cl"><span class="cm">      			temp = atoi(argv[2]);
</span></span></span><span class="line"><span class="cl"><span class="cm">      			if (temp &gt; 0) { // don&#39;t change unless input is valid value
</span></span></span><span class="line"><span class="cl"><span class="cm">				printf(&#34;_%2d_ [%6.6f] | Neighbor timeout change from %d to %d &#34;,
</span></span></span><span class="line"><span class="cl"><span class="cm">	       			myaddr_,now, neighbor_ack_timeout_, temp);
</span></span></span><span class="line"><span class="cl"><span class="cm">				print_tables();
</span></span></span><span class="line"><span class="cl"><span class="cm">				printf(&#34;\n&#34;);
</span></span></span><span class="line"><span class="cl"><span class="cm">				neighbor_ack_timeout_ = temp;
</span></span></span><span class="line"><span class="cl"><span class="cm">      			}
</span></span></span><span class="line"><span class="cl"><span class="cm">      			return TCL_OK;
</span></span></span><span class="line"><span class="cl"><span class="cm">    		}*/</span>
</span></span><span class="line"><span class="cl">    		<span class="c1">// resets myid_ to correct address
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    		<span class="k">if</span> <span class="p">(</span><span class="n">strcasecmp</span> <span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&#34;addr&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      			<span class="c1">//char str;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      			<span class="n">myaddr_</span> <span class="o">=</span> <span class="n">Address</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">str2addr</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">      			<span class="k">delete</span> <span class="n">myid_</span><span class="p">;</span> <span class="c1">// remove old string @ myid_, avoid memory leak
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      			<span class="n">myid_</span> <span class="o">=</span> <span class="n">Address</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">print_nodeaddr</span><span class="p">(</span><span class="n">myaddr_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      			<span class="k">return</span> <span class="n">TCL_OK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    		<span class="p">}</span>
</span></span><span class="line"><span class="cl">    		<span class="c1">// Error if we cannot find TclObject
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    		<span class="n">TclObject</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    		<span class="k">if</span> <span class="p">((</span><span class="n">obj</span> <span class="o">=</span> <span class="n">TclObject</span><span class="o">::</span><span class="n">lookup</span> <span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      			<span class="n">fprintf</span> <span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;%s: %s lookup of %s failed</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">	       		<span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">      			<span class="k">return</span> <span class="n">TCL_ERROR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    		<span class="p">}</span>
</span></span><span class="line"><span class="cl">    		
</span></span><span class="line"><span class="cl">		<span class="c1">// Returns pointer to a trace target 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    		<span class="k">if</span> <span class="p">(</span><span class="n">strcasecmp</span> <span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&#34;tracetarget&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>  <span class="p">{</span>
</span></span><span class="line"><span class="cl">      			<span class="n">tracetarget</span> <span class="o">=</span> <span class="p">(</span><span class="n">Trace</span> <span class="o">*</span><span class="p">)</span> <span class="n">obj</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      			<span class="k">return</span> <span class="n">TCL_OK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    		<span class="p">}</span>
</span></span><span class="line"><span class="cl">    		<span class="c1">// Returns pointer to our node
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcasecmp</span> <span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&#34;node&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      			<span class="n">node_</span> <span class="o">=</span> <span class="p">(</span><span class="n">MobileNode</span><span class="o">*</span><span class="p">)</span> <span class="n">obj</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      			<span class="k">return</span> <span class="n">TCL_OK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    		<span class="p">}</span>
</span></span><span class="line"><span class="cl">    		<span class="c1">// Returns pointer to port-demux
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcasecmp</span> <span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&#34;port-dmux&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      			<span class="n">port_dmux_</span> <span class="o">=</span> <span class="p">(</span><span class="n">NsObject</span> <span class="o">*</span><span class="p">)</span> <span class="n">obj</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="n">TCL_OK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    		<span class="p">}</span>
</span></span><span class="line"><span class="cl">  	<span class="p">}</span>  <span class="c1">// if argc == 3
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  	<span class="k">return</span> <span class="p">(</span><span class="n">Agent</span><span class="o">::</span><span class="n">command</span> <span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr>
<h4 id="543-zrpagent类内方法recv">5.4.3 ZRPAgent类内方法recv()</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* 5. Receiving Packets. */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> 
</span></span><span class="line"><span class="cl"><span class="n">ZRPAgent</span><span class="o">::</span><span class="n">recv</span><span class="p">(</span><span class="n">Packet</span> <span class="o">*</span> <span class="n">p</span><span class="p">,</span> <span class="n">Handler</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">hdr_ip</span> <span class="o">*</span><span class="n">hdrip</span> <span class="o">=</span> <span class="n">HDR_IP</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  	<span class="n">hdr_cmn</span> <span class="o">*</span><span class="n">hdrc</span> <span class="o">=</span> <span class="n">HDR_CMN</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  	<span class="n">hdr_zrp</span> <span class="o">*</span><span class="n">hdrz</span> <span class="o">=</span> <span class="n">HDR_ZRP</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  	<span class="kt">int</span> <span class="n">src</span> <span class="o">=</span> <span class="n">Address</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">get_nodeaddr</span><span class="p">(</span><span class="n">hdrip</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="n">rx_</span><span class="o">++</span><span class="p">;</span>		<span class="c1">// just received a new packet
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// [Case-1]: It&#39;s not a valid ZRP packet
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  	<span class="k">if</span> <span class="p">(</span><span class="n">hdrc</span><span class="o">-&gt;</span><span class="n">ptype</span><span class="p">()</span> <span class="o">!=</span> <span class="n">PT_ZRP</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// [SubCase-1]: A packet from above Layer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span><span class="p">(</span><span class="n">src</span> <span class="o">==</span> <span class="n">myaddr_</span> <span class="o">&amp;&amp;</span> <span class="n">hdrc</span><span class="o">-&gt;</span><span class="n">num_forwards</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">hdrc</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">()</span> <span class="o">+=</span> <span class="n">IP_HDR_LEN</span><span class="p">;</span>     <span class="c1">// Add the IP Header size
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    			<span class="n">hdrip</span><span class="o">-&gt;</span><span class="n">ttl</span><span class="p">()</span> <span class="o">=</span> <span class="n">IERP_TTL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">route_pkt</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">hdrip</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">());</span>	<span class="c1">// Route the Packet
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// [SubCase-2]: receiving a pkt I sent, prob a routing loop
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">src</span> <span class="o">==</span> <span class="n">myaddr_</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">pktUtil_</span><span class="p">.</span><span class="n">pkt_drop</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    			<span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// [SubCase-3]: forwarding a non-ZRP packet from another node
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">printf</span><span class="p">(</span><span class="s">&#34;TEMPLOG--AT(%d) I DONOT KNOW WHAT TO DO WITH THIS PACKET--</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">myaddr_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    			<span class="k">if</span><span class="p">(</span><span class="o">--</span><span class="n">hdrip</span><span class="o">-&gt;</span><span class="n">ttl</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>	<span class="c1">// Check the TTL.  If it is zero, then discard.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="n">pktUtil_</span><span class="p">.</span><span class="n">pkt_drop</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      				<span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// WHAT do I do with non-ZRP packets rcvd from another node?
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    			<span class="c1">// just route_pkt it like any other? then this else clause is superfluous
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// [Case-2]: It&#39;s a valid ZRP packet
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">hdrc</span><span class="o">-&gt;</span><span class="n">ptype</span><span class="p">()</span> <span class="o">==</span> <span class="n">PT_ZRP</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	  	<span class="c1">//[Check]: assert we&#39;re talking from network layer(rtagent) to network layer(rtagent)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	  	<span class="n">assert</span><span class="p">(</span><span class="n">hdrip</span><span class="o">-&gt;</span><span class="n">sport</span><span class="p">()</span> <span class="o">==</span> <span class="n">RT_PORT</span><span class="p">);</span> <span class="n">assert</span><span class="p">(</span><span class="n">hdrip</span><span class="o">-&gt;</span><span class="n">dport</span><span class="p">()</span> <span class="o">==</span> <span class="n">RT_PORT</span><span class="p">);</span> <span class="n">assert</span><span class="p">(</span><span class="n">hdrc</span><span class="o">-&gt;</span><span class="n">ptype</span><span class="p">()</span> <span class="o">==</span> <span class="n">PT_ZRP</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">switch</span><span class="p">(</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">zrptype_</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">case</span> <span class="nl">NDP_BEACON</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">				<span class="n">ndpAgt_</span><span class="p">.</span><span class="n">recv_NDP_BEACON</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="k">case</span> <span class="nl">NDP_BEACON_ACK</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">				<span class="n">ndpAgt_</span><span class="p">.</span><span class="n">recv_NDP_BEACON_ACK</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="k">case</span> <span class="nl">IARP_UPDATE</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">				<span class="n">iarpAgt_</span><span class="p">.</span><span class="n">recv_IARP_UPDATE</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>	
</span></span><span class="line"><span class="cl">			<span class="k">case</span> <span class="nl">IARP_DATA</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">				<span class="n">iarpAgt_</span><span class="p">.</span><span class="n">recv_IARP_DATA</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="k">case</span> <span class="nl">IERP_REQUEST</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">				<span class="k">if</span><span class="p">(</span><span class="n">ierpAgt_</span><span class="p">.</span><span class="n">brpXmitPolicy_</span> <span class="o">==</span> <span class="n">BRP_MULTICAST</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="c1">//ierpAgt_.recv_IERP_ROUTE_REQUEST_MC(p);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="n">ierpAgt_</span><span class="p">.</span><span class="n">recv_IERP_ROUTE_REQUEST_UNI</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="k">case</span> <span class="nl">IERP_REPLY</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">				<span class="n">ierpAgt_</span><span class="p">.</span><span class="n">recv_IERP_ROUTE_REPLY</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="k">case</span> <span class="nl">IERP_ROUTE_ERROR</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">				<span class="n">ierpAgt_</span><span class="p">.</span><span class="n">recv_IERP_ROUTE_ERROR</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="k">case</span> <span class="nl">IERP_DATA</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">				<span class="n">ierpAgt_</span><span class="p">.</span><span class="n">recv_IERP_DATA</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    			<span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">      				<span class="c1">// error, unknown zrptype, drop 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      				<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;Invalid ZRP type (%x)</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">zrptype_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      				<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>	
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr>
<h4 id="544-zrpagent类内方法route_pkt">5.4.4 ZRPAgent类内方法route_pkt()</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* 6. Route the Packet. */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> 
</span></span><span class="line"><span class="cl"><span class="n">ZRPAgent</span><span class="o">::</span><span class="n">route_pkt</span><span class="p">(</span><span class="n">Packet</span><span class="o">*</span> <span class="n">p</span><span class="p">,</span> <span class="n">nsaddr_t</span> <span class="n">dest</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  	<span class="n">hdr_cmn</span> <span class="o">*</span><span class="n">hdrc</span> <span class="o">=</span> <span class="n">HDR_CMN</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  	<span class="n">hdr_ip</span> <span class="o">*</span><span class="n">hdrip</span> <span class="o">=</span> <span class="n">HDR_IP</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  	<span class="n">hdr_zrp</span> <span class="o">*</span><span class="n">hdrz</span> <span class="o">=</span> <span class="n">HDR_ZRP</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// [Task-1]: Check if IARP route is Available OR not...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">InnerRoute</span> <span class="o">*</span><span class="n">handleToInnerRoute</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">foundInnerRoute</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">foundInnerRoute</span> <span class="o">=</span> <span class="n">iarpAgt_</span><span class="p">.</span><span class="n">irLst_</span><span class="p">.</span><span class="n">findRoute</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">handleToInnerRoute</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">foundInnerRoute</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>				<span class="c1">// IARP route is Available 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">sendPacketUsingIARPRoute</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="mf">0.00</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// [Task-2]: Both IARP &amp; IERP routes are not available.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">Time</span> <span class="n">now</span> <span class="o">=</span> <span class="n">Scheduler</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">clock</span><span class="p">();</span> <span class="c1">// get the time
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">SentQuery</span> <span class="o">*</span><span class="n">handleToFoundQuery</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">foundQueryFlag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// [SubTask-1]: Initiate Route-Discovery if needed.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">foundQueryFlag</span> <span class="o">=</span> <span class="n">ierpAgt_</span><span class="p">.</span><span class="n">sqLst_</span><span class="p">.</span><span class="n">findQuery</span><span class="p">(</span><span class="n">myaddr_</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">handleToFoundQuery</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">foundQueryFlag</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// If No query is generated before
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">Packet</span> <span class="o">*</span><span class="n">pnew</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">pnew</span> <span class="o">=</span> <span class="n">pktUtil_</span><span class="p">.</span><span class="n">pkt_create</span><span class="p">(</span><span class="n">IERP_REQUEST</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">IERP_TTL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">hdr_zrp</span> <span class="o">*</span><span class="n">hdrznew</span> <span class="o">=</span> <span class="n">HDR_ZRP</span><span class="p">(</span><span class="n">pnew</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">queryID_</span> <span class="o">=</span> <span class="n">queryID_</span><span class="p">;</span>	<span class="n">queryID_</span><span class="o">++</span><span class="p">;</span>	<span class="k">if</span><span class="p">(</span><span class="n">queryID_</span> <span class="o">==</span> <span class="mi">1000000</span><span class="p">)</span> <span class="p">{</span><span class="n">queryID_</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl">		<span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">routelength_</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="c1">// No route till now
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">routeindex_</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="c1">// Route_Index points to the sender(or forwarder) of a query
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">src_</span> <span class="o">=</span> <span class="n">myaddr_</span><span class="p">;</span>	
</span></span><span class="line"><span class="cl">		<span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">dest_</span> <span class="o">=</span> <span class="n">dest</span><span class="p">;</span>		<span class="c1">// dest address
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">hdrznew</span><span class="o">-&gt;</span><span class="n">lastbc_</span> <span class="o">=</span> <span class="n">myaddr_</span><span class="p">;</span>	<span class="c1">// Miss-leading but consistent with &#39;recv_IERP_ROUTE_REQUEST_XX&#39; call
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// [SubTask-2]: Add this query to Sent-Query-Cache..
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">ierpAgt_</span><span class="p">.</span><span class="n">sqLst_</span><span class="p">.</span><span class="n">addQuery</span><span class="p">(</span><span class="n">myaddr_</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">now</span><span class="o">+</span><span class="n">ierpAgt_</span><span class="p">.</span><span class="n">queryRetryTime_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// [SubTask-3]: Bordercast this query
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span><span class="p">(</span><span class="n">ierpAgt_</span><span class="p">.</span><span class="n">brpXmitPolicy_</span> <span class="o">==</span> <span class="n">BRP_MULTICAST</span><span class="p">)</span> <span class="p">{</span>	<span class="c1">// This will add entry into cache
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="c1">//ierpAgt_.recv_IERP_ROUTE_REQUEST_MC(pnew);	// And Send the ROUTE_REQUEST
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">ierpAgt_</span><span class="p">.</span><span class="n">recv_IERP_ROUTE_REQUEST_UNI</span><span class="p">(</span><span class="n">pnew</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// [SubTask-2]: Insert Packet into the Send Buffer.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span><span class="p">(</span><span class="n">sendBuf_</span><span class="p">.</span><span class="n">numPackets_</span> <span class="o">&lt;=</span> <span class="n">DEFAULT_SEND_BUFFER_SIZE</span><span class="p">)</span> <span class="p">{</span>	<span class="c1">// Checking Buffer Overflow [Drop-Tail]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">Time</span> <span class="n">now</span> <span class="o">=</span> <span class="n">Scheduler</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">clock</span><span class="p">();</span> <span class="c1">// get the time
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">sendBuf_</span><span class="p">.</span><span class="n">addPacket</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">now</span><span class="o">+</span><span class="n">DEFAULT_PACKET_LIFETIME</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	
</span></span><span class="line"><span class="cl">					<span class="k">if</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// [Log: XMIT_CBR_DATA]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>					<span class="n">Time</span> <span class="n">now</span> <span class="o">=</span> <span class="n">Scheduler</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">clock</span><span class="p">();</span> <span class="c1">// get the time
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>					<span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">_%d_ [%6.6f] | XMIT_CBR_DATA | -S %d -D %d | NO_ROUTE_and_SEND_BUF_DROP | &#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">					<span class="n">myaddr_</span><span class="p">,</span> <span class="n">now</span><span class="p">,</span> <span class="n">hdrip</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">(),</span> <span class="n">hdrip</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">					<span class="n">print_tables</span><span class="p">();</span> <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">					<span class="p">}</span> <span class="c1">// [Log: End]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>					<span class="k">if</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// [Log: DROP_CBR_DATA]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>					<span class="n">Time</span> <span class="n">now</span> <span class="o">=</span> <span class="n">Scheduler</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">clock</span><span class="p">();</span> <span class="c1">// get the time
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>					<span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">_%d_ [%6.6f] | DROP_CBR_DATA | -S %d -D %d | NO_ROUTE_and_SEND_BUF_DROP | &#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">					<span class="n">myaddr_</span><span class="p">,</span> <span class="n">now</span><span class="p">,</span> <span class="n">hdrip</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">(),</span> <span class="n">hdrip</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">					<span class="n">print_tables</span><span class="p">();</span> <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">					<span class="p">}</span> <span class="c1">// [Log: End]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">drop</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">DROP_RTR_QFULL</span><span class="p">);</span><span class="c1">// drops the packet
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">//assert(p != NULL);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">//Packet::free(p); 	// Not needed anymore
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr>
<h4 id="545-zrpagent类内方法route_sendbuffer_pkt">5.4.5 ZRPAgent类内方法route_SendBuffer_pkt()</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* 7. Send Packets from the Send_Buffer.*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> 
</span></span><span class="line"><span class="cl"><span class="n">ZRPAgent</span><span class="o">::</span><span class="n">route_SendBuffer_pkt</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 1. Scan the SendBuffer and send packets for which routes are available.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span><span class="p">(</span><span class="n">sendBuf_</span><span class="p">.</span><span class="n">numPackets_</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">SendBufferEntry</span> <span class="o">*</span><span class="n">prev</span><span class="p">,</span> <span class="o">*</span><span class="n">cur</span><span class="p">,</span> <span class="o">*</span><span class="n">toBeDeleted</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">InnerRoute</span> <span class="o">*</span><span class="n">handleToInnerRoute</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="kt">int</span> <span class="n">foundInnerRoute</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// Case-1: Non-head_ case
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">prev</span> <span class="o">=</span> <span class="n">sendBuf_</span><span class="p">.</span><span class="n">head_</span><span class="p">;</span> <span class="n">cur</span> <span class="o">=</span> <span class="n">sendBuf_</span><span class="p">.</span><span class="n">head_</span><span class="o">-&gt;</span><span class="n">next_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">cur</span><span class="o">!=</span><span class="nb">NULL</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">handleToInnerRoute</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">foundInnerRoute</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">foundInnerRoute</span> <span class="o">=</span> <span class="n">iarpAgt_</span><span class="p">.</span><span class="n">irLst_</span><span class="p">.</span><span class="n">findRoute</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">dest_</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">handleToInnerRoute</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span><span class="p">(</span><span class="n">foundInnerRoute</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>	<span class="c1">// IARP route is Available 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="n">Time</span> <span class="n">jitter</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">				<span class="n">jitter</span> <span class="o">=</span>  <span class="n">Random</span><span class="o">::</span><span class="n">uniform</span><span class="p">(</span><span class="n">DEFAULT_INTERPKT_JITTER</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">				<span class="n">sendPacketUsingIARPRoute</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">pkt_</span><span class="p">,</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">dest_</span><span class="p">,</span> <span class="n">jitter</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">				<span class="n">toBeDeleted</span> <span class="o">=</span> <span class="n">cur</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">				<span class="n">prev</span><span class="o">-&gt;</span><span class="n">next_</span> <span class="o">=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">next_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">				<span class="n">cur</span> <span class="o">=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">next_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">				<span class="k">delete</span> <span class="n">toBeDeleted</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">				<span class="n">sendBuf_</span><span class="p">.</span><span class="n">numPackets_</span><span class="o">--</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="n">prev</span> <span class="o">=</span> <span class="n">cur</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">				<span class="n">cur</span> <span class="o">=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">next_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// Case-2: head_ case
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">foundInnerRoute</span> <span class="o">=</span> <span class="n">iarpAgt_</span><span class="p">.</span><span class="n">irLst_</span><span class="p">.</span><span class="n">findRoute</span><span class="p">((</span><span class="n">sendBuf_</span><span class="p">.</span><span class="n">head_</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dest_</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">handleToInnerRoute</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span><span class="p">(</span><span class="n">foundInnerRoute</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>	<span class="c1">// IARP route is Available 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="n">Time</span> <span class="n">jitter</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">jitter</span> <span class="o">=</span>  <span class="n">Random</span><span class="o">::</span><span class="n">uniform</span><span class="p">(</span><span class="n">DEFAULT_INTERPKT_JITTER</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="n">sendPacketUsingIARPRoute</span><span class="p">((</span><span class="n">sendBuf_</span><span class="p">.</span><span class="n">head_</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pkt_</span><span class="p">,</span> <span class="p">(</span><span class="n">sendBuf_</span><span class="p">.</span><span class="n">head_</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dest_</span><span class="p">,</span> <span class="n">jitter</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="n">toBeDeleted</span> <span class="o">=</span> <span class="n">sendBuf_</span><span class="p">.</span><span class="n">head_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">sendBuf_</span><span class="p">.</span><span class="n">head_</span> <span class="o">=</span> <span class="n">sendBuf_</span><span class="p">.</span><span class="n">head_</span><span class="o">-&gt;</span><span class="n">next_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="k">delete</span> <span class="n">toBeDeleted</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">sendBuf_</span><span class="p">.</span><span class="n">numPackets_</span><span class="o">--</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr>
<h4 id="546-zrpagent类内方法sendpacketusingiarproute">5.4.6 ZRPAgent类内方法sendPacketUsingIARPRoute()</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* 8. Send Packet Using IARP route. */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> 
</span></span><span class="line"><span class="cl"><span class="n">ZRPAgent</span><span class="o">::</span><span class="n">sendPacketUsingIARPRoute</span><span class="p">(</span><span class="n">Packet</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">nsaddr_t</span> <span class="n">dest</span><span class="p">,</span> <span class="n">Time</span> <span class="n">delay</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  	<span class="n">hdr_cmn</span> <span class="o">*</span><span class="n">hdrc</span> <span class="o">=</span> <span class="n">HDR_CMN</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  	<span class="n">hdr_ip</span> <span class="o">*</span><span class="n">hdrip</span> <span class="o">=</span> <span class="n">HDR_IP</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  	<span class="n">hdr_zrp</span> <span class="o">*</span><span class="n">hdrz</span> <span class="o">=</span> <span class="n">HDR_ZRP</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// [SubTask-1]: Save upper layer info in encapsulated area
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">enc_daddr_</span> <span class="o">=</span> <span class="n">hdrip</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">enc_dport_</span> <span class="o">=</span> <span class="n">hdrip</span><span class="o">-&gt;</span><span class="n">dport</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">enc_ptype_</span> <span class="o">=</span>  <span class="n">hdrc</span><span class="o">-&gt;</span><span class="n">ptype</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// [SubTask-2]: Add the Route
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">iarpAgt_</span><span class="p">.</span><span class="n">addRouteInPacket</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">routeindex_</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>				<span class="c1">// Pointing to My address
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// [SubTask-3]: Change Packet Parameters
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">hdrc</span><span class="o">-&gt;</span><span class="n">direction</span><span class="p">()</span> <span class="o">=</span> <span class="n">hdr_cmn</span><span class="o">::</span><span class="n">DOWN</span><span class="p">;</span> 		<span class="c1">// Common Header
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">hdrc</span><span class="o">-&gt;</span><span class="n">ptype</span><span class="p">()</span> <span class="o">=</span> <span class="n">PT_ZRP</span><span class="p">;</span>				<span class="c1">// 	&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">hdrc</span><span class="o">-&gt;</span><span class="n">next_hop</span><span class="p">()</span> <span class="o">=</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">route_</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>		<span class="c1">// 	&#39;&#39;	[Next Hop]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">hdrc</span><span class="o">-&gt;</span><span class="n">addr_type_</span> <span class="o">=</span> <span class="n">NS_AF_NONE</span><span class="p">;</span>			<span class="c1">// 	&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">hdrip</span><span class="o">-&gt;</span><span class="n">ttl</span><span class="p">()</span> <span class="o">=</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">routelength_</span><span class="p">;</span>		<span class="c1">// IP Header
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">hdrip</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">()</span> <span class="o">=</span> <span class="n">myaddr_</span><span class="p">;</span>	 		<span class="c1">// 	&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">hdrip</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">()</span> <span class="o">=</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">route_</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span> 		<span class="c1">// 	&#39;&#39;	[Next Hop]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">hdrip</span><span class="o">-&gt;</span><span class="n">sport</span><span class="p">()</span> <span class="o">=</span> <span class="n">ROUTER_PORT</span><span class="p">;</span>	 		<span class="c1">// 	&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">hdrip</span><span class="o">-&gt;</span><span class="n">dport</span><span class="p">()</span> <span class="o">=</span> <span class="n">ROUTER_PORT</span><span class="p">;</span>			<span class="c1">// 	&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span><span class="p">(</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">routelength_</span> <span class="o">&lt;=</span> <span class="n">radius_</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">zrptype_</span> <span class="o">=</span> <span class="n">IARP_DATA</span><span class="p">;</span>			<span class="c1">// ZRP Header
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">zrptype_</span> <span class="o">=</span> <span class="n">IERP_DATA</span><span class="p">;</span>			<span class="c1">// ZRP Header
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">src_</span> <span class="o">=</span> <span class="n">myaddr_</span><span class="p">;</span>				<span class="c1">//	&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">dest_</span> <span class="o">=</span> <span class="n">dest</span><span class="p">;</span>				<span class="c1">//	&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">pktsent_</span> <span class="o">=</span> <span class="n">Scheduler</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">clock</span><span class="p">();</span> <span class="c1">//	&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">seq_</span> <span class="o">=</span> <span class="n">pktUtil_</span><span class="p">.</span><span class="n">seq_</span><span class="p">;</span>			<span class="c1">//	&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">pktUtil_</span><span class="p">.</span><span class="n">inc_seq</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// [SubTask-4]: Send the Packet
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">pktUtil_</span><span class="p">.</span><span class="n">pkt_send</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">hdrip</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">(),</span> <span class="mf">0.00</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">					<span class="k">if</span><span class="p">(</span><span class="n">DEBUG</span> <span class="o">&amp;&amp;</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">zrptype_</span> <span class="o">==</span> <span class="n">IARP_DATA</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// [Log: XMIT_IARP_DATA]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>					<span class="n">Time</span> <span class="n">now</span> <span class="o">=</span> <span class="n">Scheduler</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">clock</span><span class="p">();</span> <span class="c1">// get the time
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>					<span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">_%d_ [%6.6f] | XMIT_CBR_DATA | -S %d -D %d | -SEQ %d -Type IARP | &#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">					<span class="n">myaddr_</span><span class="p">,</span> <span class="n">now</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">src_</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">dest_</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">seq_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">					<span class="n">pktUtil_</span><span class="p">.</span><span class="n">pkt_print_route</span><span class="p">(</span><span class="n">p</span><span class="p">);</span> <span class="n">print_tables</span><span class="p">();</span> <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">					<span class="p">}</span> <span class="c1">// [Log: End]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>					<span class="k">if</span><span class="p">(</span><span class="n">DEBUG</span> <span class="o">&amp;&amp;</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">zrptype_</span> <span class="o">==</span> <span class="n">IARP_DATA</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// [Log: XMIT_IARP_DATA]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>					<span class="n">Time</span> <span class="n">now</span> <span class="o">=</span> <span class="n">Scheduler</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">clock</span><span class="p">();</span> <span class="c1">// get the time
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>					<span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">_%d_ [%6.6f] | XMIT_IARP_DATA | -S %d -D %d | -IS %d -ID %d | -SEQ %d | &#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">					<span class="n">myaddr_</span><span class="p">,</span> <span class="n">now</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">src_</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">dest_</span><span class="p">,</span> <span class="n">hdrip</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">(),</span> <span class="n">hdrip</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">(),</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">seq_</span><span class="p">);</span>	
</span></span><span class="line"><span class="cl">					<span class="n">pktUtil_</span><span class="p">.</span><span class="n">pkt_print_route</span><span class="p">(</span><span class="n">p</span><span class="p">);</span> <span class="n">print_tables</span><span class="p">();</span> <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">					<span class="p">}</span> <span class="c1">// [Log: End]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>					<span class="k">if</span><span class="p">(</span><span class="n">DEBUG</span> <span class="o">&amp;&amp;</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">zrptype_</span> <span class="o">==</span> <span class="n">IERP_DATA</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// [Log: XMIT_IARP_DATA]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>					<span class="n">Time</span> <span class="n">now</span> <span class="o">=</span> <span class="n">Scheduler</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">clock</span><span class="p">();</span> <span class="c1">// get the time
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>					<span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">_%d_ [%6.6f] | XMIT_CBR_DATA | -S %d -D %d | -SEQ %d -Type IERP | &#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">					<span class="n">myaddr_</span><span class="p">,</span> <span class="n">now</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">src_</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">dest_</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">seq_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">					<span class="n">pktUtil_</span><span class="p">.</span><span class="n">pkt_print_route</span><span class="p">(</span><span class="n">p</span><span class="p">);</span> <span class="n">print_tables</span><span class="p">();</span> <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">					<span class="p">}</span> <span class="c1">// [Log: End]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>					<span class="k">if</span><span class="p">(</span><span class="n">DEBUG</span> <span class="o">&amp;&amp;</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">zrptype_</span> <span class="o">==</span> <span class="n">IERP_DATA</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// [Log: XMIT_IERP_DATA]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>					<span class="n">Time</span> <span class="n">now</span> <span class="o">=</span> <span class="n">Scheduler</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">clock</span><span class="p">();</span> <span class="c1">// get the time
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>					<span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">_%d_ [%6.6f] | XMIT_IERP_DATA | -S %d -D %d | -IS %d -ID %d | -SEQ %d | &#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">					<span class="n">myaddr_</span><span class="p">,</span> <span class="n">now</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">src_</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">dest_</span><span class="p">,</span> <span class="n">hdrip</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">(),</span> <span class="n">hdrip</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">(),</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">seq_</span><span class="p">);</span>	
</span></span><span class="line"><span class="cl">					<span class="n">pktUtil_</span><span class="p">.</span><span class="n">pkt_print_route</span><span class="p">(</span><span class="n">p</span><span class="p">);</span> <span class="n">print_tables</span><span class="p">();</span> <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">					<span class="p">}</span> <span class="c1">// [Log: End]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr>
<h4 id="547-zrpagent类内方法print_tables">5.4.7 ZRPAgent类内方法print_tables()</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* 9. Printing Tables. */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> 
</span></span><span class="line"><span class="cl"><span class="n">ZRPAgent</span><span class="o">::</span><span class="n">print_tables</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">ndpAgt_</span><span class="p">.</span><span class="n">print_tables</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="n">iarpAgt_</span><span class="p">.</span><span class="n">print_tables</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="n">ierpAgt_</span><span class="p">.</span><span class="n">print_tables</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr>
<h4 id="548-zrpagent类内方法mac_failed">5.4.8 ZRPAgent类内方法mac_failed()</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/* 10. As a part of Route-Maintainance for IERP. */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> 
</span></span><span class="line"><span class="cl"><span class="n">ZRPAgent</span><span class="o">::</span><span class="n">mac_failed</span><span class="p">(</span><span class="n">Packet</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">hdr_ip</span> <span class="o">*</span><span class="n">hdrip</span> <span class="o">=</span> <span class="n">HDR_IP</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">hdr_cmn</span> <span class="o">*</span><span class="n">hdrc</span> <span class="o">=</span> <span class="n">HDR_CMN</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">hdr_zrp</span> <span class="o">*</span><span class="n">hdrz</span> <span class="o">=</span> <span class="n">HDR_ZRP</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">nexthop</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">switch</span> <span class="p">(</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">zrptype_</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="nl">IERP_DATA</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">					<span class="k">if</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// [Log: DROP_CBR_DATA]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>					<span class="n">Time</span> <span class="n">now</span> <span class="o">=</span> <span class="n">Scheduler</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">clock</span><span class="p">();</span> <span class="c1">// get the time
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>					<span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">_%d_ [%6.6f] | DROP_CBR_DATA | -S %d -D %d | MAC_FAILED -SEQ %d -Type IERP | &#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">					<span class="n">myaddr_</span><span class="p">,</span> <span class="n">now</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">src_</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">dest_</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">seq_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">					<span class="n">print_tables</span><span class="p">();</span> <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">					<span class="p">}</span> <span class="c1">// [Log: End]	
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="n">nexthop</span> <span class="o">=</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">route_</span><span class="p">[</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">routeindex_</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>	<span class="c1">// This pkt was unable to reach this NEXT HOP...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="c1">// Use the same packet and Xmit back it towards Sender
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">zrptype_</span> <span class="o">=</span> <span class="n">IERP_ROUTE_ERROR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">pktUtil_</span><span class="p">.</span><span class="n">pkt_add_LSU_space</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> 	<span class="c1">// Add the broken [ONLY one]link info...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		  	<span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">links_</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">src_</span> <span class="o">=</span> <span class="n">myaddr_</span><span class="p">;</span>		<span class="c1">// Currently this Info is not being used...	
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  			<span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">links_</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">dest_</span> <span class="o">=</span> <span class="n">nexthop</span><span class="p">;</span>	<span class="c1">// But may be worth sending.. so can be used...	
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		  	<span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">links_</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">isUp_</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="c1">// [Case-1]: Failed at source...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="k">if</span><span class="p">(</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">src_</span> <span class="o">==</span> <span class="n">myaddr_</span><span class="p">)</span> <span class="p">{</span>	
</span></span><span class="line"><span class="cl">				<span class="n">ierpAgt_</span><span class="p">.</span><span class="n">recv_IERP_ROUTE_ERROR</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="c1">// [Case-2]: Failes along the route...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="n">assert</span><span class="p">(</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">routeindex_</span><span class="o">-</span><span class="mi">1</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="n">hdrc</span><span class="o">-&gt;</span><span class="n">direction</span><span class="p">()</span> <span class="o">=</span> <span class="n">hdr_cmn</span><span class="o">::</span><span class="n">DOWN</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">hdrip</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">()</span> <span class="o">=</span> <span class="n">myaddr_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">hdrip</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">()</span> <span class="o">=</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">route_</span><span class="p">[</span><span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">routeindex_</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">			<span class="n">pktUtil_</span><span class="p">.</span><span class="n">pkt_send</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">hdrip</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">(),</span> <span class="mf">0.00</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">					<span class="k">if</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// [Log: XMIT_IERP_ERROR]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>					<span class="n">Time</span> <span class="n">now</span> <span class="o">=</span> <span class="n">Scheduler</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">clock</span><span class="p">();</span> <span class="c1">// get the time
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>					<span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">_%d_ [%6.6f] | XMIT_IERP_ERROR | -S %d -D %d | -IS %d -ID %d | -SEQ %d | &#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">					<span class="n">myaddr_</span><span class="p">,</span> <span class="n">now</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">src_</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">dest_</span><span class="p">,</span> <span class="n">hdrip</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">(),</span> <span class="n">hdrip</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">(),</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">seq_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">					<span class="n">pktUtil_</span><span class="p">.</span><span class="n">pkt_print_route</span><span class="p">(</span><span class="n">p</span><span class="p">);</span> <span class="n">print_tables</span><span class="p">();</span> <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">					<span class="p">}</span> <span class="c1">// [Log: End]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span><span class="p">(</span><span class="n">IERP_ERROR_SNOOP</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="c1">// Remove the broken link info from topology table
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="n">ierpAgt_</span><span class="p">.</span><span class="n">removeLinkStateFromBrokenRoute</span><span class="p">(</span><span class="n">myaddr_</span><span class="p">,</span> <span class="n">nexthop</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="nl">IARP_DATA</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// Currently, just logging the event, Not taking any action for this event.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>					<span class="k">if</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// [Log: DROP_CBR_DATA]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>					<span class="n">Time</span> <span class="n">now</span> <span class="o">=</span> <span class="n">Scheduler</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">clock</span><span class="p">();</span> <span class="c1">// get the time
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>					<span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">_%d_ [%6.6f] | DROP_CBR_DATA | -S %d -D %d | -SEQ %d MAC_FAILED -Type IARP | &#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">					<span class="n">myaddr_</span><span class="p">,</span> <span class="n">now</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">src_</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">dest_</span><span class="p">,</span> <span class="n">hdrz</span><span class="o">-&gt;</span><span class="n">seq_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">					<span class="n">print_tables</span><span class="p">();</span> <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">					<span class="p">}</span> <span class="c1">// [Log: End]	
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">		<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2022-12-02</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/%E5%8C%BA%E5%9F%9F%E5%8D%8A%E5%BE%84%E5%8D%8F%E8%AE%AEzrp/index.md" target="_blank">Read Markdown</a>
                        </span></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="http://example.org/%E5%8C%BA%E5%9F%9F%E5%8D%8A%E5%BE%84%E5%8D%8F%E8%AE%AEzrp/" data-title="区域半径协议ZRP" data-via="https://twitter.com/ZXLKG" data-hashtags="ZRP"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="http://example.org/%E5%8C%BA%E5%9F%9F%E5%8D%8A%E5%BE%84%E5%8D%8F%E8%AE%AEzrp/" data-hashtag="ZRP"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Hacker News" data-sharer="hackernews" data-url="http://example.org/%E5%8C%BA%E5%9F%9F%E5%8D%8A%E5%BE%84%E5%8D%8F%E8%AE%AEzrp/" data-title="区域半径协议ZRP"><i class="fab fa-hacker-news fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Line" data-sharer="line" data-url="http://example.org/%E5%8C%BA%E5%9F%9F%E5%8D%8A%E5%BE%84%E5%8D%8F%E8%AE%AEzrp/" data-title="区域半径协议ZRP"><i data-svg-src="/lib/simple-icons/icons/line.min.svg" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/zrp/">ZRP</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/%E5%B7%AE%E5%88%86%E6%95%B0%E7%BB%84/" class="prev" rel="prev" title="差分数组"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>差分数组</a>
            <a href="/gcc/" class="next" rel="next" title="GCC基础">GCC基础<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.120.3">Hugo</a> | Theme - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden="true"></i> LoveIt</a>
                </div><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2022 - 2023</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://github.com/zxlkgf" target="_blank">Cyo</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.example.com/some.css"><script type="text/javascript" src="/lib/autocomplete/autocomplete.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/typeit/index.umd.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/auto-render.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/copy-tex.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/mhchem.min.js"></script><script type="text/javascript" src="/lib/cookieconsent/cookieconsent.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":50},"comment":{},"cookieconsent":{"content":{"dismiss":"Got it!","link":"Learn more","message":"This website uses Cookies to improve your experience."},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"data":{"id-1":"Cyo's blog","id-2":"Cyo's blog"},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","maxResultLength":10,"noResultsFound":"No results found","snippetLength":50,"type":"lunr"},"typeit":{"cursorChar":"|","cursorSpeed":1000,"data":{"id-1":["id-1"],"id-2":["id-2"]},"duration":-1,"speed":100}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
